# (PART\*) Descriptive statistics {.unnumbered}

# Projects funded by the AFD

In this document are performed and plotted the following descriptive statistics on the protected areas (PAs) funded by Agence Française de Développement (AFD) :

-   Distribution of PAs among IUCN categories, at country, region and world level

-   Distribution in terms of ecosystems

-   Distribution of PAs across countries and regions, in terms of numbers or areas

-   Temporal evolution in the number and area of PAs funded by the AFD

-   Distribution in terms of governance types

In general, PAs refer to AFD funded PAs. When all PAs reported through the world are considered (typically for comparative statistics between general PAs and AFD funded PAs), it will be stated.

Some statistics are performed for all PAs across the world, while others are done for some regions and some specific PAs. Typically some statistics are performed for non-marine PAs, i.e terrestrial or coastal ones. These categories are defined by the WDPA and are indicative. A terrestrial PA has less than 10% of its area covered by sea or ocean, a marine one more than 90% and coastal PAs are in between.

The statistics are derived from datasets stored in the SSPCloud, and saved into the SSPCloud. Thus specific functions from the aws.S3 package are used (s3read_using() and s3write_using()). These can be replaced by other R functions to read/write locally (fread() typically). The ggplot2::ggsave() function cannot be used to write directly in the SSPCloud storage. Instead, plots from ggplot2 are stored in the temporary memory, then moved to the SSPCloud storage. Working locally, ggsave() can be directly used once the plots are created.

## Initial settings

Configuring the Rmarkdown

\#`{r setup, include=FALSE, eval = FALSE} #knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file()) #`

```{r setup, include=FALSE, eval = FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

Importing the relevant packages

```{r message=FALSE, warning=FALSE, eval = FALSE}
install.packages(c("stargazer", "janitor", "questionr", "countrycode", "WDI","ggrepel"))
library(tidyverse)
library(stargazer)
library(dplyr)
library(sf)
library(ggplot2)
library(ggrepel)
library(RColorBrewer)
library(countrycode)
library(data.table)
#library(readxl)
#library(splitstackshape) 
library(janitor)
library(xtable)
library(questionr)
library(aws.s3)
library(WDI)
```

## Importing the datasets

A dataset with information for each PA funded by the AFD, a dataset of all PAs reported by the World Database on Protected Areas (WDPA), and datasets on aggregated size at country/region/world level and by year. The latter takes into account potential overlap between PAs reported in the WDPA.

```{r, eval = FALSE}
##Dataset with one line per PA
data_stat_nodupl = 
  #fread("data_tidy/BDD_PA_AFD_nofund_nodupl.csv" , encoding = "UTF-8")
  aws.s3::s3read_using(
  FUN = data.table::fread,
  encoding = "UTF-8",
  # Mettre les options de FUN ici
  object = "data_tidy/BDD_PA_AFD_nofund_nodupl.csv",
  bucket = "projet-afd-eva-ap",
  opts = list("region" = ""))

# order for iucn categories
order_iucn_en <- c("Not categorized",               
  "Not referenced",
  "Habitat or species management area", 
  "Protected landscape or seascape",   
  "Protected area with sust. use of nat. res." , 
  "Natural monument or feature",
  "National park" , 
  "Wilderness area",
  "Strict nature reserve"              
)


# Convert iucn cat with this order
data_stat_nodupl$iucn_des_en<- factor(data_stat_nodupl$iucn_des_en, levels = order_iucn_en)

#Import WDPA data
## Download and save data
# This has been done on the 04/10/2024
# data_wdpa = wdpa_fetch(x = "global", wait = TRUE, download_dir = "data_raw",
#                        page_wait = 2, verbose = TRUE)
# 
#  s3write_using(data_wdpa,
#                     sf::st_write,
#                     object = "data_raw/wdpa/wdpa_shp_global_raw.gpkg",
#                     bucket = "projet-afd-eva-ap",
#                     opts = list("region" = ""))

##Loading from the storage
data_wdpa = 
  #st_read("data_raw/wdpa/wdpa_shp_global_raw.gpkg") %>%
  s3read_using(sf::st_read,
              object = "data_raw/wdpa/wdpa_shp_global_raw.gpkg",
              bucket = "projet-afd-eva-ap",
              opts = list("region" = "")) %>%
  st_drop_geometry() %>%
  clean_names() %>%
  #Add region, sub-region and country names 
  mutate(region = countrycode(sourcevar = iso3,
                              origin = "iso3c",
                              destination = "un.region.name"),
         sub_region = countrycode(sourcevar = iso3,
                              origin = "iso3c",
                              destination = "un.regionsub.name"),
         country_en = countrycode(sourcevar = iso3,
                              origin = "iso3c",
                              destination = "un.name.en"),
         country_fr = countrycode(sourcevar = iso3,
                              origin = "iso3c",
                              destination = "un.name.fr"),
         .after = "iso3") 

##Datasets on aggregated size of PAs supported by the AFD per country/region/year and at world level, taking into account the potential spatial overlap.
###Country 
pa_area_ctry = 
  #fread("data_tidy/area/pa_area_ctry.csv", encoding = "UTF-8")
  aws.s3::s3read_using(
  FUN = data.table::fread,
  encoding = "UTF-8",
  # Mettre les options de FUN ici
  object = "data_tidy/area/pa_area_ctry.csv",
  bucket = "projet-afd-eva-ap",
  opts = list("region" = ""))
### Region
pa_area_region =
  #fread("data_tidy/area/pa_area_region.csv", encoding = "UTF-8")
  aws.s3::s3read_using(
  FUN = data.table::fread,
  encoding = "UTF-8",
  # Mettre les options de FUN ici
  object = "data_tidy/area/pa_area_region.csv",
  bucket = "projet-afd-eva-ap",
  opts = list("region" = ""))
### World
pa_area_wld = 
  #fread("data_tidy/area/pa_area_wld.csv", encoding = "UTF-8")
  aws.s3::s3read_using(
  FUN = data.table::fread,
  encoding = "UTF-8",
  # Mettre les options de FUN ici
  object = "data_tidy/area/pa_area_wld.csv",
  bucket = "projet-afd-eva-ap",
  opts = list("region" = ""))
### By year
pa_int_yr = 
  #fread("data_tidy/area/pa_area_dr.csv", encoding = "UTF-8")
  aws.s3::s3read_using(
  FUN = data.table::fread,
  encoding = "UTF-8",
  # Mettre les options de FUN ici
  object = "data_tidy/area/pa_int_yr.csv",
  bucket = "projet-afd-eva-ap",
  opts = list("region" = ""))

#To perform statistics on the distribution of PAs reported by the WDPA across countries/regions, we focus on not high-income countries.
#Precisely, we restrict to countries defined as low-income, lower middle-income, upper-middle income, minus Russia, and including Chile, Uruguay New Caledonia and Panama. Indeed the latter are potential AFD partners while Russia is not, so this country list is more relevant for comparisons between AFD supported PAs and the others.
df_ctry_stat_wdpa = WDI(country = "all", start = "1960", end = "2022", extra = TRUE, language = "en") %>%
  group_by(iso3c) %>%
  slice(1) %>%
  ungroup() %>%
  select(c("iso3c", "income")) %>%
  rename("iso3" = "iso3c",
         "wb_inc_grp" = "income") %>%
  filter((wb_inc_grp %in% c("Low income",  "Lower middle income", "Upper middle income") & iso3 != "RUS") | iso3 %in% c("CHL", "URY", "PAN", "NCL"))

lst_ctry_stat_wdpa = df_ctry_stat_wdpa$iso3
```

```{r}
#Define colors
iucn_cat_colors_en = c(
  "Not categorized" = "#B0B0B0",                  # Gris
  "Not referenced"="#C1BFB1",
  "Habitat or species management area" = "#AE642D", # Marron
  "Protected landscape or seascape" = "#80D0D0",   # Bleu
  "Protected area with sust. use of nat. res." = "#94812B", # Orange
  "Natural monument or feature"="#842E1B",
  "National park" = "#228B22", # Vert
  "Wilderness area"="#DFAF2C",
  "Strict nature reserve" = "#18391E"              
)
eco_colors_en=c("Terrestrial"="#228B22",
                "Coastal"="#8B6C42",
                "Marine"="#26C4EC","Not referenced"="#BBBBBB")

eco_colors_fr=c("Terrestre"="#228B22",
                "Côtier"="#8B6C42",
                "Marine"="#26C4EC","Non reférencé"="#BBBBBB")





```

## Performing descriptive statistics

The figures and tables are drawn and saved as follow. In a first code chunk, a dataset specific to the statistic needed is generated, then plots are built from ggplot package. Finally, a specific code chunk saves the figures and tables (thanks to xtable package) to a temporary folder and put it in the SSPCloud.

Importantly, a specific statistic performed at world and regional level for all and non-marine PAs use same naming for conciseness. See IUCN categories statistics for instance. It is then necessary to generate the relevant plots before running saving chunk, otherwise the lots won't be saved in the good folder.

### IUCN categories

The distribution of PAs across the different IUCN categories. This information is reported by the WDPA, thus PAs funded by the AFD but not reported in this database have no information on IUCN categories, and assigned to "not referenced" category. The information on IUCN category is not mandatory in the WDPA, and some PAs have no category reported ("not categorized").

#### Share of PAs by IUCN categories (world, all)

For all PAs in the world, marine and non-marine.

```{r, eval = FALSE}
#Building the relevant dataset
##For all PAs ..
data_cat_iucn = data_stat_nodupl %>%
  group_by(iucn_des_en, iucn_des_fr) %>%
  #number of PAs per IUCN category
  summarize(n_iucn = n()) %>%
  ungroup() %>%
  #Frequency of IUCN categories
  mutate(n_pa = sum(n_iucn),
         freq_iucn = round(n_iucn/n_pa*100, 2)) %>%
  arrange(desc(iucn_des_en)) %>%
  mutate(ypos_iucn = cumsum(freq_iucn) - 0.5*freq_iucn) 


##... and for referenced PAs only
data_cat_iucn_ref = data_stat_nodupl %>%
  #Remove not referenced PAs
  subset(!(iucn_des_fr %in% c("Non catégorisée", "Non référencée"))) %>%
  group_by(iucn_des_en, iucn_des_fr) %>%
  #number of PAs per IUCN category
  summarize(n_iucn = n()) %>%
  ungroup() %>%
  #Frequency of IUCN categories
  mutate(n_pa = sum(n_iucn),
         freq_iucn = round(n_iucn/n_pa*100, 2)) %>%
  arrange(freq_iucn) %>%
  mutate(ypos_iucn = cumsum(freq_iucn) - 0.5*freq_iucn) 

#Latex table
##French
tbl_cat_iucn_fr = data_cat_iucn %>%
  select(c(iucn_des_fr, n_iucn, freq_iucn))
names(tbl_cat_iucn_fr) <- c("Catégories IUCN","Nombre d'AP", "Proportion d'AP (%)")
tbl_cat_iucn_ref_fr = data_cat_iucn_ref %>%
  select(c(iucn_des_fr, n_iucn, freq_iucn))
names(tbl_cat_iucn_ref_fr) <- c("Catégories IUCN","Nombre d'AP", "Proportion d'AP (%)")
##English
tbl_cat_iucn_en = data_cat_iucn %>%
  select(c(iucn_des_en, n_iucn, freq_iucn))
names(tbl_cat_iucn_en) <- c("IUCN categories","Number of PAs", "Share of PAs (%)")
tbl_cat_iucn_ref_en = data_cat_iucn_ref %>%
  select(c(iucn_des_en, n_iucn, freq_iucn))
names(tbl_cat_iucn_ref_en) <- c("IUCN categories","Number of PAs", "Share of PAs (%)")


#Histogram including non-referenced PAs
##French
hist_cat_iucn_fr = ggplot(data_cat_iucn, 
                       aes(x = reorder(iucn_des_fr, -freq_iucn), 
                           y = freq_iucn, fill = iucn_des_fr)) %>% 
  + geom_bar(stat = "identity", width = 0.50, fill="#3182BD") %>%
  + geom_text(aes(label = round(n_iucn, 1), y = freq_iucn), 
            vjust = -0.1, color="black",
            size=3.5) %>%
  + labs(title = "Proportion d'aires protégées par catégorie IUCN",
         subtitle = paste("Echantillon :", sum(data_cat_iucn$n_iucn), "aires protégées. Nombre d'aires indiqué sur les barres."),
          x = "Catégories IUCN", 
          y = "Proportion (%)") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=9, hjust = .5, vjust = .6),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
hist_cat_iucn_fr
##English
hist_cat_iucn_en = ggplot(data_cat_iucn, 
                       aes(x = reorder(iucn_des_en, -freq_iucn), 
                           y = freq_iucn, fill = iucn_des_en)) %>% 
  + geom_bar(stat = "identity", width = 0.50, fill="#3182BD") %>%
  + geom_text(aes(label = round(n_iucn, 1), y = freq_iucn), 
            vjust = -0.1, color="black",
            size=3.5) %>%
  + labs(title = "Distribution of protected areas by IUCN categories",
         subtitle = paste("Sample :", sum(data_cat_iucn$n_iucn), "protected areas. Number of areas indicated above the bars."),
          x = "IUCN categories", 
          y = "Share (%)") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=9, hjust = .5, vjust = .6),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
hist_cat_iucn_en

#Histogram excluding non-referenced PAs
#French
hist_cat_iucn_ref_fr = ggplot(data_cat_iucn_ref, 
                       aes(x = reorder(iucn_des_fr, -freq_iucn), 
                           y = freq_iucn, fill = iucn_des_fr)) %>% 
  + geom_bar(stat = "identity", width = 0.50, fill="#3182BD") %>%
  + geom_text(aes(label = round(n_iucn, 1), y = freq_iucn), 
            vjust = -0.1, color="black",
            size=3.5) %>%
  + labs(title = "Proportion d'aires protégées par catégorie IUCN (hors AP non-répertoriées)",
         subtitle = paste("Echantillon :", sum(data_cat_iucn_ref$n_iucn), "sur", sum(data_cat_iucn$n_iucn), "aires protégées. Nombre d'aires indiqué sur les barres."),
          x = "Catégories IUCN", 
          y = "Nombre (%)") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=9, hjust = .5, vjust = .6),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
hist_cat_iucn_ref_fr
#English
hist_cat_iucn_ref_en = ggplot(data_cat_iucn_ref, 
                       aes(x = reorder(iucn_des_en, -freq_iucn), 
                           y = freq_iucn, fill = iucn_des_en)) %>% 
  + geom_bar(stat = "identity", width = 0.50, fill="#3182BD") %>%
  + geom_text(aes(label = round(n_iucn, 1), y = freq_iucn), 
            vjust = -0.1, color="black",
            size=3.5) %>%
  + labs(title = "Distribution of protected areas by IUCN categories (excluding not reported/categorized)",
         subtitle = paste("Sample :", sum(data_cat_iucn_ref$n_iucn), "out of", sum(data_cat_iucn$n_iucn), "protected areas. Number of areas indicated above the bars."),
          x = "IUCN categories", 
          y = "Share (%)") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=9, hjust = .5, vjust = .6),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
hist_cat_iucn_ref_en


#Pie chart INcluding non-referenced PAs
##French
pie_cat_iucn_fr = ggplot(data_cat_iucn, 
                      aes(x="", y= freq_iucn, fill = iucn_des_fr)) %>%
  + geom_bar(width = 1, stat = "identity", color="white") %>%
  + coord_polar("y", start=0) %>%
  + geom_label_repel(aes(x=1.2, label = paste0(round(freq_iucn, 1), "%")), 
             color = "white", 
             position = position_stack(vjust = 0.55), 
             size=2.5, show.legend = FALSE) %>%
  # + geom_label(aes(x=1.4, label = paste0(freq_iucn, "%")), 
  #              color = "white", 
  #              position = position_stack(vjust = 0.7), size=2.5, 
  #              show.legend = FALSE) %>%
  + labs(x = "", y = "",
         title = "Proportion d'aires protégées par catégorie IUCN (%)",
         subtitle = paste("Echantillon :", sum(data_cat_iucn$n_iucn), "aires protégées")) %>%
 + scale_fill_manual(name = "Categories", values = iucn_cat_colors) %>%
  + theme_void()
pie_cat_iucn_fr
##English
pie_cat_iucn_en = ggplot(data_cat_iucn, 
                      aes(x="", y= freq_iucn, fill =iucn_des_en)) %>%
  + geom_bar(width = 1, stat = "identity", color="white") %>%
  + coord_polar("y", start=0) %>%
  + geom_label_repel(aes(x=1.2, label = paste0(round(freq_iucn, 1), "%")), 
             color = "white", 
             position = position_stack(vjust = 0.55), 
             size=2.5, show.legend = FALSE) %>%
  # + geom_label(aes(x=1.4, label = paste0(freq_iucn, "%")), 
  #              color = "white", 
  #              position = position_stack(vjust = 0.7), size=2.5, 
  #              show.legend = FALSE) %>%
  + labs(x = "", y = "",
         title = "Distribution of protected areas by IUCN categories (%)",
         subtitle = paste("Sample :", sum(data_cat_iucn$n_iucn), "protected areas")) %>%
  + scale_fill_manual(name = "Categories", values = iucn_cat_colors_en) %>%
  + theme_void()
pie_cat_iucn_en



#Pie chart EXcluding non-referenced PAs
##French
pie_cat_iucn_ref_fr = ggplot(data_cat_iucn_ref, 
                      aes(x="", y= freq_iucn, fill = iucn_des_fr)) %>%
  + geom_bar(width = 1, stat = "identity", color="white") %>%
  + coord_polar("y", start=0) %>%
  + geom_label_repel(aes(x=1.2, label = paste0(round(freq_iucn, 1), "%")), 
             color = "white", 
             position = position_stack(vjust = 0.55), 
             size=2.5, show.legend = FALSE) %>%
  # + geom_label(aes(x=1.4, label = paste0(freq_iucn, "%")), 
  #              color = "white", 
  #              position = position_stack(vjust = 0.7), size=2.5, 
  #              show.legend = FALSE) %>%
  + labs(x = "", y = "",
         title = "Proportion d'aires protégées par catégorie IUCN \nhors aires non répertoriées (%)",
         subtitle = paste("Echantillon :", sum(data_cat_iucn_ref$n_iucn), "sur", sum(data_cat_iucn$n_iucn), "aires protégées")) %>%
 + scale_fill_manual(name = "Categories", values = iucn_cat_colors) %>%
  + theme_void()
pie_cat_iucn_ref_fr
##English
pie_cat_iucn_ref_en = ggplot(data_cat_iucn_ref, 
                      aes(x="", y= freq_iucn, fill = iucn_des_en)) %>%
  + geom_bar(width = 1, stat = "identity", color="white") %>%
  + coord_polar("y", start=0) %>%
  + geom_label_repel(aes(x=1.2, label = paste0(round(freq_iucn, 1), "%")), 
             color = "white", 
             position = position_stack(vjust = 0.55), 
             size=2.5, show.legend = FALSE) %>%
  # + geom_label(aes(x=1.4, label = paste0(freq_iucn, "%")), 
  #              color = "white", 
  #              position = position_stack(vjust = 0.7), size=2.5, 
  #              show.legend = FALSE) %>%
  + labs(x = "", y = "",
         title = "Distribution of protected areas by IUCN categories \nexcluding not reported/categorized (%)",
         subtitle = paste("Sample :", sum(data_cat_iucn_ref$n_iucn), "out of", sum(data_cat_iucn$n_iucn),  "protected areas")) %>%
  + scale_fill_manual(name = "Categories", values = iucn_cat_colors_en) %>%
  + theme_void()
pie_cat_iucn_ref_en
```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

ggsave(paste(tmp, "hist_cat_iucn_fr.png", sep = "/"),
       plot = hist_cat_iucn_fr,
       device = "png",
       height = 6, width = 9)

ggsave(paste(tmp, "hist_cat_iucn_en.png", sep = "/"),
       plot = hist_cat_iucn_en,
       device = "png",
       height = 6, width = 9)

ggsave(paste(tmp, "hist_cat_iucn_ref_fr.png", sep = "/"),
       plot = hist_cat_iucn_ref_fr,
       device = "png",
       height = 6, width = 9)

ggsave(paste(tmp, "hist_cat_iucn_ref_en.png", sep = "/"),
       plot = hist_cat_iucn_ref_en,
       device = "png",
       height = 6, width = 9)

ggsave(paste(tmp, "pie_cat_iucn_fr.png", sep = "/"),
       plot = pie_cat_iucn_fr,
       device = "png",
       height = 6, width = 9)

ggsave(paste(tmp, "pie_cat_iucn_en.png", sep = "/"),
       plot = pie_cat_iucn_en,
       device = "png",
       height = 6, width = 9)

ggsave(paste(tmp, "pie_cat_iucn_ref_fr.png", sep = "/"),
       plot = pie_cat_iucn_ref_fr,
       device = "png",
       height = 6, width = 9)

ggsave(paste(tmp, "pie_cat_iucn_ref_en.png", sep = "/"),
       plot = pie_cat_iucn_ref_en,
       device = "png",
       height = 6, width = 9)

print(xtable(tbl_cat_iucn_fr, type = "latex"),
      file = paste(tmp, "tbl_cat_iucn_fr.tex", sep = "/"))

print(xtable(tbl_cat_iucn_en, type = "latex"),
      file = paste(tmp, "tbl_cat_iucn_en.tex", sep = "/"))

print(xtable(tbl_cat_iucn_ref_fr, type = "latex"),
      file = paste(tmp, "tbl_cat_iucn_ref_fr.tex", sep = "/"))

print(xtable(tbl_cat_iucn_ref_en, type = "latex"),
      file = paste(tmp, "tbl_cat_iucn_ref_en.tex", sep = "/"))

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
for(f in files) 
  {
  cat("Uploading file", paste0("'", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/descriptive_stats/IUCN/world/all", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

#### Share of PAs by IUCN categories (world, no marine)

For PAs across the world, non-marine only.

```{r, eval = FALSE}

#Building the relevant dataset
##For all PAs ..
data_cat_iucn = data_stat_nodupl %>%
  #Keep only terrestrial or coastal PA (when unknown, discarded)
  filter(marine %in% c(0,1)) %>%
  group_by(iucn_des_en, iucn_des_fr) %>%
  #number of PAs per IUCN category
  summarize(n_iucn = n()) %>%
  ungroup() %>%
  #Frequency of IUCN categories
  mutate(n_pa = sum(n_iucn),
         freq_iucn = round(n_iucn/n_pa*100, 2)) %>%
  arrange(desc(iucn_des_en)) %>%
  mutate(ypos_iucn = cumsum(freq_iucn) - 0.5*freq_iucn) 


##... and for referenced PAs only
data_cat_iucn_ref = data_stat_nodupl %>%
  #Keep only terrestrial or coastal PA (when unknown, discarded)
  filter(marine %in% c(0,1)) %>%
  #Remove not referenced PAs
  subset(!(iucn_des_fr %in% c("Non catégorisée", "Non référencée"))) %>%
  group_by(iucn_des_en, iucn_des_fr) %>%
  #number of PAs per IUCN category
  summarize(n_iucn = n()) %>%
  ungroup() %>%
  #Frequency of IUCN categories
  mutate(n_pa = sum(n_iucn),
         freq_iucn = round(n_iucn/n_pa*100, 2)) %>%
  arrange(freq_iucn) %>%
  mutate(ypos_iucn = cumsum(freq_iucn) - 0.5*freq_iucn) 

#Latex table
##French
tbl_cat_iucn_fr = data_cat_iucn %>%
  select(c(iucn_des_fr, n_iucn, freq_iucn))
names(tbl_cat_iucn_fr) <- c("Catégories IUCN","Nombre d'AP", "Proportion d'AP (%)")
tbl_cat_iucn_ref_fr = data_cat_iucn_ref %>%
  select(c(iucn_des_fr, n_iucn, freq_iucn))
names(tbl_cat_iucn_ref_fr) <- c("Catégories IUCN","Nombre d'AP", "Proportion d'AP (%)")
##English
tbl_cat_iucn_en = data_cat_iucn %>%
  select(c(iucn_des_en, n_iucn, freq_iucn))
names(tbl_cat_iucn_en) <- c("IUCN categories","Number of PAs", "Share of PAs (%)")
tbl_cat_iucn_ref_en = data_cat_iucn_ref %>%
  select(c(iucn_des_en, n_iucn, freq_iucn))
names(tbl_cat_iucn_ref_en) <- c("IUCN categories","Number of PAs", "Share of PAs (%)")


#Histogram including non-referenced PAs
##French
hist_cat_iucn_fr = ggplot(data_cat_iucn, 
                       aes(x = reorder(iucn_des_fr, -freq_iucn), 
                           y = freq_iucn, fill = iucn_des_fr)) %>% 
  + geom_bar(stat = "identity", width = 0.50, fill="#3182BD") %>%
  + geom_text(aes(label = round(n_iucn, 1), y = freq_iucn), 
            vjust = -0.1, color="black",
            size=3.5) %>%
  + labs(title = "Proportion d'aires protégées non-marines par catégorie IUCN",
         subtitle = paste("Echantillon :", sum(data_cat_iucn$n_iucn), "aires protégées non-marines. Nombre d'aires indiqué sur les barres."),
          x = "Catégories IUCN", 
          y = "Proportion (%)") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=9, hjust = .5, vjust = .6),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
hist_cat_iucn_fr
##English
hist_cat_iucn_en = ggplot(data_cat_iucn, 
                       aes(x = reorder(iucn_des_en, -freq_iucn), 
                           y = freq_iucn, fill = iucn_des_en)) %>% 
  + geom_bar(stat = "identity", width = 0.50, fill="#3182BD") %>%
  + geom_text(aes(label = round(n_iucn, 1), y = freq_iucn), 
            vjust = -0.1, color="black",
            size=3.5) %>%
  + labs(title = "Distribution of non-marine protected areas by IUCN categories",
         subtitle = paste("Sample :", sum(data_cat_iucn$n_iucn), "non-marine protected areas. Number of areas indicated above the bars."),
          x = "IUCN categories", 
          y = "Share (%)") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=9, hjust = .5, vjust = .6),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
hist_cat_iucn_en

#Histogram excluding non-referenced PAs
#French
hist_cat_iucn_ref_fr = ggplot(data_cat_iucn_ref, 
                       aes(x = reorder(iucn_des_fr, -freq_iucn), 
                           y = freq_iucn, fill = iucn_des_fr)) %>% 
  + geom_bar(stat = "identity", width = 0.50, fill="#3182BD") %>%
  + geom_text(aes(label = round(n_iucn, 1), y = freq_iucn), 
            vjust = -0.1, color="black",
            size=3.5) %>%
  + labs(title = "Proportion d'aires protégées non-marines par catégorie IUCN \n(hors AP non-répertoriées)",
         subtitle = paste("Echantillon :", sum(data_cat_iucn_ref$n_iucn), "sur", sum(data_cat_iucn$n_iucn), "aires protégées non-marines. Nombre d'aires indiqué sur les barres."),
          x = "Catégories IUCN", 
          y = "Nombre (%)") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=9, hjust = .5, vjust = .6),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
hist_cat_iucn_ref_fr
#English
hist_cat_iucn_ref_en = ggplot(data_cat_iucn_ref, 
                       aes(x = reorder(iucn_des_en, -freq_iucn), 
                           y = freq_iucn, fill = iucn_des_en)) %>% 
  + geom_bar(stat = "identity", width = 0.50, fill="#3182BD") %>%
  + geom_text(aes(label = round(n_iucn, 1), y = freq_iucn), 
            vjust = -0.1, color="black",
            size=3.5) %>%
  + labs(title = "Distribution of non-marine protected areas by IUCN categories \n(excluding not reported/categorized)",
         subtitle = paste("Sample :", sum(data_cat_iucn_ref$n_iucn), "out of", sum(data_cat_iucn$n_iucn), "non-marine protected areas. Number of areas indicated above the bars."),
          x = "IUCN categories", 
          y = "Share (%)") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=9, hjust = .5, vjust = .6),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
hist_cat_iucn_ref_en


#Pie chart INcluding non-referenced PAs
##French
pie_cat_iucn_fr = ggplot(data_cat_iucn, 
                      aes(x="", y= freq_iucn, fill = iucn_des_fr)) %>%
  + geom_bar(width = 1, stat = "identity", color="white") %>%
  + coord_polar("y", start=0) %>%
  + geom_label_repel(aes(x=1.2, label = paste0(round(freq_iucn, 1), "%")), 
             color = "white", 
             position = position_stack(vjust = 0.55), 
             size=2.5, show.legend = FALSE) %>%
  # + geom_label(aes(x=1.4, label = paste0(freq_iucn, "%")), 
  #              color = "white", 
  #              position = position_stack(vjust = 0.7), size=2.5, 
  #              show.legend = FALSE) %>%
  + labs(x = "", y = "",
         title = "Proportion d'aires protégées non-marines par catégorie IUCN (%)",
         subtitle = paste("Echantillon :", sum(data_cat_iucn$n_iucn), "aires protégées non-marines")) %>%
  + scale_fill_brewer(name = "Catégories", palette = "Dark2") %>%
  + theme_void()
pie_cat_iucn_fr
##English
pie_cat_iucn_en = ggplot(data_cat_iucn, 
                      aes(x="", y= freq_iucn, fill = iucn_des_en)) %>%
  + geom_bar(width = 1, stat = "identity", color="white") %>%
  + coord_polar("y", start=0) %>%
  + geom_label_repel(aes(x=1.2, label = paste0(round(freq_iucn, 1), "%")), 
             color = "white", 
             position = position_stack(vjust = 0.55), 
             size=2.5, show.legend = FALSE) %>%
  # + geom_label(aes(x=1.4, label = paste0(freq_iucn, "%")), 
  #              color = "white", 
  #              position = position_stack(vjust = 0.7), size=2.5, 
  #              show.legend = FALSE) %>%
  + labs(x = "", y = "",
         title = "Distribution of non-marine protected areas by IUCN categories (%)",
         subtitle = paste("Sample :", sum(data_cat_iucn$n_iucn), "non-marine protected areas")) %>%
  + scale_fill_brewer(name = "Categories", palette = "Dark2") %>%
  + theme_void()
pie_cat_iucn_en



#Pie chart EXcluding non-referenced PAs
##French
pie_cat_iucn_ref_fr = ggplot(data_cat_iucn_ref, 
                      aes(x="", y= freq_iucn, fill = iucn_des_fr)) %>%
  + geom_bar(width = 1, stat = "identity", color="white") %>%
  + coord_polar("y", start=0) %>%
  + geom_label_repel(aes(x=1.2, label = paste0(round(freq_iucn, 1), "%")), 
             color = "white", 
             position = position_stack(vjust = 0.55), 
             size=2.5, show.legend = FALSE) %>%
  # + geom_label(aes(x=1.4, label = paste0(freq_iucn, "%")), 
  #              color = "white", 
  #              position = position_stack(vjust = 0.7), size=2.5, 
  #              show.legend = FALSE) %>%
  + labs(x = "", y = "",
         title = "Proportion d'aires protégées non-marines par catégorie IUCN \nhors aires non répertoriées (%)",
         subtitle = paste("Echantillon :", sum(data_cat_iucn_ref$n_iucn), "sur", sum(data_cat_iucn$n_iucn), "aires protégées non-marines")) %>%
  + scale_fill_brewer(name = "Catégories", palette = "Dark2") %>%
  + theme_void()
pie_cat_iucn_ref_fr
##English
pie_cat_iucn_ref_en = ggplot(data_cat_iucn_ref, 
                      aes(x="", y= freq_iucn, fill = iucn_des_en)) %>%
  + geom_bar(width = 1, stat = "identity", color="white") %>%
  + coord_polar("y", start=0) %>%
  + geom_label_repel(aes(x=1.2, label = paste0(round(freq_iucn, 1), "%")), 
             color = "white", 
             position = position_stack(vjust = 0.55), 
             size=2.5, show.legend = FALSE) %>%
  # + geom_label(aes(x=1.4, label = paste0(freq_iucn, "%")), 
  #              color = "white", 
  #              position = position_stack(vjust = 0.7), size=2.5, 
  #              show.legend = FALSE) %>%
  + labs(x = "", y = "",
         title = "Distribution of non-marine protected areas by IUCN categories \nexcluding not reported/categorized (%)",
         subtitle = paste("Sample :", sum(data_cat_iucn_ref$n_iucn), "out of", sum(data_cat_iucn$n_iucn),  "non-marine protected areas")) %>%
  + scale_fill_brewer(name = "Categories", palette = "Dark2") %>%
  + theme_void()
pie_cat_iucn_ref_en

```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

ggsave(paste(tmp, "hist_cat_iucn_fr.png", sep = "/"),
       plot = hist_cat_iucn_fr,
       device = "png",
       height = 6, width = 9)

ggsave(paste(tmp, "hist_cat_iucn_en.png", sep = "/"),
       plot = hist_cat_iucn_en,
       device = "png",
       height = 6, width = 9)

ggsave(paste(tmp, "hist_cat_iucn_ref_fr.png", sep = "/"),
       plot = hist_cat_iucn_ref_fr,
       device = "png",
       height = 6, width = 9)

ggsave(paste(tmp, "hist_cat_iucn_ref_en.png", sep = "/"),
       plot = hist_cat_iucn_ref_en,
       device = "png",
       height = 6, width = 9)

ggsave(paste(tmp, "pie_cat_iucn_fr.png", sep = "/"),
       plot = pie_cat_iucn_fr,
       device = "png",
       height = 6, width = 9)

ggsave(paste(tmp, "pie_cat_iucn_en.png", sep = "/"),
       plot = pie_cat_iucn_en,
       device = "png",
       height = 6, width = 9)

ggsave(paste(tmp, "pie_cat_iucn_ref_fr.png", sep = "/"),
       plot = pie_cat_iucn_ref_fr,
       device = "png",
       height = 6, width = 9)

ggsave(paste(tmp, "pie_cat_iucn_ref_en.png", sep = "/"),
       plot = pie_cat_iucn_ref_en,
       device = "png",
       height = 6, width = 9)

print(xtable(tbl_cat_iucn_fr, type = "latex"),
      file = paste(tmp, "tbl_cat_iucn_fr.tex", sep = "/"))

print(xtable(tbl_cat_iucn_en, type = "latex"),
      file = paste(tmp, "tbl_cat_iucn_en.tex", sep = "/"))

print(xtable(tbl_cat_iucn_ref_fr, type = "latex"),
      file = paste(tmp, "tbl_cat_iucn_ref_fr.tex", sep = "/"))

print(xtable(tbl_cat_iucn_ref_en, type = "latex"),
      file = paste(tmp, "tbl_cat_iucn_ref_en.tex", sep = "/"))

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
for(f in files) 
  {
  cat("Uploading file", paste0("'", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/descriptive_stats/IUCN/world/no_marine", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

#### Share of PAs by IUCN categories (region, no marine)

Pas in a specific region, non-marine only.

```{r, eval = FALSE}

#Define the region of interest (see region variable in the main dataset).
roi = "Africa"

#Building the relevant dataset
##For all PAs ..
data_cat_iucn = data_stat_nodupl %>%
  #Keep only terrestrial or coastal PA (when unknown, discarded)
  filter(marine %in% c(0,1) & region == roi) %>%
  group_by(iucn_des_en, iucn_des_fr) %>%
  #number of PAs per IUCN category
  summarize(n_iucn = n()) %>%
  ungroup() %>%
  #Frequency of IUCN categories
  mutate(n_pa = sum(n_iucn),
         freq_iucn = round(n_iucn/n_pa*100, 2)) %>%
  arrange(desc(iucn_des_en)) %>%
  mutate(ypos_iucn = cumsum(freq_iucn) - 0.5*freq_iucn) 


##... and for referenced PAs only
data_cat_iucn_ref = data_stat_nodupl %>%
  #Keep only terrestrial or coastal PA (when unknown, discarded)
  filter(marine %in% c(0,1) & region == roi) %>%
  #Remove not referenced PAs
  subset(!(iucn_des_fr %in% c("Non catégorisée", "Non référencée"))) %>%
  group_by(iucn_des_en, iucn_des_fr) %>%
  #number of PAs per IUCN category
  summarize(n_iucn = n()) %>%
  ungroup() %>%
  #Frequency of IUCN categories
  mutate(n_pa = sum(n_iucn),
         freq_iucn = round(n_iucn/n_pa*100, 2)) %>%
  arrange(freq_iucn) %>%
  mutate(ypos_iucn = cumsum(freq_iucn) - 0.5*freq_iucn) 

#Latex table
##French
tbl_cat_iucn_fr = data_cat_iucn %>%
  select(c(iucn_des_fr, n_iucn, freq_iucn))
names(tbl_cat_iucn_fr) <- c("Catégories IUCN","Nombre d'AP", "Proportion d'AP (%)")
tbl_cat_iucn_ref_fr = data_cat_iucn_ref %>%
  select(c(iucn_des_fr, n_iucn, freq_iucn))
names(tbl_cat_iucn_ref_fr) <- c("Catégories IUCN","Nombre d'AP", "Proportion d'AP (%)")
##English
tbl_cat_iucn_en = data_cat_iucn %>%
  dplyr::select(c(iucn_des_en, n_iucn, freq_iucn))
names(tbl_cat_iucn_en) <- c("IUCN categories","Number of PAs", "Share of PAs (%)")
tbl_cat_iucn_ref_en = data_cat_iucn_ref %>%
  select(c(iucn_des_en, n_iucn, freq_iucn))
names(tbl_cat_iucn_ref_en) <- c("IUCN categories","Number of PAs", "Share of PAs (%)")


#Histogram including non-referenced PAs
##French
hist_cat_iucn_fr = ggplot(data_cat_iucn, 
                       aes(x = reorder(iucn_des_fr, -freq_iucn), 
                           y = freq_iucn, fill = iucn_des_fr)) %>% 
  + geom_bar(stat = "identity", width = 0.50, fill="#3182BD") %>%
  + geom_text(aes(label = round(n_iucn, 1), y = freq_iucn), 
            vjust = -0.1, color="black",
            size=3.5) %>%
  + labs(title = paste("Proportion d'aires protégées non-marines par catégorie IUCN,", roi),
         subtitle = paste("Echantillon :", sum(data_cat_iucn$n_iucn), "aires protégées non-marines. Nombre d'aires indiqué sur les barres."),
          x = "Catégories IUCN", 
          y = "Proportion (%)") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=9, hjust = .5, vjust = .6),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
hist_cat_iucn_fr

##English
hist_cat_iucn_en = ggplot(data_cat_iucn, 
                       aes(x = reorder(iucn_des_en, -freq_iucn), 
                           y = freq_iucn, fill = iucn_des_en)) %>% 
  + geom_bar(stat = "identity", width = 0.50, fill="#3182BD") %>%
  + geom_text(aes(label = round(n_iucn, 1), y = freq_iucn), 
            vjust = -0.1, color="black",
            size=3.5) %>%
  + labs(title = paste("Distribution of non-marine protected areas by IUCN categories,", roi),
         subtitle = paste("Sample :", sum(data_cat_iucn$n_iucn), "non-marine protected areas. Number of areas indicated above the bars."),
          x = "IUCN categories", 
          y = "Share (%)") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=9, hjust = .5, vjust = .6),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
hist_cat_iucn_en

#Histogram excluding non-referenced PAs
#French
hist_cat_iucn_ref_fr = ggplot(data_cat_iucn_ref, 
                       aes(x = reorder(iucn_des_fr, -freq_iucn), 
                           y = freq_iucn, fill = iucn_des_fr)) %>% 
  + geom_bar(stat = "identity", width = 0.50, fill="#3182BD") %>%
  + geom_text(aes(label = round(n_iucn, 1), y = freq_iucn), 
            vjust = -0.1, color="black",
            size=3.5) %>%
  + labs(title = paste("Proportion d'aires protégées non-marines par catégorie IUCN,", roi, "\n(hors AP non-répertoriées)"),
         subtitle = paste("Echantillon :", sum(data_cat_iucn_ref$n_iucn), "sur", sum(data_cat_iucn$n_iucn), "aires protégées non-marines. Nombre d'aires indiqué sur les barres."),
          x = "Catégories IUCN", 
          y = "Nombre (%)") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=9, hjust = .5, vjust = .6),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
hist_cat_iucn_ref_fr
#English
hist_cat_iucn_ref_en = ggplot(data_cat_iucn_ref, 
                       aes(x = reorder(iucn_des_en, -freq_iucn), 
                           y = freq_iucn, fill = iucn_des_en)) %>% 
  + geom_bar(stat = "identity", width = 0.50, fill="#3182BD") %>%
  + geom_text(aes(label = round(n_iucn, 1), y = freq_iucn), 
            vjust = -0.1, color="black",
            size=3.5) %>%
  + labs(title = paste("Distribution of non-marine protected areas by IUCN categories,", roi, "\n(excluding not reported/categorized)"),
         subtitle = paste("Sample :", sum(data_cat_iucn_ref$n_iucn), "out of", sum(data_cat_iucn$n_iucn), "non-marine protected areas. Number of areas indicated above the bars."),
          x = "IUCN categories", 
          y = "Share (%)") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=9, hjust = .5, vjust = .6),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
hist_cat_iucn_ref_en


#Pie chart INcluding non-referenced PAs
##French
pie_cat_iucn_fr = ggplot(data_cat_iucn, 
                      aes(x="", y= freq_iucn, fill = iucn_des_fr)) %>%
  + geom_bar(width = 1, stat = "identity", color="white") %>%
  + coord_polar("y", start=0) %>%
  + geom_label_repel(aes(x=1.2, label = paste0(round(freq_iucn, 1), "%")), 
             color = "white", 
             position = position_stack(vjust = 0.55), 
             size=2.5, show.legend = FALSE) %>%
  # + geom_label(aes(x=1.4, label = paste0(freq_iucn, "%")), 
  #              color = "white", 
  #              position = position_stack(vjust = 0.7), size=2.5, 
  #              show.legend = FALSE) %>%
  + labs(x = "", y = "",
         title = paste("Proportion d'aires protégées non-marines par catégorie IUCN (%),", roi),
         subtitle = paste("Echantillon :", sum(data_cat_iucn$n_iucn), "aires protégées non-marines")) %>%
  + scale_fill_brewer(name = "Catégories", palette = "Dark2") %>%
  + theme_void()
pie_cat_iucn_fr
##English
pie_cat_iucn_en = ggplot(data_cat_iucn, 
                      aes(x="", y= freq_iucn, fill = iucn_des_en)) %>%
  + geom_bar(width = 1, stat = "identity", color="white") %>%
  + coord_polar("y", start=0) %>%
  + geom_label_repel(aes(x=1.2, label = paste0(round(freq_iucn, 1), "%")), 
             color = "white", 
             position = position_stack(vjust = 0.55), 
             size=2.5, show.legend = FALSE) %>%
  # + geom_label(aes(x=1.4, label = paste0(freq_iucn, "%")), 
  #              color = "white", 
  #              position = position_stack(vjust = 0.7), size=2.5, 
  #              show.legend = FALSE) %>%
  + labs(x = "", y = "",
         title = paste("Distribution of non-marine protected areas by IUCN categories (%),", roi),
         subtitle = paste("Sample :", sum(data_cat_iucn$n_iucn), "non-marine protected areas")) %>%
  + scale_fill_brewer(name = "Categories", palette = "Dark2") %>%
  + theme_void()
pie_cat_iucn_en



#Pie chart EXcluding non-referenced PAs
##French
pie_cat_iucn_ref_fr = ggplot(data_cat_iucn_ref, 
                      aes(x="", y= freq_iucn, fill = iucn_des_fr)) %>%
  + geom_bar(width = 1, stat = "identity", color="white") %>%
  + coord_polar("y", start=0) %>%
  + geom_label_repel(aes(x=1.2, label = paste0(round(freq_iucn, 1), "%")), 
             color = "white", 
             position = position_stack(vjust = 0.55), 
             size=2.5, show.legend = FALSE) %>%
  # + geom_label(aes(x=1.4, label = paste0(freq_iucn, "%")), 
  #              color = "white", 
  #              position = position_stack(vjust = 0.7), size=2.5, 
  #              show.legend = FALSE) %>%
  + labs(x = "", y = "",
         title = paste("Proportion d'aires protégées non-marines par catégorie IUCN,",  roi, "\nhors aires non répertoriées (%)"),
         subtitle = paste("Echantillon :", sum(data_cat_iucn_ref$n_iucn), "sur", sum(data_cat_iucn$n_iucn), "aires protégées non-marines")) %>%
  + scale_fill_brewer(name = "Catégories", palette = "Dark2") %>%
  + theme_void()
pie_cat_iucn_ref_fr
##English
pie_cat_iucn_ref_en = ggplot(data_cat_iucn_ref, 
                      aes(x="", y= freq_iucn, fill = iucn_des_en)) %>%
  + geom_bar(width = 1, stat = "identity", color="white") %>%
  + coord_polar("y", start=0) %>%
  + geom_label_repel(aes(x=1.2, label = paste0(round(freq_iucn, 1), "%")), 
             color = "white", 
             position = position_stack(vjust = 0.55), 
             size=2.5, show.legend = FALSE) %>%
  # + geom_label(aes(x=1.4, label = paste0(freq_iucn, "%")), 
  #              color = "white", 
  #              position = position_stack(vjust = 0.7), size=2.5, 
  #              show.legend = FALSE) %>%
  + labs(x = "", y = "",
         title = paste("Distribution of non-marine protected areas by IUCN categories,","in", roi, "\nexcluding not reported/categorized (%)"),
         subtitle = paste("Sample :", sum(data_cat_iucn_ref$n_iucn), "out of", sum(data_cat_iucn$n_iucn),  "non-marine protected areas")) %>%
+ scale_fill_manual(name = "Categories",
                      values = iucn_cat_colors_en ) %>%
  + theme_void()
pie_cat_iucn_ref_en

```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

ggsave(paste(tmp, "hist_cat_iucn_fr.png", sep = "/"),
       plot = hist_cat_iucn_fr,
       device = "png",
       height = 6, width = 9)

ggsave(paste(tmp, "hist_cat_iucn_en.png", sep = "/"),
       plot = hist_cat_iucn_en,
       device = "png",
       height = 6, width = 9)

ggsave(paste(tmp, "hist_cat_iucn_ref_fr.png", sep = "/"),
       plot = hist_cat_iucn_ref_fr,
       device = "png",
       height = 6, width = 9)

ggsave(paste(tmp, "hist_cat_iucn_ref_en.png", sep = "/"),
       plot = hist_cat_iucn_ref_en,
       device = "png",
       height = 6, width = 9)

ggsave(paste(tmp, "pie_cat_iucn_fr.png", sep = "/"),
       plot = pie_cat_iucn_fr,
       device = "png",
       height = 6, width = 9)

ggsave(paste(tmp, "pie_cat_iucn_en.png", sep = "/"),
       plot = pie_cat_iucn_en,
       device = "png",
       height = 6, width = 9)

ggsave(paste(tmp, "pie_cat_iucn_ref_fr.png", sep = "/"),
       plot = pie_cat_iucn_ref_fr,
       device = "png",
       height = 6, width = 9)

ggsave(paste(tmp, "pie_cat_iucn_ref_en.png", sep = "/"),
       plot = pie_cat_iucn_ref_en,
       device = "png",
       height = 3, width = 7)

print(xtable(tbl_cat_iucn_fr, type = "latex"),
      file = paste(tmp, "tbl_cat_iucn_fr.tex", sep = "/"))

print(xtable(tbl_cat_iucn_en, type = "latex"),
      file = paste(tmp, "tbl_cat_iucn_en.tex", sep = "/"))

print(xtable(tbl_cat_iucn_ref_fr, type = "latex"),
      file = paste(tmp, "tbl_cat_iucn_ref_fr.tex", sep = "/"))

print(xtable(tbl_cat_iucn_ref_en, type = "latex"),
      file = paste(tmp, "tbl_cat_iucn_ref_en.tex", sep = "/"))

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
for(f in files) 
  {
  cat("Uploading file", paste0("'", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = paste("projet-afd-eva-ap/descriptive_stats/IUCN", roi, "no_marine", sep = "/"), 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

#### IUCN categories by countries and regions (world, all)

For each country/region, the percentage of PAs in the different IUCN categories.

```{r, eval = FALSE}

#Build the distribution of IUCN categories at country level ...
data_iucn_ctry_en = table(data_stat_nodupl$iucn_des_en,
                       data_stat_nodupl$iso3) %>%
  #Create a table with all iucn categories for each country, and compute the frequencies in percent
  prop.table(2) %>%
  as.data.frame() %>%
  mutate(Freq = round(Freq, 3)*100) %>%
  pivot_wider(names_from = Var2, values_from = Freq) %>%
  rename("iucn_des_en" = "Var1")

#... and regional level
data_iucn_reg_en = table(data_stat_nodupl$iucn_des_en,
                       data_stat_nodupl$region_afd) %>%
    #Create a table with all iucn categories for each country, and compute the frequencies in percent
  prop.table(2) %>%
  as.data.frame() %>%
  mutate(Freq = round(Freq, 3)*100) %>%
  pivot_wider(names_from = Var2, values_from = Freq) %>%
  rename("iucn_des_en" = "Var1")

```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

print(xtable(data_iucn_ctry_en, type = "latex"),
      file = paste(tmp, "tbl_iucn_ctry_en.tex", sep = "/"))
print(xtable(data_iucn_reg_en, type = "latex"),
      file = paste(tmp, "tbl_iucn_reg_en.tex", sep = "/"))

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
for(f in files) 
  {
  cat("Uploading file", paste0("'", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/descriptive_stats/IUCN/world/all", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

### Ecosystems (excluding non-referenced PAs)

The percentage of PAs in the ecosystem categories of WDPA : terrestrial, coastal and marine. A terrestrial PA has less than 10% of its area covered by sea or ocean, a marine one more than 90% and coastal PAs are in between. This definition is taken from the WDPA.

#### Proportion of PAs by marine or terrestrial areas (world)

All PAs in the world.

```{r, eval = FALSE}

#Build datasets
data_eco = data_stat_nodupl %>%
  #subset non-referencded PAs (have NA ecosysteme)
  subset(is.na(marine) == FALSE) %>%
  mutate(marine = as.factor(marine))
data_eco$ecosyst_en = fct_recode(data_eco$marine, 
                              "Terrestrial"="0", 
                              "Coastal"="1", 
                              "Marine"="2")
data_eco$ecosyst_fr = fct_recode(data_eco$marine, 
                              "Terrestre"="0", 
                              "Côtier"="1", 
                              "Marin"="2")

data_eco_hist = data_eco %>%
  group_by(ecosyst_en, ecosyst_fr) %>%
  summarize(n = n(),
            freq = round(n/nrow(data_eco), 2)*100) %>%
  ungroup()

#Define tables
tbl_eco_fr = data_eco_hist %>%
  select(c(ecosyst_fr, n, freq)) %>%
  rename("Ecosystème" = "ecosyst_fr",
         "Nombre d'AP" = "n",
         "Proportion d'AP(%)" = "freq")

tbl_eco_en = data_eco_hist %>%
  select(c(ecosyst_en, n, freq)) %>%
  rename("Ecosystem" = "ecosyst_en",
         "Number of PAs" = "n",
         "Share of PAs(%)" = "freq")


#Histogram in share (in French)
hist_eco_shr_fr = ggplot(data_eco_hist, 
                     aes(x = ecosyst_fr, y = freq, fill = ecosyst_fr)) %>%
+ geom_bar(width = 0.50, fill= "#3182BD", stat="identity") %>%
+ geom_text(aes(label = round(n, 1), y = freq), 
        vjust = -0.1, color="black",
        size=3.5) %>%
+ labs(title = "Proportion d'aires protégées par type d'écosystème \n(hors AP non-référencées)",
       subtitle = paste("Echantillon :", sum(data_eco_hist$n), "sur", nrow(data_stat_nodupl), "aires protégées. Nombre d'aires indiqué sur les barres."),
         x = "Type d'écosystème",
         y = "Proportion d'aires protégées(%)") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 0,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
hist_eco_shr_fr
# 



#Histogram in share (in English)
hist_eco_shr_en = ggplot(data_eco_hist, 
                     aes(x = ecosyst_en, y = freq, fill = ecosyst_en)) %>%
+ geom_bar(width = 0.50, fill= "#3182BD", stat="identity") %>%
+ geom_text(aes(label = round(n, 1), y = freq), 
        vjust = -0.1, color="black",
        size=3.5) %>%
+ labs(title = "Proportion of protected areas by ecosystem type \n(excluding not referenced PAs)",
       subtitle = paste("Sample :", sum(data_eco_hist$n), "out of", nrow(data_stat_nodupl), "protected areas. Number of areas indicated above."),
         x = "Ecosystem type",
         y = "Proportion of protected areas(%)") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 0,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
#hist_eco_shr_en


  
#Histogram in number (in French)
hist_eco_n_fr = ggplot(data_eco_hist, 
                     aes(x = ecosyst_fr, y = n, fill = ecosyst_fr)) %>%
+ geom_bar(width = 0.50, fill= "#3182BD", stat="identity") %>%
+ labs(title = "Proportion d'aires protégées par type d'écosystème \n(hors AP non-référencées)",
       subtitle = paste("Echantillon :", sum(data_eco_hist$n), "sur", nrow(data_stat_nodupl), "aires protégées"),
         x = "Type d'écosystème",
         y = "# d'aires protégées") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 0,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
hist_eco_n_fr


#Histogram in number (in English)
hist_eco_n_en = ggplot(data_eco_hist, 
                     aes(x = ecosyst_en, y = n, fill = ecosyst_en)) %>%
+ geom_bar(width = 0.50, fill= "#3182BD", stat="identity") %>%
+ labs(title = "Proportion of protected areas by ecosystem type \n(excluding not referenced PAs)",
       subtitle = paste("Sample :", sum(data_eco_hist$n), "out of", nrow(data_stat_nodupl), "protected areas"),
         x = "Ecosystem type",
         y = "# of protected areas") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 0,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
#hist_eco_n_en

#Pie chart (in French)
pie_eco_fr = ggplot(data_eco_hist, 
                     aes(x = "", y = freq, fill = ecosyst_fr)) %>%
+ geom_bar(width = 1, stat = "identity",color="white") %>%
+ geom_label(aes(x=1.3, label = paste0(freq, "%")), 
             color = "black", position = position_stack(vjust = 0.55), 
             size=2.5, show.legend = FALSE) %>%
+ coord_polar("y", start=0) %>%
+ labs(title = "Proportion d'aires protégées par type d'écosystème \n(hors AP non-référencées)",
       subtitle = paste("Echantillon :", sum(data_eco_hist$n), "sur", nrow(data_stat_nodupl), "aires protégées"),
         x = "Type d'écosystème",
         y = "Proportion d'aires protégées") %>%
  + scale_fill_brewer(name = "Ecosystème", palette="Paired") %>%
  + theme_void()
pie_eco_fr


#pie chart in share (in English)
pie_eco_en = ggplot(data_eco_hist, 
                     aes(x = "", y = n, fill = ecosyst_en)) %>%
+ geom_bar(width = 1, stat = "identity",color="white") %>%
+ geom_label(aes(x=1.3, label = paste0(freq, "%")), 
             color = "black", position = position_stack(vjust = 0.55), 
             size=2.5, show.legend = FALSE) %>%
+ coord_polar("y", start=0) %>%
+ labs(title = "Proportion of protected areas by ecosystem type \n(excluding not referenced PAs)",
       subtitle = paste("Sample :", sum(data_eco_hist$n), "out of", nrow(data_stat_nodupl), "protected areas"),
         x = "Ecosystem type",
         y = "Proportion of protected areas") %>%
  + scale_fill_brewer(name = "Ecosystem", palette="Paired") %>%
  + theme_void()
pie_eco_en

#donut chart in share (in English)
donut_eco_en <- ggplot(data_eco_hist, aes(x = "", y = n, fill = ecosyst_en)) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  geom_label(aes(x = 1.3, label = paste0(freq, "%")), 
             color = "black", position = position_stack(vjust = 0.55), 
             size = 7, show.legend = FALSE) +
  coord_polar("y", start = 0) +
  labs(title = "Proportion of protected areas by ecosystem type \n(excluding not referenced PAs)",
       subtitle = paste("Sample :", sum(data_eco_hist$n), "out of", nrow(data_stat_nodupl), "protected areas"),
       x = "",
       y = "") +
   scale_fill_manual(name = "Ecosystem",
                      values = eco_colors_en) +
  theme_void() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 10),
    legend.position = "bottom"
  ) +
  annotate("text", x = 0, y = 0, label = "AFD", size = 6, fontface = "bold", color = "black") 

donut_eco_en 
```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")


ggsave(paste(tmp, "hist_eco_shr_fr.png", sep = "/"),
       plot = hist_eco_shr_fr,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "hist_eco_shr_en.png", sep = "/"),
       plot = hist_eco_shr_en,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "hist_eco_n_fr.png", sep = "/"),
       plot = hist_eco_n_fr,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "hist_eco_n_en.png", sep = "/"),
       plot = hist_eco_n_en,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "pie_eco_fr.png", sep = "/"),
       plot = pie_eco_fr,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "pie_eco_en.png", sep = "/"),
       plot = pie_eco_en,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "donut_eco_en.png", sep = "/"),
       plot = donut_eco_en,
       device = "png",
       height = 6, width = 9)

print(xtable(tbl_eco_fr, type = "latex"), 
      file = paste(tmp, "tbl_ecosyst_fr.tex", sep = "/"))
print(xtable(tbl_eco_en, type = "latex"), 
      file = paste(tmp, "tbl_ecosyst_en.tex", sep = "/"))

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/descriptive_stats/ecosysteme/world", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

#### Proportion of PAs by marine or terrestrial areas (region)

PAs in a given region to specify.

```{r, eval = FALSE}

#Define the region of interest where the stats are performed
roi = "Africa"

#Build datasets
data_eco = data_stat_nodupl %>%
  #subset non-referencded PAs (have NA ecosysteme)
  subset(is.na(marine) == FALSE & region == roi) %>%
  mutate(marine = as.factor(marine))
data_eco$ecosyst_en = fct_recode(data_eco$marine, 
                              "Terrestrial"="0", 
                              "Coastal"="1", 
                              "Marine"="2")
data_eco$ecosyst_fr = fct_recode(data_eco$marine, 
                              "Terrestre"="0", 
                              "Côtier"="1", 
                              "Marin"="2")

data_eco_hist = data_eco %>%
  group_by(ecosyst_en, ecosyst_fr) %>%
  summarize(n = n(),
            freq = round(n/nrow(data_eco), 2)*100) %>%
  ungroup()

tbl_eco_fr = data_eco_hist %>%
  select(c(ecosyst_fr, n, freq)) %>%
  rename("Ecosystème" = "ecosyst_fr",
         "Nombre d'AP" = "n",
         "Proportion d'AP(%)" = "freq")

tbl_eco_en = data_eco_hist %>%
  select(c(ecosyst_en, n, freq)) %>%
  rename("Ecosystem" = "ecosyst_en",
         "Number of PAs" = "n",
         "Share of PAs(%)" = "freq")


#Histogram in share (in French)
hist_eco_shr_fr = ggplot(data_eco_hist, 
                     aes(x = ecosyst_fr, y = freq, fill = ecosyst_fr)) %>%
+ geom_bar(width = 0.50, fill= "#3182BD", stat="identity") %>%
+ geom_text(aes(label = round(n, 1), y = freq), 
        vjust = -0.1, color="black",
        size=3.5) %>%
+ labs(title = paste("Proportion d'aires protégées par type d'écosystème,", roi, "\n(hors AP non-référencées)"),
       subtitle = paste("Echantillon :", sum(data_eco_hist$n), "sur", nrow(subset(data_stat_nodupl, region == roi)), "aires protégées. Nombre d'aires indiqué sur les barres."),
         x = "Type d'écosystème",
         y = "Proportion d'aires protégées(%)") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 0,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
hist_eco_shr_fr
# 



#Histogram in share (in English)
hist_eco_shr_en = ggplot(data_eco_hist, 
                     aes(x = ecosyst_en, y = freq, fill = ecosyst_en)) %>%
+ geom_bar(width = 0.50, stat="identity") %>%
  #fill= "#3182BD", 
+ geom_text(aes(label = round(n, 1), y = freq), 
        vjust = -0.1, color="black",
        size=3.5) %>%
+ labs(title = paste("Proportion of protected areas by ecosystem type,","in", roi,  "\n(excluding not referenced PAs)"),
       subtitle = paste("Sample :", sum(data_eco_hist$n), "out of", nrow(subset(data_stat_nodupl, region == roi)), "protected areas.\n Number of areas indicated above."),
         x = "Ecosystem type",
         y = "Proportion of protected areas(%)") %>%
  # + theme(legend.position = "bottom",
  #     legend.key = element_rect(fill = "white"),
  #     plot.title = element_text(size = 14, face = "bold"), 
  #     axis.text.x = element_text(angle = 0,size=10, hjust = .5, vjust = .6),
  #     axis.title.x = element_text(margin = margin(t = 10)),
  #     panel.background = element_rect(fill = 'white', colour = 'white', 
  #                                     linewidth = 0.5, linetype = 'solid'),
  #     panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
  #     panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
  #     plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))%>%
  + scale_fill_manual(name = "Ecosystem",
                      values = eco_colors_en) 
hist_eco_shr_en


  
#Histogram in number (in French)
hist_eco_n_fr = ggplot(data_eco_hist, 
                     aes(x = ecosyst_fr, y = n, fill = ecosyst_fr)) %>%
+ geom_bar(width = 0.50, fill= "#3182BD", stat="identity") %>%
+ labs(title = paste("Proportion d'aires protégées par type d'écosystème,", roi, "\n(hors AP non-référencées)"),
       subtitle = paste("Echantillon :", sum(data_eco_hist$n), "sur", nrow(subset(data_stat_nodupl, region == roi)), "aires protégées"),
         x = "Type d'écosystème",
         y = "# d'aires protégées") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 0,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
hist_eco_n_fr


#Histogram in number (in English)
hist_eco_n_en = ggplot(data_eco_hist, 
                     aes(x = ecosyst_en, y = n, fill = ecosyst_en)) %>%
+ geom_bar(width = 0.50, fill= "#3182BD", stat="identity") %>%
+ labs(title = paste("Proportion of protected areas by ecosystem type,", roi, "\n(excluding not referenced PAs)"),
       subtitle = paste("Sample :", sum(data_eco_hist$n), "out of", nrow(subset(data_stat_nodupl, region == roi)), "protected areas"),
         x = "Ecosystem type",
         y = "# of protected areas") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 0,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
hist_eco_n_en

#Pie chart (in French)
pie_eco_fr = ggplot(data_eco_hist, 
                     aes(x = "", y = freq, fill = ecosyst_fr)) %>%
+ geom_bar(width = 1, stat = "identity",color="white") %>%
+ geom_label(aes(x=1.3, label = paste0(freq, "%")), 
             color = "black", position = position_stack(vjust = 0.55), 
             size=2.5, show.legend = FALSE) %>%
+ coord_polar("y", start=0) %>%
+ labs(title = paste("Proportion d'aires protégées par type d'écosystème,", roi, "\n(hors AP non-référencées)"),
       subtitle = paste("Echantillon :", sum(data_eco_hist$n), "sur", nrow(subset(data_stat_nodupl, region == roi)), "aires protégées"),
         x = "Type d'écosystème",
         y = "Proportion d'aires protégées") %>%
  + scale_fill_brewer(name = "Ecosystème", palette="Paired") %>%
  + theme_void()
pie_eco_fr


#Histogram in number (in English)
pie_eco_en = ggplot(data_eco_hist, 
                     aes(x = "", y = n, fill = ecosyst_en)) %>%
+ geom_bar(width = 1, stat = "identity",color="white") %>%
+ geom_label(aes(x=1.3, label = paste0(freq, "%")), 
             color = "black", position = position_stack(vjust = 0.55), 
             size=2.5, show.legend = FALSE) %>%
+ coord_polar("y", start=0) %>%
+ labs(title = paste("Proportion of protected areas by ecosystem type,", roi, "\n(excluding not referenced PAs)"),
       subtitle = paste("Sample :", sum(data_eco_hist$n), "out of", nrow(subset(data_stat_nodupl, region == roi)), "protected areas"),
         x = "Ecosystem type",
         y = "Proportion of protected areas") %>%
  + scale_fill_brewer(name = "Ecosystem", palette="Paired") %>%
  + theme_void()
pie_eco_en
```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")


ggsave(paste(tmp, paste0("hist_eco_shr_", roi, "_fr.png"), sep = "/"),
       plot = hist_eco_shr_fr,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, paste0("hist_eco_shr_", roi, "_en.png"), sep = "/"),
       plot = hist_eco_shr_en,
       device = "png",
       height = 4, width = 7)
ggsave(paste(tmp, paste0("hist_eco_n_", roi, "_fr.png"), sep = "/"),
       plot = hist_eco_n_fr,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, paste0("hist_eco_n_", roi, "_en.png"), sep = "/"),
       plot = hist_eco_n_en,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, paste0("pie_eco_", roi, "_fr.png"), sep = "/"),
       plot = pie_eco_fr,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, paste0("pie_eco_", roi, "_en.png"), sep = "/"),
       plot = pie_eco_en,
       device = "png",
       height = 6, width = 9)

print(xtable(tbl_eco_fr, type = "latex"), 
      file = paste(tmp, paste0("tbl_ecosyst_", roi, "_fr.tex"), sep = "/"))
print(xtable(tbl_eco_en, type = "latex"), 
      file = paste(tmp, paste0("tbl_ecosyst_", roi, "_en.tex"), sep = "/"))

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = paste("projet-afd-eva-ap/descriptive_stats/ecosysteme", roi, sep = "/"), 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))

```



### Ecosystems (with non-referenced PAs)
#### Proportion of PAs by marine or terrestrial areas (region)

PAs in a given region to specify.

```{r, eval = FALSE}

#Define the region of interest where the stats are performed
roi = "Africa"

data_eco = data_stat_nodupl %>%
  # Subset non-referenced PAs (those with NA ecosystem)
  subset(region == roi) %>%
  mutate(marine = as.factor(marine))
# Recoding the 'marine' variable into English and French categories, including handling NA values
data_eco$ecosyst_en = fct_recode(data_eco$marine, 
                                 "Terrestrial" = "0", 
                                 "Coastal" = "1", 
                                 "Marine" = "2") %>%
  fct_explicit_na(na_level = "Not referenced")

data_eco$ecosyst_fr = fct_recode(data_eco$marine, 
                                 "Terrestre" = "0", 
                                 "Côtier" = "1", 
                                 "Marin" = "2") %>%
  fct_explicit_na(na_level = "Non référencée")

data_eco_hist = data_eco %>%
  group_by(ecosyst_en, ecosyst_fr) %>%
  summarize(n = n(),
            freq = round(n/nrow(data_eco), 2)*100) %>%
  ungroup()

tbl_eco_fr = data_eco_hist %>%
  dplyr::select(c(ecosyst_fr, n, freq)) %>%
  rename("Ecosystème" = "ecosyst_fr",
         "Nombre d'AP" = "n",
         "Proportion d'AP(%)" = "freq")

tbl_eco_en = data_eco_hist %>%
  dplyr::select(c(ecosyst_en, n, freq)) %>%
  rename("Ecosystem" = "ecosyst_en",
         "Number of PAs" = "n",
         "Share of PAs(%)" = "freq")


#Histogram in share (in French)
hist_eco_shr_fr = ggplot(data_eco_hist, 
                     aes(x = ecosyst_fr, y = freq, fill = ecosyst_fr)) %>%
+ geom_bar(width = 0.50, fill= "#3182BD", stat="identity") %>%
+ geom_text(aes(label = round(n, 1), y = freq), 
        vjust = -0.1, color="black",
        size=3.5) %>%
+ labs(title = paste("Proportion d'aires protégées par type d'écosystème,", roi, "\n(hors AP non-référencées)"),
       subtitle = paste("Echantillon :", sum(data_eco_hist$n), "sur", nrow(subset(data_stat_nodupl, region == roi)), "aires protégées. Nombre d'aires indiqué sur les barres."),
         x = "Type d'écosystème",
         y = "Proportion d'aires protégées(%)") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 0,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
hist_eco_shr_fr
# 



#Histogram in share (in English)
hist_eco_shr_en = ggplot(data_eco_hist, 
                     aes(x = ecosyst_en, y = freq, fill = ecosyst_en)) %>%
+ geom_bar(width = 0.50, stat="identity") %>%
  #fill= "#3182BD", 
+ geom_text(aes(label = round(n, 1), y = freq), 
        vjust = -0.1, color="black",
        size=3.5) %>%
+ labs(title = paste("Proportion of protected areas by ecosystem type,","in", roi,  "\n(excluding not referenced PAs)"),
       subtitle = paste("Sample :", sum(data_eco_hist$n), "out of", nrow(subset(data_stat_nodupl, region == roi)), "protected areas.\n Number of areas indicated above."),
         x = "Ecosystem type",
         y = "Proportion of protected areas(%)") %>%
  # + theme(legend.position = "bottom",
  #     legend.key = element_rect(fill = "white"),
  #     plot.title = element_text(size = 14, face = "bold"), 
  #     axis.text.x = element_text(angle = 0,size=10, hjust = .5, vjust = .6),
  #     axis.title.x = element_text(margin = margin(t = 10)),
  #     panel.background = element_rect(fill = 'white', colour = 'white', 
  #                                     linewidth = 0.5, linetype = 'solid'),
  #     panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
  #     panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
  #     plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))%>%
  + scale_fill_manual(name = "Ecosystem",
                      values = eco_colors_en) 
hist_eco_shr_en


  
#Histogram in number (in French)
hist_eco_n_fr = ggplot(data_eco_hist, 
                     aes(x = ecosyst_fr, y = n, fill = ecosyst_fr)) %>%
+ geom_bar(width = 0.50, fill= "#3182BD", stat="identity") %>%
+ labs(title = paste("Proportion d'aires protégées par type d'écosystème,", roi, "\n(hors AP non-référencées)"),
       subtitle = paste("Echantillon :", sum(data_eco_hist$n), "sur", nrow(subset(data_stat_nodupl, region == roi)), "aires protégées"),
         x = "Type d'écosystème",
         y = "# d'aires protégées") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 0,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
hist_eco_n_fr


#Histogram in number (in English)
hist_eco_n_en = ggplot(data_eco_hist, 
                     aes(x = ecosyst_en, y = n, fill = ecosyst_en)) %>%
+ geom_bar(width = 0.50, fill= "#3182BD", stat="identity") %>%
+ labs(title = paste("Proportion of protected areas by ecosystem type,", roi, "\n(excluding not referenced PAs)"),
       subtitle = paste("Sample :", sum(data_eco_hist$n), "out of", nrow(subset(data_stat_nodupl, region == roi)), "protected areas"),
         x = "Ecosystem type",
         y = "# of protected areas") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 0,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
hist_eco_n_en

#Pie chart (in French)
pie_eco_fr = ggplot(data_eco_hist, 
                     aes(x = "", y = freq, fill = ecosyst_fr)) %>%
+ geom_bar(width = 1, stat = "identity",color="white") %>%
+ geom_label(aes(x=1.3, label = paste0(freq, "%")), 
             color = "black", position = position_stack(vjust = 0.55), 
             size=2.5, show.legend = FALSE) %>%
+ coord_polar("y", start=0) %>%
+ labs(title = paste("Proportion d'aires protégées par type d'écosystème,", roi, "\n(hors AP non-référencées)"),
       subtitle = paste("Echantillon :", sum(data_eco_hist$n), "sur", nrow(subset(data_stat_nodupl, region == roi)), "aires protégées"),
         x = "Type d'écosystème",
         y = "Proportion d'aires protégées") %>%
  + scale_fill_brewer(name = "Ecosystème", palette="Paired") %>%
  + theme_void()
pie_eco_fr


#Histogram in number (in English)
pie_eco_en = ggplot(data_eco_hist, 
                     aes(x = "", y = n, fill = ecosyst_en)) %>%
+ geom_bar(width = 1, stat = "identity",color="white") %>%
+ geom_label(aes(x=1.3, label = paste0(freq, "%")), 
             color = "black", position = position_stack(vjust = 0.55), 
             size=2.5, show.legend = FALSE) %>%
+ coord_polar("y", start=0) %>%
+ labs(title = paste("Proportion of protected areas by ecosystem type,", roi, "\n(excluding not referenced PAs)"),
       subtitle = paste("Sample :", sum(data_eco_hist$n), "out of", nrow(subset(data_stat_nodupl, region == roi)), "protected areas"),
         x = "Ecosystem type",
         y = "Proportion of protected areas") %>%
  + scale_fill_brewer(name = "Ecosystem", palette="Paired") %>%
  + theme_void()
pie_eco_en

#donut chart in share (in English)
donut_eco_en <- ggplot(data_eco_hist, aes(x = "", y = n, fill = ecosyst_en)) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  geom_label(aes(x = 1.3, label = paste0(freq, "%")), 
             color = "black", position = position_stack(vjust = 0.55), 
             size = 4, show.legend = FALSE) +
  coord_polar("y", start = 0) +
  labs(title = "Proportion of protected areas by ecosystem type \n(excluding not referenced PAs)",
       subtitle = paste("Sample :", sum(data_eco_hist$n), "out of", nrow(data_stat_nodupl), "protected areas"),
       x = "",
       y = "") +
   scale_fill_manual(name = "Ecosystem",
                      values = eco_colors_en) +
  theme_void() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 10),
    legend.position = "bottom"
  ) +
  annotate("text", x = 0, y = 0, label = "AFD", size = 6, fontface = "bold", color = "black") 

donut_eco_en 

```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")


ggsave(paste(tmp, paste0("hist_eco_shr_", roi, "_fr.png"), sep = "/"),
       plot = hist_eco_shr_fr,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, paste0("hist_eco_shr_", roi, "_en.png"), sep = "/"),
       plot = hist_eco_shr_en,
       device = "png",
       height = 4, width = 7)
ggsave(paste(tmp, paste0("hist_eco_n_", roi, "_fr.png"), sep = "/"),
       plot = hist_eco_n_fr,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, paste0("hist_eco_n_", roi, "_en.png"), sep = "/"),
       plot = hist_eco_n_en,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, paste0("pie_eco_", roi, "_fr.png"), sep = "/"),
       plot = pie_eco_fr,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, paste0("pie_eco_", roi, "_en.png"), sep = "/"),
       plot = pie_eco_en,
       device = "png",
       height = 6, width = 9)

print(xtable(tbl_eco_fr, type = "latex"), 
      file = paste(tmp, paste0("tbl_ecosyst_", roi, "_fr.tex"), sep = "/"))
print(xtable(tbl_eco_en, type = "latex"), 
      file = paste(tmp, paste0("tbl_ecosyst_", roi, "_en.tex"), sep = "/"))

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = paste("projet-afd-eva-ap/descriptive_stats/ecosysteme", roi, sep = "/"), 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))

```




### Distribution (\# and surface) of PAs across countries and regions

Number/share of PAs in the different countries/regions.

#### Statistics at country level (all)

For all PAs in the world.

```{r message=FALSE, warning=FALSE, eval = FALSE}





#Surface and number of PAs by country
data_distrib_ctry = data_stat_nodupl %>%
  group_by(iso3, country_en, country_fr) %>%
  summarize(n = n(),
            area_km2 = sum(area_km2, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(n_tot = sum(n, na.rm = TRUE),
         area_tot_km2 = sum(area_km2, na.rm = TRUE),
         freq_n = round(n/n_tot*100, 2),
         freq_area = round(area_km2/area_tot_km2*100, 2)) %>%
  pivot_longer(cols = c("n", "freq_n", "area_km2", "freq_area"),
               names_to = "metric")

#Top targeted countries in terms of number/surface of PAs
data_distrib_ctry_top_n = data_distrib_ctry %>%
  filter(metric == "freq_n") %>%
  arrange(-value) %>%
  slice(1:5)
data_distrib_ctry_top_area = data_distrib_ctry %>%
  filter(metric == "freq_area") %>%
  arrange(-value) %>%
  slice(1:5)

#Histogram in share (in French) for top countries
##Number of PAs
hist_distrib_ctry_top_n_shr = ggplot(data_distrib_ctry_top_n, 
                     aes(x = reorder(country_en, -value), y = value, fill = value)) %>%
+ geom_bar(width = 0.50, fill= "#3182BD", stat="identity") %>%
# + geom_text(aes(label = paste(value, "PAs"), y = value), 
#         vjust = -0.1, color="black",
#         size=3.5) %>%
+ labs(title = "Countries most targeted by AFD funded protected areas (#)",
       subtitle = paste("Sample :", sum(filter(data_distrib_ctry, metric == "n")$value), "protected areas covering", format(sum(filter(data_distrib_ctry, metric == "area_km2")$value), digits = 2, scientific = TRUE), "km²"),
         x = "",
         y = "Share of protected areas (%)") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 0,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
hist_distrib_ctry_top_n_shr

##Area of PAs
hist_distrib_ctry_top_area_shr = ggplot(data_distrib_ctry_top_area, 
                     aes(x = reorder(country_en, -value), y = value, fill = value)) %>%
+ geom_bar(width = 0.50, fill= "#3182BD", stat="identity") %>%
# + geom_text(aes(label = paste(value, "PAs"), y = value), 
#         vjust = -0.1, color="black",
#         size=3.5) %>%
+ labs(title = "Countries most targeted by AFD funded protected areas (area)",
       subtitle = paste("Sample :", sum(filter(data_distrib_ctry, metric == "n")$value), "protected areas covering", format(sum(filter(data_distrib_ctry, metric == "area_km2")$value), digits = 2, scientific = TRUE), "km²"),
         x = "",
         y = "Share of area funded (%)") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 0,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
hist_distrib_ctry_top_area_shr

#Histogram for all countries
#Histogram in number
hist_distrib_ctry_n_shr = ggplot(filter(data_distrib_ctry, metric == "freq_n"), 
                     aes(x = reorder(iso3, -value), y = value, fill = iso3)) %>%
+ geom_bar(width = 0.50, fill= "#3182BD", stat="identity") %>%
# + geom_text(aes(label = n, y = n), 
#         vjust = -0.1, color="black",
#         size=3) %>%
+ labs(title = "Distribution of protected areas by country (#)",
       subtitle = paste("Sample :", sum(filter(data_distrib_ctry, metric == "n")$value), "protected areas covering", format(sum(filter(data_distrib_ctry, metric == "area_km2")$value), digits = 2, scientific = TRUE), "km²"),
         x = "",
         y = "Share of protected areas (%)") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
hist_distrib_ctry_n_shr

# Histogram in surfaces
hist_distrib_ctry_area_shr = ggplot(filter(data_distrib_ctry, metric == "freq_area"), 
                     aes(x = reorder(iso3, -value), y = value, fill = iso3)) %>%
+ geom_bar(width = 0.50, fill= "#3182BD", stat="identity") %>%
# + geom_text(aes(label = n, y = n), 
#         vjust = -0.1, color="black",
#         size=3) %>%
+ labs(title = "Distribution of protected areas by country (area)",
       subtitle = paste("Sample :", sum(filter(data_distrib_ctry, metric == "n")$value), "protected areas covering", format(sum(filter(data_distrib_ctry, metric == "area_km2")$value), digits = 2, scientific = TRUE), "km²"),
         x = "",
         y = "Share of area funded (%)") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
hist_distrib_ctry_area_shr

## Both
hist_distrib_ctry_top_both_shr = ggplot(filter(data_distrib_ctry, metric %in% c("freq_n", "freq_area")), 
                     aes(x = reorder(iso3, -value), y = value, fill = metric)) %>%
+ geom_bar(position="dodge", stat="identity") %>%
# + geom_text(aes(label = paste(value, "PAs"), y = value), 
#         vjust = -0.1, color="black",
#         size=3.5) %>%
+ labs(title = "Distribution of AFD funded protected areas by country",
       subtitle = paste("Sample :", sum(filter(data_distrib_ctry, metric == "n")$value), "protected areas covering", format(sum(filter(data_distrib_ctry, metric == "area_km2")$value), digits = 2, scientific = TRUE), "km²"),
         x = "",
         y = "Share of protected areas (%)") %>%
+ scale_fill_brewer(name = "", labels = c("Area", "Number"),
                    type = "seq", palette = "Blues") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
hist_distrib_ctry_top_both_shr
```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

ggsave(paste(tmp, "hist_distrib_ctry_top_n_shr.png", sep = "/"),
       plot = hist_distrib_ctry_top_n_shr,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "hist_distrib_ctry_top_area_shr.png", sep = "/"),
       plot = hist_distrib_ctry_top_area_shr,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "hist_distrib_ctry_n_shr.png", sep = "/"),
       plot = hist_distrib_ctry_n_shr,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "hist_distrib_ctry_area_shr.png", sep = "/"),
       plot = hist_distrib_ctry_area_shr,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "hist_distrib_ctry_top_both_shr.png", sep = "/"),
       plot = hist_distrib_ctry_top_both_shr,
       device = "png",
       height = 6, width = 9)

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/descriptive_stats/distribution/world/all", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))

```

#### Statistics at country level (non-marine)

Non-marine PAs across the world.

```{r message=FALSE, warning=FALSE, eval = FALSE}

#Surface and number of PAs by country
data_distrib_ctry = data_stat_nodupl %>%
  filter(marine %in% c(0,1)) %>%
  group_by(iso3, country_en, country_fr) %>%
  summarize(n = n(),
            area_km2 = sum(area_km2, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(n_tot = sum(n, na.rm = TRUE),
         area_tot_km2 = sum(area_km2, na.rm = TRUE),
         freq_n = round(n/n_tot*100, 2),
         freq_area = round(area_km2/area_tot_km2*100, 2)) %>%
  pivot_longer(cols = c("n", "freq_n", "area_km2", "freq_area"),
               names_to = "metric")

#Top targeted countries in terms of number/surface of PAs
data_distrib_ctry_top_n = data_distrib_ctry %>%
  filter(metric == "freq_n") %>%
  arrange(-value) %>%
  slice(1:5)
data_distrib_ctry_top_area = data_distrib_ctry %>%
  filter(metric == "freq_area") %>%
  arrange(-value) %>%
  slice(1:5)

#Histogram in share (in French) for top countries
##Number of PAs
hist_distrib_ctry_top_n_shr = ggplot(data_distrib_ctry_top_n, 
                     aes(x = reorder(country_en, -value), y = value, fill = value)) %>%
+ geom_bar(width = 0.50, fill= "#3182BD", stat="identity") %>%
# + geom_text(aes(label = paste(value, "PAs"), y = value), 
#         vjust = -0.1, color="black",
#         size=3.5) %>%
+ labs(title = "Countries most targeted by AFD funded, non-marine protected areas (#)",
       subtitle = paste("Sample :", sum(filter(data_distrib_ctry, metric == "n")$value), "non-marine protected areas covering", format(sum(filter(data_distrib_ctry, metric == "area_km2")$value), digits = 2, scientific = TRUE), "km²"),
         x = "",
         y = "Share of protected areas (%)") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 0,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
hist_distrib_ctry_top_n_shr

##Area of PAs
hist_distrib_ctry_top_area_shr = ggplot(data_distrib_ctry_top_area, 
                     aes(x = reorder(country_en, -value), y = value, fill = value)) %>%
+ geom_bar(width = 0.50, fill= "#3182BD", stat="identity") %>%
# + geom_text(aes(label = paste(value, "PAs"), y = value), 
#         vjust = -0.1, color="black",
#         size=3.5) %>%
+ labs(title = "Countries most targeted by AFD funded, non-marine protected areas (area)",
       subtitle = paste("Sample :", sum(filter(data_distrib_ctry, metric == "n")$value), "non-marine protected areas covering", format(sum(filter(data_distrib_ctry, metric == "area_km2")$value), digits = 2, scientific = TRUE), "km²"),
         x = "",
         y = "Share of area funded (%)") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 0,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
hist_distrib_ctry_top_area_shr

#Histogram for all countries
#Histogram in number
hist_distrib_ctry_n_shr = ggplot(filter(data_distrib_ctry, metric == "freq_n"), 
                     aes(x = reorder(iso3, -value), y = value, fill = iso3)) %>%
+ geom_bar(width = 0.50, fill= "#3182BD", stat="identity") %>%
# + geom_text(aes(label = n, y = n), 
#         vjust = -0.1, color="black",
#         size=3) %>%
+ labs(title = "Distribution of AFD funded, non-marine protected areas by country (#)",
       subtitle = paste("Sample :", sum(filter(data_distrib_ctry, metric == "n")$value), "non-marine protected areas covering", format(sum(filter(data_distrib_ctry, metric == "area_km2")$value), digits = 2, scientific = TRUE), "km²"),
         x = "",
         y = "Share of protected areas (%)") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
hist_distrib_ctry_n_shr
# Histogram in surfaces
hist_distrib_ctry_area_shr = ggplot(filter(data_distrib_ctry, metric == "freq_area"), 
                     aes(x = reorder(iso3, -value), y = value, fill = iso3)) %>%
+ geom_bar(width = 0.50, fill= "#3182BD", stat="identity") %>%
# + geom_text(aes(label = n, y = n), 
#         vjust = -0.1, color="black",
#         size=3) %>%
+ labs(title = "Distribution of AFD funded, non-marine protected areas by country (area)",
       subtitle = paste("Sample :", sum(filter(data_distrib_ctry, metric == "n")$value), "non-marine protected areas covering", format(sum(filter(data_distrib_ctry, metric == "area_km2")$value), digits = 2, scientific = TRUE), "km²"),
         x = "Countries",
         y = "Share of area funded (%)") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
hist_distrib_ctry_area_shr

## Both
hist_distrib_ctry_top_both_shr = ggplot(filter(data_distrib_ctry, metric %in% c("freq_area", "freq_n")), 
                     aes(x = reorder(iso3, -value), y = value, fill = metric)) %>%
+ geom_bar(position="dodge", stat="identity") %>%
# + geom_text(aes(label = paste(value, "PAs"), y = value), 
#         vjust = -0.1, color="black",
#         size=3.5) %>%
+ labs(title = "Distribution of AFD funded, non-marine protected areas by country",
       subtitle = paste("Sample :", sum(filter(data_distrib_ctry, metric == "n")$value), "non-marine protected areas covering", format(sum(filter(data_distrib_ctry, metric == "area_km2")$value), digits = 2, scientific = TRUE), "km²"),
         x = "",
         y = "Share of protected areas (%)") %>%
+ scale_fill_brewer(name = "", labels = c("Area", "Number"),
                    type = "seq", palette = "Blues") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
hist_distrib_ctry_top_both_shr
```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

ggsave(paste(tmp, "hist_distrib_ctry_top_n_shr.png", sep = "/"),
       plot = hist_distrib_ctry_top_n_shr,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "hist_distrib_ctry_top_area_shr.png", sep = "/"),
       plot = hist_distrib_ctry_top_area_shr,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "hist_distrib_ctry_n_shr.png", sep = "/"),
       plot = hist_distrib_ctry_top_n_shr,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "hist_distrib_ctry_area_shr.png", sep = "/"),
       plot = hist_distrib_ctry_top_area_shr,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "hist_distrib_ctry_top_both_shr.png", sep = "/"),
       plot = hist_distrib_ctry_top_both_shr,
       device = "png",
       height = 6, width = 9)


#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/descriptive_stats/distribution/world/no_marine", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

#### Statistics at country level (region, non-marine)

Non-marine PAs in a given region.

```{r message=FALSE, warning=FALSE, eval = FALSE}

roi = "Africa"

#Surface and number of PAs by country
data_distrib_ctry = data_stat_nodupl %>%
  filter(region == roi & marine %in% c(0,1)) %>%
  group_by(iso3, country_en, country_fr) %>%
  summarize(n = n(),
            area_km2 = sum(area_km2, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(n_tot = sum(n, na.rm = TRUE),
         area_tot_km2 = sum(area_km2, na.rm = TRUE),
         freq_n = round(n/n_tot*100, 2),
         freq_area = round(area_km2/area_tot_km2*100, 2)) %>%
  pivot_longer(cols = c("n", "freq_n", "area_km2", "freq_area"),
               names_to = "metric")

#Top targeted countries in terms of number/surface of PAs
data_distrib_ctry_top_n = data_distrib_ctry %>%
  filter(metric == "freq_n") %>%
  arrange(-value) %>%
  slice(1:5)
data_distrib_ctry_top_area = data_distrib_ctry %>%
  filter(metric == "freq_area") %>%
  arrange(-value) %>%
  slice(1:5)

#Histogram in share (in French) for top countries
##Number of PAs
hist_distrib_ctry_top_n_shr = ggplot(data_distrib_ctry_top_n, 
                     aes(x = reorder(country_en, -value), y = value, fill = value)) %>%
+ geom_bar(width = 0.50, fill= "#3182BD", stat="identity") %>%
# + geom_text(aes(label = paste(value, "PAs"), y = value), 
#         vjust = -0.1, color="black",
#         size=3.5) %>%
+ labs(title = paste0("Countries most targeted by AFD funded, non-marine protected areas (#) \n", roi),
       subtitle = paste("Sample :", sum(filter(data_distrib_ctry, metric == "n")$value), "non-marine protected areas covering", format(sum(filter(data_distrib_ctry, metric == "area_km2")$value), digits = 2, scientific = TRUE), "km²"),
         x = "",
         y = "Share of protected areas (%)") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 0,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
hist_distrib_ctry_top_n_shr

##Area of PAs
hist_distrib_ctry_top_area_shr = ggplot(data_distrib_ctry_top_area, 
                     aes(x = reorder(country_en, -value), y = value, fill = value)) %>%
+ geom_bar(width = 0.50, fill= "#3182BD", stat="identity") %>%
# + geom_text(aes(label = paste(value, "PAs"), y = value), 
#         vjust = -0.1, color="black",
#         size=3.5) %>%
+ labs(title = paste0("Countries most targeted by AFD funded, non-marine protected areas (area)\n", roi),
       subtitle = paste("Sample :", sum(filter(data_distrib_ctry, metric == "n")$value), "non-marine protected areas covering", format(sum(filter(data_distrib_ctry, metric == "area_km2")$value), digits = 2, scientific = TRUE), "km²"),
         x = "",
         y = "Share of area funded (%)") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 0,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
hist_distrib_ctry_top_area_shr

#Histogram for all countries
#Histogram in number
hist_distrib_ctry_n_shr = ggplot(filter(data_distrib_ctry, metric == "freq_n"), 
                     aes(x = reorder(iso3, -value), y = value, fill = iso3)) %>%
+ geom_bar(width = 0.50, fill= "#3182BD", stat="identity") %>%
# + geom_text(aes(label = n, y = n), 
#         vjust = -0.1, color="black",
#         size=3) %>%
+ labs(title = paste0("Distribution of AFD funded, non-marine protected areas by country (#)\n", roi),
       subtitle = paste("Sample :", sum(filter(data_distrib_ctry, metric == "n")$value), "non-marine protected areas covering", format(sum(filter(data_distrib_ctry, metric == "area_km2")$value), digits = 2, scientific = TRUE), "km²"),
         x = "",
         y = "Share of protected areas (%)") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
hist_distrib_ctry_n_shr
# Histogram in surfaces
hist_distrib_ctry_area_shr = ggplot(filter(data_distrib_ctry, metric == "freq_area"), 
                     aes(x = reorder(iso3, -value), y = value, fill = iso3)) %>%
+ geom_bar(width = 0.50, fill= "#3182BD", stat="identity") %>%
# + geom_text(aes(label = n, y = n), 
#         vjust = -0.1, color="black",
#         size=3) %>%
+ labs(title = paste0("Distribution of AFD funded, non-marine protected areas by country (area)\n", roi),
       subtitle = paste("Sample :", sum(filter(data_distrib_ctry, metric == "n")$value), "non-marine protected areas covering", format(sum(filter(data_distrib_ctry, metric == "area_km2")$value), digits = 2, scientific = TRUE), "km²"),
         x = "",
         y = "Share of area funded (%)") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
hist_distrib_ctry_area_shr

## Both
hist_distrib_ctry_both_shr = ggplot(filter(data_distrib_ctry, metric %in% c("freq_area", "freq_n")), 
                     aes(x = reorder(iso3, -value), y = value, fill = metric)) %>%
+ geom_bar(position="dodge", stat="identity") %>%
# + geom_text(aes(label = paste(value, "PAs"), y = value), 
#         vjust = -0.1, color="black",
#         size=3.5) %>%
+ labs(title = paste0("Distribution of AFD funded, non-marine protected areas by country\n", roi),
       subtitle = paste("Sample :", sum(filter(data_distrib_ctry, metric == "n")$value), "non-marine protected areas covering", format(sum(filter(data_distrib_ctry, metric == "area_km2")$value), digits = 2, scientific = TRUE), "km²"),
         x = "",
         y = "Share of protected areas (%)") %>%
+ scale_fill_brewer(name = "", labels = c("Area", "Number"),
                    type = "seq", palette = "Blues") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
hist_distrib_ctry_both_shr
```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

ggsave(paste(tmp, "hist_distrib_ctry_top_n_shr.png", sep = "/"),
       plot = hist_distrib_ctry_top_n_shr,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "hist_distrib_ctry_top_area_shr.png", sep = "/"),
       plot = hist_distrib_ctry_top_area_shr,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "hist_distrib_ctry_n_shr.png", sep = "/"),
       plot = hist_distrib_ctry_top_n_shr,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "hist_distrib_ctry_area_shr.png", sep = "/"),
       plot = hist_distrib_ctry_top_area_shr,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "hist_distrib_ctry_both_shr.png", sep = "/"),
       plot = hist_distrib_ctry_both_shr,
       device = "png",
       height = 6, width = 9)

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = paste("projet-afd-eva-ap/descriptive_stats/distribution", roi, "no_marine", sep = "/"), 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))

```

#### Statistics at country level (non-marine, WDPA vs AFD)

```{r, eval = FALSE}
#For AFD funded PAs
##Distribution across countries (all)
data_distrib_ctry_afd = data_stat_nodupl %>%
  filter(marine %in% c(0,1)) %>%
  group_by(iso3, country_en) %>%
  summarize(n_afd = n(),
            area_km2_afd = sum(area_km2, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(n_tot_afd = sum(n_afd),
         area_km2_afd_tot = sum(area_km2_afd, na.rm = TRUE),
         freq_n_afd = round(n_afd/n_tot_afd*100, 2),
         freq_area_afd = round(area_km2_afd/area_km2_afd_tot*100, 2))
##Top 10 funded countries
###Number
data_distrib_ctry_afd_top_n = data_distrib_ctry_afd %>%
  arrange(-freq_n_afd) %>%
  slice(1:10)
###Surface
data_distrib_ctry_afd_top_area = data_distrib_ctry_afd %>%
  arrange(-freq_area_afd) %>%
  slice(1:10)

#For WDPA PAs
## All countries in the list of interest
data_distrib_ctry_wdpa = data_wdpa %>%
  #Non-marine areas only
  filter(marine %in% c(0,1)) %>%
  #Countries of interest only
  filter(iso3 %in% lst_ctry_stat_wdpa) %>%
  group_by(iso3, country_en) %>%
  summarize(n_wdpa = n(),
            area_km2_wdpa = sum(rep_area, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(n_tot_wdpa = sum(n_wdpa),
         area_km2_wdpa_tot = sum(area_km2_wdpa, na.rm = TRUE),
         freq_n_wdpa = round(n_wdpa/n_tot_wdpa*100, 2),
         freq_area_wdpa = round(area_km2_wdpa/area_km2_wdpa_tot*100, 2))
## Top 10 targeted countries
data_distrib_ctry_wdpa_top_n = data_distrib_ctry_wdpa %>%
  arrange(-freq_n_wdpa) %>%
  slice(1:10)
data_distrib_ctry_wdpa_top_area = data_distrib_ctry_wdpa %>%
  arrange(-freq_area_wdpa) %>%
  slice(1:10)

#Then create a plotting dataset with WDPA vs AFD distribution
##the distribution for top targeted countries by AFD
### in terms of numbers
data_distrib_ctry_vs_n = data_distrib_ctry_afd_top_n %>%
  left_join(data_distrib_ctry_wdpa, c("iso3", "country_en")) %>%
  select(-contains("area")) %>%
  pivot_longer(cols = c("n_afd", "freq_n_afd", "n_wdpa", "freq_n_wdpa"),
               names_to = "metric") 
###in terms of areas
data_distrib_ctry_vs_area = data_distrib_ctry_afd_top_area %>%
  left_join(data_distrib_ctry_wdpa, c("iso3", "country_en")) %>%
  select(-contains("n_")) %>%
  pivot_longer(cols = c("area_km2_afd", "freq_area_afd", "area_km2_wdpa", "freq_area_wdpa"),
               names_to = "metric") 

#Histogram in share for top countries
##For WDPA PAs
### number
hist_distrib_ctry_wdpa_top_n = ggplot(data_distrib_ctry_wdpa_top_n,
                                  aes(x = reorder(iso3, -freq_n_wdpa), y = freq_n_wdpa, fill = freq_n_wdpa)) %>%
+ geom_bar(width = 0.50, fill= "#3182BD", stat="identity") %>%
+ labs(title = "Top countries of non-marine protected areas (#)",
       subtitle = paste("Sample :", min(data_distrib_ctry_wdpa$n_tot_wdpa), "non-marine protected areas reported by the WDPA, covering", format(min(data_distrib_ctry_wdpa$area_km2_wdpa_tot), scientific = TRUE, digits = 2), "km²"),
       caption = "Note : we consider non-marine PAs reported by the WDPA on the full period covered by the data, in countries that are potential AFD partners.\nThese are low-, lower-middle, upper-middle countries according to the World Bank 2022 classification, \nexcluding Russia and including Uruguay, Panama, Chile, New Caledonia.\nA subset of these PAs is AFD funded, though some PAs funded by the AFD are not reported by the WDPA.",
         x = "",
         y = "Share of protected areas (%)") %>%
+ scale_fill_brewer(name = "", labels = c("AFD funded", "Low- to upper-middle income*"),
                    type = "seq", palette = "Blues") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 0,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain', hjust = 0))
hist_distrib_ctry_wdpa_top_n 
### Area
hist_distrib_ctry_wdpa_top_area = ggplot(data_distrib_ctry_wdpa_top_area,
                                  aes(x = reorder(iso3, -freq_area_wdpa), y = freq_area_wdpa, fill = freq_area_wdpa)) %>%
+ geom_bar(width = 0.50, fill= "#3182BD", stat="identity") %>%
+ labs(title = "Top countries of non-marine protected areas (area)",
       subtitle = paste("Sample :", min(data_distrib_ctry_wdpa$n_tot_wdpa), "non-marine protected areas reported by the WDPA, covering", format(min(data_distrib_ctry_wdpa$area_km2_wdpa_tot), scientific = TRUE, digits = 2), "km²"),
       caption = "Note : we consider non-marine PAs reported by the WDPA on the full period covered by the data, in countries that are potential AFD partners.\nThese are low-, lower-middle, upper-middle countries according to the World Bank 2022 classification, \nexcluding Russia and including Uruguay, Panama, Chile, New Caledonia.",
         x = "",
         y = "Share of protected areas (%)") %>%
+ scale_fill_brewer(name = "", labels = c("AFD funded", "Low- to upper-middle income*"),
                    type = "seq", palette = "Blues") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 0,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain', hjust = 0))
hist_distrib_ctry_wdpa_top_area

##For AFD funded PAs
### number
hist_distrib_ctry_afd_top_n = ggplot(data_distrib_ctry_afd_top_n,
                                  aes(x = reorder(iso3, -freq_n_afd), y = freq_n_afd, fill = freq_n_afd)) %>%
+ geom_bar(width = 0.50, fill= "#3182BD", stat="identity") %>%
+ labs(title = "Top countries of AFD funded, non-marine protected areas (#)",
       subtitle = paste("Sample :", min(data_distrib_ctry_afd$n_tot_afd), "non-marine protected areas reported by the WDPA, covering", format(min(data_distrib_ctry_afd$area_km2_afd_tot), scientific = TRUE, digits = 2), "km²"),
      caption = "Note : we consider non-marine PAs reported by the WDPA on the full period covered by the data, in countries that are potential AFD partners.\nThese are low-, lower-middle, upper-middle countries according to the World Bank 2022 classification, \nexcluding Russia and including Uruguay, Panama, Chile, New Caledonia.\nA subset of these PAs is AFD funded, though some PAs funded by the AFD are not reported by the WDPA.",
         x = "",
         y = "Share of protected areas (%)") %>%
+ scale_fill_brewer(name = "", labels = c("AFD funded", "Low- to upper-middle income*"),
                    type = "seq", palette = "Blues") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 0,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain', hjust = 0))
hist_distrib_ctry_afd_top_n 
### Area
hist_distrib_ctry_afd_top_area = ggplot(data_distrib_ctry_afd_top_area,
                                  aes(x = reorder(iso3, -freq_area_afd), y = freq_area_afd, fill = freq_area_afd)) %>%
+ geom_bar(width = 0.50, fill= "#3182BD", stat="identity") %>%
+ labs(title = "Top countries of AFD funded, non-marine protected areas (area)",
       subtitle = paste("Sample :", min(data_distrib_ctry_afd$n_tot_afd), "non-marine protected areas reported by the WDPA, covering", format(min(data_distrib_ctry_afd$area_km2_afd_tot), scientific = TRUE, digits = 2), "km²"),
       caption = "Note : we consider non-marine PAs reported by the WDPA on the full period covered by the data, in countries that are potential AFD partners.\nThese are low-, lower-middle, upper-middle countries according to the World Bank 2022 classification, \nexcluding Russia and including Uruguay, Panama, Chile, New Caledonia.\nA subset of these PAs is AFD funded, though some PAs funded by the AFD are not reported by the WDPA.",
         x = "",
         y = "Share of protected areas (%)") %>%
+ scale_fill_brewer(name = "", labels = c("AFD funded", "Low- to upper-middle income*"),
                    type = "seq", palette = "Blues") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 0,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain', hjust = 0))
hist_distrib_ctry_afd_top_area


## For top AFD, comparison with WDPA in terms of numbers
hist_distrib_ctry_vs_n = ggplot(filter(data_distrib_ctry_vs_n, grepl("freq", metric)),
                                  aes(x = reorder(iso3, value), y = value, fill = metric)) %>%
+ geom_bar(position="dodge", stat="identity", na.rm = TRUE) %>%
+ labs(title = "Top countries targeted by AFD funded non-marine protected areas (#)",
       subtitle = paste("Sample :", min(data_distrib_ctry_wdpa$n_tot_wdpa), "non-marine protected areas reported by the WDPA,",  min(data_distrib_ctry_afd$n_tot_afd), "funded by AFD"),
       caption = "Note : we consider non-marine PAs reported by the WDPA on the full period covered by the data, in countries that are potential AFD partners.\n*These are low-, lower-middle, upper-middle countries according to the World Bank 2022 classification, \nexcluding Russia and including Uruguay, Panama, Chile, New Caledonia.\nA subset of these PAs is AFD funded, though some PAs funded by the AFD are not reported by the WDPA.",
         x = "",
         y = "Share of protected areas (%)") %>%
+ scale_fill_brewer(name = "", labels = c("AFD funded", "Low- to upper-middle income*"),
                    type = "seq", palette = "Blues") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 0,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain', hjust = 0))
hist_distrib_ctry_vs_n 

## For top AFD, comparison with WDPA in terms of area
hist_distrib_ctry_vs_area = ggplot(filter(data_distrib_ctry_vs_area, grepl("freq", metric)),
                                  aes(x = reorder(iso3, value), y = value, fill = metric)) %>%
+ geom_bar(position="dodge", stat="identity", na.rm = TRUE) %>%
+ labs(title = "Top countries targeted by AFD funded non-marine protected areas (area)",
       subtitle = paste("Sample :", min(data_distrib_ctry_wdpa$n_tot_wdpa), "non-marine protected areas reported by the the WDPA,",  min(data_distrib_ctry_afd$n_tot_afd), "funded by AFD"),
       caption = "Note : we consider non-marine PAs reported by the WDPA on the full period covered by the data, in countries that are potential AFD partners.\n*These are low-, lower-middle, upper-middle countries according to the World Bank 2022 classification, \nexcluding Russia and including Uruguay, Panama, Chile, New Caledonia.\nA subset of these PAs is AFD funded, though some PAs funded by the AFD are not reported by the WDPA.",
         x = "",
         y = "Share of funded areas (%)") %>%
+ scale_fill_brewer(name = "", labels = c("AFD funded", "Low- to upper-middle income*"),
                    type = "seq", palette = "Blues") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 0,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain', hjust = 0))
hist_distrib_ctry_vs_area


```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

ggsave(paste(tmp, "hist_distrib_ctry_wdpa_top_n.png", sep = "/"),
       plot = hist_distrib_ctry_wdpa_top_n,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "hist_distrib_ctry_wdpa_top_area.png", sep = "/"),
       plot = hist_distrib_ctry_wdpa_top_area,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "hist_distrib_ctry_afd_top_n.png", sep = "/"),
       plot = hist_distrib_ctry_afd_top_n,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "hist_distrib_ctry_afd_top_area.png", sep = "/"),
       plot = hist_distrib_ctry_afd_top_area,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "hist_distrib_ctry_vs_n.png", sep = "/"),
       plot = hist_distrib_ctry_vs_n,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "hist_distrib_ctry_vs_area.png", sep = "/"),
       plot = hist_distrib_ctry_vs_area,
       device = "png",
       height = 6, width = 9)
#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/descriptive_stats/distribution/wdpa_vs_afd/no_marine", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

#### Statistics at region level (all)

All PAs across the world.

```{r, eval = FALSE}
#Surface and number of PAs by country
data_distrib_reg = data_stat_nodupl %>%
  group_by(region) %>%
  summarize(n = n(),
            area_km2 = sum(area_km2, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(n_tot = sum(n, na.rm = TRUE),
         area_tot_km2 = sum(area_km2, na.rm = TRUE),
         freq_n = round(n/n_tot*100, 2),
         freq_area = round(area_km2/area_tot_km2*100, 2)) %>%
  pivot_longer(cols = c("n", "freq_n", "area_km2", "freq_area"),
               names_to = "metric") %>%
  filter(is.na(region) == FALSE)


#Histogram for all countries
#Histogram in number
hist_distrib_reg_n_shr = ggplot(filter(data_distrib_reg, metric == "freq_n"), 
                     aes(x = reorder(region, -value), y = value, fill = region)) %>%
+ geom_bar(width = 0.50, fill= "#3182BD", stat="identity") %>%
# + geom_text(aes(label = n, y = n), 
#         vjust = -0.1, color="black",
#         size=3) %>%
+ labs(title = "Distribution of protected areas by region (#)",
       subtitle = paste("Sample :", sum(filter(data_distrib_reg, metric == "n")$value), "protected areas covering", format(sum(filter(data_distrib_reg, metric == "area_km2")$value), digits = 2, scientific = TRUE), "km²"),
         x = "",
         y = "Share of protected areas (%)") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
hist_distrib_reg_n_shr

# Histogram in surfaces
hist_distrib_reg_area_shr = ggplot(filter(data_distrib_reg, metric == "freq_area"), 
                     aes(x = reorder(region, -value), y = value, fill = region)) %>%
+ geom_bar(width = 0.50, fill= "#3182BD", stat="identity") %>%
# + geom_text(aes(label = n, y = n), 
#         vjust = -0.1, color="black",
#         size=3) %>%
+ labs(title = "Distribution of protected areas by region (area)",
       subtitle = paste("Sample :", sum(filter(data_distrib_reg, metric == "n")$value), "protected areas covering", format(sum(filter(data_distrib_reg, metric == "area_km2")$value), digits = 2, scientific = TRUE), "km²"),
         x = "",
         y = "Share of areas funded (%)") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
hist_distrib_reg_area_shr

## Both
hist_distrib_reg_top_both_shr = ggplot(filter(data_distrib_reg, metric %in% c("freq_area", "freq_n")), 
                     aes(x = reorder(region, -value), y = value, fill = metric)) %>%
+ geom_bar(position="dodge", stat="identity") %>%
# + geom_text(aes(label = paste(value, "PAs"), y = value), 
#         vjust = -0.1, color="black",
#         size=3.5) %>%
+ labs(title = "Distribution of AFD funded protected areas by region",
       subtitle = paste("Sample :", sum(filter(data_distrib_reg, metric == "n")$value), "protected areas covering", format(sum(filter(data_distrib_reg, metric == "area_km2")$value), digits = 2, scientific = TRUE), "km²"),
         x = "",
         y = "Share of protected areas (%)") %>%
+ scale_fill_brewer(name = "", labels = c("Area", "Number"),
                    type = "seq", palette = "Blues") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
hist_distrib_reg_top_both_shr
```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

ggsave(paste(tmp, "hist_distrib_reg_n_shr.png", sep = "/"),
       plot = hist_distrib_reg_n_shr,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "hist_distrib_reg_area_shr.png", sep = "/"),
       plot = hist_distrib_reg_area_shr,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "hist_distrib_reg_top_both_shr.png", sep = "/"),
       plot = hist_distrib_reg_top_both_shr,
       device = "png",
       height = 6, width = 9)

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/descriptive_stats/distribution/world/all", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

#### Statistics at region level (non-marine)

```{r, eval = FALSE}

#Surface and number of PAs by country
data_distrib_reg = data_stat_nodupl %>%
  filter(marine %in% c(0,1)) %>%
  group_by(region) %>%
  summarize(n = n(),
            area_km2 = sum(area_km2, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(n_tot = sum(n, na.rm = TRUE),
         area_tot_km2 = sum(area_km2, na.rm = TRUE),
         freq_n = round(n/n_tot*100, 2),
         freq_area = round(area_km2/area_tot_km2*100, 2)) %>%
  pivot_longer(cols = c("n", "freq_n", "area_km2", "freq_area"),
               names_to = "metric") %>%
  filter(is.na(region) == FALSE)


#Histogram for all countries
#Histogram in number
hist_distrib_reg_n_shr = ggplot(filter(data_distrib_reg, metric == "freq_n"), 
                     aes(x = reorder(region, -value), y = value, fill = region)) %>%
+ geom_bar(width = 0.50, fill= "#3182BD", stat="identity") %>%
# + geom_text(aes(label = n, y = n), 
#         vjust = -0.1, color="black",
#         size=3) %>%
+ labs(title = "Distribution of AFD funded, non-marine protected areas by region (#)",
       subtitle = paste("Sample :", sum(filter(data_distrib_reg, metric == "n")$value), "non-marine protected areas covering", format(sum(filter(data_distrib_reg, metric == "area_km2")$value), digits = 2, scientific = TRUE), "km²"),
         x = "",
         y = "Share of protected areas (%)") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
hist_distrib_reg_n_shr

# Histogram in surfaces
hist_distrib_reg_area_shr = ggplot(filter(data_distrib_reg, metric == "freq_area"), 
                     aes(x = reorder(region, -value), y = value, fill = region)) %>%
+ geom_bar(width = 0.50, fill= "#3182BD", stat="identity") %>%
# + geom_text(aes(label = n, y = n), 
#         vjust = -0.1, color="black",
#         size=3) %>%
+ labs(title = "Distribution of AFD funded, non-marine protected areas by region (area)",
       subtitle = paste("Sample :", sum(filter(data_distrib_reg, metric == "n")$value), "non-marine protected areas covering", format(sum(filter(data_distrib_reg, metric == "area_km2")$value), digits = 2, scientific = TRUE), "km²"),
         x = "",
         y = "Share of areas funded (%)") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
hist_distrib_reg_area_shr

## Both
hist_distrib_reg_top_both_shr = ggplot(filter(data_distrib_reg, metric %in% c("freq_area", "freq_n")), 
                     aes(x = reorder(region, -value), y = value, fill = metric)) %>%
+ geom_bar(position="dodge", stat="identity") %>%
# + geom_text(aes(label = paste(value, "PAs"), y = value), 
#         vjust = -0.1, color="black",
#         size=3.5) %>%
+ labs(title = "Distribution of AFD funded, non-marine protected areas by region",
       subtitle = paste("Sample :", sum(filter(data_distrib_reg, metric == "n")$value), "non-marine protected areas covering", format(sum(filter(data_distrib_reg, metric == "area_km2")$value), digits = 2, scientific = TRUE), "km²"),
         x = "",
         y = "Share of protected areas (%)") %>%
+ scale_fill_brewer(name = "", labels = c("Area", "Number"),
                    type = "seq", palette = "Blues") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
hist_distrib_reg_top_both_shr

#test
hist_distrib_reg_top_both_shr <- ggplot(filter(data_distrib_reg, metric %in% c("freq_area", "freq_n")), 
                                        aes(x = reorder(region, -value), y = value, fill = metric)) +
  geom_bar(position="dodge", stat="identity") +
  geom_text(aes(label = ifelse(value < 0.5, paste0(value, "%"), "")), 
            position = position_dodge(width = 0.9), vjust = -0.3, color = "black", size = 3.5) + # Ajouter des annotations pour les valeurs faibles
  labs(title = "Distribution of AFD funded, non-marine protected areas by region",
       subtitle = paste("Sample :", sum(filter(data_distrib_reg, metric == "n")$value), "non-marine protected areas covering", 
                        format(sum(filter(data_distrib_reg, metric == "area_km2")$value), digits = 2, scientific = TRUE), "km²"),
       x = "",
       y = "Share of protected areas (%)") +
  scale_fill_manual(name = "", labels = c("Area", "Number"),
                    values = c("freq_area" = "#F9429E", "freq_n" = "#660099")) + # Utiliser des couleurs spécifiques
  theme(legend.position = "bottom",
        legend.key = element_rect(fill = "white"),
        plot.title = element_text(size = 14, face = "bold"), 
        axis.text.x = element_text(angle = 45, size = 10, hjust = .5, vjust = .6),
        axis.title.x = element_text(margin = margin(t = 10)),
        panel.background = element_rect(fill = 'white', colour = 'white', 
                                        linewidth = 0.5, linetype = 'solid'),
        panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
        panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
        plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))

hist_distrib_reg_top_both_shr
```







```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

ggsave(paste(tmp, "hist_distrib_reg_n_shr.png", sep = "/"),
       plot = hist_distrib_reg_n_shr,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "hist_distrib_reg_area_shr.png", sep = "/"),
       plot = hist_distrib_reg_area_shr,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "hist_distrib_reg_top_both_shr.png", sep = "/"),
       plot = hist_distrib_reg_top_both_shr,
       device = "png",
       height = 6, width = 9)

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/descriptive_stats/distribution/world/no_marine", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

#### Statistics at region level (non-marine, WDPA vs AFD)

Distribution of PAs funded by the AFD across regions, is compared to the distribution of the full WDPA database. Note the comparison in terms of number instead of percentage is irrelevant. Indeed WDPA reports around 3e5 PAs, and about 100 are AFD funded.

```{r, eval = FALSE}
#For AFD funded PAs
##Distribution across countries (all)
data_distrib_reg_afd = data_stat_nodupl %>%
  filter(marine %in% c(0,1)) %>%
  group_by(region) %>%
  summarize(n_afd = n(),
            area_km2_afd = sum(area_km2, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(n_tot_afd = sum(n_afd),
         area_km2_afd_tot = sum(area_km2_afd, na.rm = TRUE),
         freq_n_afd = round(n_afd/n_tot_afd*100, 2),
         freq_area_afd = round(area_km2_afd/area_km2_afd_tot*100, 2))

#For WDPA PAs
## All countries
data_distrib_reg_wdpa = data_wdpa %>%
  #Non-marine areas only
  filter(marine %in% c(0,1)) %>%
  #Countries of interest only
  filter(iso3 %in% lst_ctry_stat_wdpa) %>%
  group_by(region) %>%
  summarize(n_wdpa = n(),
            area_km2_wdpa = sum(rep_area, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(n_tot_wdpa = sum(n_wdpa),
         area_km2_wdpa_tot = sum(area_km2_wdpa, na.rm = TRUE),
         freq_n_wdpa = round(n_wdpa/n_tot_wdpa*100, 2),
         freq_area_wdpa = round(area_km2_wdpa/area_km2_wdpa_tot*100, 2))

#Then create a plotting dataset with WDPA vs AFD distribution
##the distribution for top targeted countries by AFD
### in terms of numbers
data_distrib_reg_vs_n = data_distrib_reg_wdpa %>%
  left_join(data_distrib_reg_afd, by = "region") %>%
  select(-contains("area")) %>%
  pivot_longer(cols = c("n_afd", "freq_n_afd", "n_wdpa", "freq_n_wdpa"),
               names_to = "metric") %>%
  filter(is.na(region) == FALSE)
 ###in terms of areas
data_distrib_reg_vs_area = data_distrib_reg_wdpa %>%
  left_join(data_distrib_reg_afd, by = "region") %>%
  select(-contains("n_")) %>%
  pivot_longer(cols = c("area_km2_afd", "freq_area_afd", "area_km2_wdpa", "freq_area_wdpa"),
               names_to = "metric") %>%
  filter(is.na(region) == FALSE)

## For top AFD, comparison with WDPA in terms of numbers
hist_distrib_reg_vs_n = ggplot(filter(data_distrib_reg_vs_n, grepl("freq", metric)),
                                  aes(x = reorder(region, value), y = value, fill = metric)) %>%
+ geom_bar(position="dodge", stat="identity", na.rm = TRUE) %>%
+ labs(title = "Distribution of non-marine protected areas across regions (#)",
       subtitle = paste("Sample :", min(data_distrib_reg_wdpa$n_tot_wdpa), "non-marine protected areas reported by the WDPA,",  min(data_distrib_reg_afd$n_tot_afd), "funded by AFD"),
       caption = "Note : we consider non-marine PAs reported by the WDPA on the full period covered by the data, in countries that are potential AFD partners.\n*These are low-, lower-middle, upper-middle countries according to the World Bank 2022 classification, \nexcluding Russia and including Uruguay, Panama, Chile, New Caledonia.\nA subset of these PAs is AFD funded, though some PAs funded by the AFD are not reported by the WDPA.",
         x = "",
         y = "Share of protected areas (%)") %>%
+ scale_fill_brewer(name = "", labels = c("AFD funded", "Low- to upper-middle income*"),
                    type = "seq", palette = "Blues") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 0,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain', hjust = 0))
hist_distrib_reg_vs_n 

## For top AFD, comparison with WDPA in terms of area
hist_distrib_reg_vs_area = ggplot(filter(data_distrib_reg_vs_area, grepl("freq", metric)),
                                  aes(x = reorder(region, value), y = value, fill = metric)) %>%
+ geom_bar(position="dodge", stat="identity", na.rm = TRUE) %>%
+ labs(title = "Distribution of non-marine protected areas across regions (area)",
       subtitle = paste("Sample :", min(data_distrib_reg_wdpa$n_tot_wdpa), "non-marine protected areas reported by the WDPA -", format(min(data_distrib_reg_wdpa$area_km2_wdpa_tot), scientific = TRUE, digits = 2), "km² - \nand",  min(data_distrib_reg_afd$n_tot_afd), "funded by AFD -", format(min(data_distrib_reg_afd$area_km2_afd_tot) , scientific = TRUE, digits = 2), "km² -"),
       caption = "Note : we consider non-marine PAs reported by the WDPA on the full period covered by the data, in countries that are potential AFD partners.\n*These are low-, lower-middle, upper-middle countries according to the World Bank 2022 classification, \nexcluding Russia and including Uruguay, Panama, Chile, New Caledonia.\nA subset of these PAs is AFD funded, though some PAs funded by the AFD are not reported by the WDPA.",
         x = "",
         y = "Share of areas (%)") %>%
+ scale_fill_brewer(name = "", labels = c("AFD funded", "Low- to upper-middle income*"),
                    type = "seq", palette = "Blues") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 0,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain', hjust = 0))
hist_distrib_reg_vs_area
```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

ggsave(paste(tmp, "hist_distrib_reg_vs_area.png", sep = "/"),
       plot = hist_distrib_reg_vs_area,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "hist_distrib_reg_vs_n.png", sep = "/"),
       plot = hist_distrib_reg_vs_n,
       device = "png",
       height = 6, width = 9)

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/descriptive_stats/distribution/wdpa_vs_afd/no_marine", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))

```

### Surface of PAs

Statistics on PAs surfaces in the different regions and countries.

#### Distribution of surfaces

```{r, eval = FALSE}

tbl_distrib_area_no0 = summary(
  filter(data_stat_nodupl, area_km2 != 0)$area_km2) %>%
  format(scientific = FALSE, big.mark = " ") %>%
  as.array() %>%
  t() %>%
  as.data.frame() %>%
  dplyr::select(-c("1st Qu.","3rd Qu."))


```

#### Average surface in countries and regions

```{r, eval = FALSE}
#Distribution of PA WITH SURFACE >0 across countries and regions
##Country
data_distrib_no0_ctry = data_stat_nodupl %>%
  filter(area_km2 != 0) %>%
  group_by(iso3, country_en, country_fr) %>%
  summarize(n = n(),
            freq = round(n/nrow(data_stat_nodupl), 1)*100) %>%
  ungroup()

##Region
data_distrib_no0_region = data_stat_nodupl %>%
  filter(area_km2 != 0) %>%
  group_by(region) %>%
  summarize(n = n(),
            freq = round(n/nrow(data_stat_nodupl), 1)*100) %>%
  ungroup()

#By country..
##French
tbl_area_avg_ctry_fr = data_distrib_no0_ctry %>%
  dplyr::select(-freq) %>%
  left_join(pa_area_ctry, by = "iso3") %>%
  dplyr::select(-c(iso3, area_tot_km2, tot_area_int)) %>%
  mutate(area_avg_noint_km2 = format(area_tot_noint_km2/n, big.mark = " ", scientific = FALSE, digits = 1),
         area_tot_noint_km2 = format(area_tot_noint_km2, big.mark  = " ", scientific = FALSE, digits = 1),
         )
names(tbl_area_avg_ctry_fr) = c("Pays", "Nombre d'AP", "Superficie totale (km2)", "Superficie moyenne (km2)")
##English
tbl_area_avg_ctry_en = data_distrib_no0_ctry %>%
  dplyr::select(-freq) %>%
  left_join(pa_area_ctry, by = "iso3") %>%
  dplyr::select(-c(iso3, area_tot_km2, tot_area_int)) %>%
  mutate(area_avg_noint_km2 = format(area_tot_noint_km2/n, big.mark = " ", scientific = FALSE, digits = 1),
         area_tot_noint_km2 = format(area_tot_noint_km2, big.mark  = " ", scientific = FALSE, digits = 1),
         )
names(tbl_area_avg_ctry_en) = c("Country", "Number of PAs", "Total area (km2)", "Average area (km2)")

#By region
##French
tbl_area_avg_region_fr = data_distrib_no0_region %>%
  dplyr::select(-freq) %>%
  left_join(pa_area_region, by = "region") %>%
  dplyr::select(-c(area_tot_km2, tot_area_int, region)) %>%
  mutate(area_avg_noint_km2 = format(area_tot_noint_km2/n, big.mark = " ", scientific = FALSE, digits = 1),
         area_tot_noint_km2 = format(area_tot_noint_km2, big.mark  = " ", scientific = FALSE, digits = 1),
         )
names(tbl_area_avg_region_fr) = c("Région", "Nombre d'AP", "Superficie totale (km2)", "Superficie moyenne (km2)")
##English
tbl_area_avg_region_en = data_distrib_no0_region %>%
  dplyr::select(-freq) %>%
  left_join(pa_area_region, by = "region") %>%
  dplyr::select(-c(area_tot_km2, tot_area_int, region)) %>%
  mutate(area_avg_noint_km2 = format(area_tot_noint_km2/n, big.mark = " ", scientific = FALSE, digits = 1),
         area_tot_noint_km2 = format(area_tot_noint_km2, big.mark  = " ", scientific = FALSE, digits = 1),
         )
names(tbl_area_avg_region_en) = c("Rgion", "Number of PAs", "Total area (km2)", "Average area (km2)")

```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

print(xtable(tbl_distrib_area_no0, type = "latex"), 
      file = paste(tmp, "tbl_distrib_area_no0.tex", sep = "/"))
print(xtable(tbl_area_avg_ctry_fr, type = "latex"), 
      file = paste(tmp, "tbl_area_avg_ctry_fr.tex", sep = "/"))
print(xtable(tbl_area_avg_ctry_en, type = "latex"), 
      file = paste(tmp, "tbl_area_avg_ctry_en.tex", sep = "/"))
print(xtable(tbl_area_avg_region_fr, type = "latex"), 
      file = paste(tmp, "tbl_area_avg_region_fr.tex", sep = "/"))
print(xtable(tbl_area_avg_region_en, type = "latex"), 
      file = paste(tmp, "tbl_area_avg_region_en.tex", sep = "/"))

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/descriptive_stats/surface/world", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

### Temporal evolution

#### Number of PAs (world, all)

```{r, eval = FALSE}

data_time_range = data.frame(year = 
                              c(min(data_stat_nodupl$year_funding_first, na.rm = TRUE):max(data_stat_nodupl$year_funding_first, na.rm = TRUE))
)


data_time_n = data_stat_nodupl %>%
  #filter(is.na(year_funding_first) == FALSE) %>%
  group_by(year_funding_first) %>%
  summarize(n = n()) %>%
  full_join(data_time_range, by = c("year_funding_first" = "year")) %>%
  mutate(n = case_when(is.na(n)~0, TRUE~n)) %>%
  arrange(year_funding_first) %>%
  mutate(n_cum = cumsum(n)) 

#Number of PAs funded by year 
#French
fig_n_pa_fr = ggplot(subset(data_time_n, is.na(year_funding_first) == FALSE),
                  aes(x = factor(year_funding_first), y = n)) %>%
  + geom_bar(stat = 'identity', fill = "#3182BD") %>% 
  # + geom_text(aes(y = n, label = ifelse(n == 0, NA, n)), 
  #             color = "black", size=4, vjust = -0.3) %>%
  + labs(title = "Nombre d'aires protégées appuyées par année par l'AFD",
         subtitle = paste("Echantillon :", sum(subset(data_time_n, is.na(year_funding_first) == FALSE)$n), "aires protégées"),
         caption = paste("Sur les", sum(data_time_n$n), "aires protégées financées recensées,", sum(subset(data_time_n, is.na(year_funding_first) == TRUE)$n, na.rm = TRUE), "ont une date de financement inconnue."),
         x = "Année",
         y = "Nombre d'aires protégées") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain', hjust = 0))
fig_n_pa_fr
#English
fig_n_pa_en = ggplot(subset(data_time_n, is.na(year_funding_first) == FALSE),
                  aes(x = factor(year_funding_first), y = n)) %>%
  + geom_bar(stat = 'identity', fill = "#3182BD") %>% 
  # + geom_text(aes(y = n, label = ifelse(n == 0, NA, n)), 
  #             color = "black", size=4, vjust = -0.3) %>%
  + labs(title = "Number of protected areas funded each year by AFD",
       subtitle = paste("Sample :", sum(subset(data_time_n, is.na(year_funding_first) == FALSE)$n), "protected areas"),
       caption = paste("Out of", sum(data_time_n$n), "known funded protected areas,", sum(subset(data_time_n, is.na(year_funding_first) == TRUE)$n, na.rm = TRUE), "have unknown funding year."),
       x = "Year",
       y = "Number of protected areas") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain', hjust = 0))
fig_n_pa_en


#Cumulative number over time
#French
fig_ncum_pa_fr = ggplot(subset(data_time_n, is.na(year_funding_first) == FALSE),
                  aes(x = factor(year_funding_first), y = n_cum)) %>%
  # + geom_point(color = "#3182BD", size = 1.5) %>%
  # + geom_line(color = "#3182BD", size = 1) %>% 
  + geom_bar(stat = 'identity', fill = "#3182BD") %>%
  + geom_text(aes(y = n_cum, label = n_cum), 
              color = "black", size=3, vjust = -0.3) %>%
  + labs(title = "Evolution cumulée du nombre d'aires protégées appuyées par l'AFD",
         subtitle = paste("Echantillon :", sum(subset(data_time_n, is.na(year_funding_first) == FALSE)$n), "aires protégées"),
         caption = paste("Sur les", sum(data_time_n$n), "aires protégées financées recensées,", sum(subset(data_time_n, is.na(year_funding_first) == TRUE)$n, na.rm = TRUE), "ont une date de financement inconnue."),
         x = "Année",
         y = "Nombre d'aires protégées") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain', hjust = 0))
fig_ncum_pa_fr
#English
fig_ncum_pa_en = ggplot(subset(data_time_n, is.na(year_funding_first) == FALSE),
                  aes(x = factor(year_funding_first), y = n_cum)) %>%
  # + geom_point(color = "#3182BD", size = 1.5) %>%
  # + geom_line(color = "#3182BD", size = 1) %>% 
  + geom_bar(stat = 'identity', fill = "#3182BD") %>%
  + geom_text(aes(y = n_cum, label = n_cum), 
              color = "black", size=3, vjust = -0.3) %>%
  + labs(title = "Cumulative number of protected areas funded by AFD",
         subtitle = paste("Sample :", sum(subset(data_time_n, is.na(year_funding_first) == FALSE)$n), "protected areas"),
       caption = paste("Out of", sum(data_time_n$n), "known funded protected areas,", sum(subset(data_time_n, is.na(year_funding_first) == TRUE)$n, na.rm = TRUE), "have unknown funding year."),
         x = "Year",
         y = "Number of protected areas") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain', hjust = 0))
fig_ncum_pa_en


```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

ggsave(paste(tmp, "fig_n_pa_fr.png", sep = "/"),
       fig_n_pa_fr,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "fig_n_pa_en.png", sep = "/"),
       fig_n_pa_en,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "fig_ncum_pa_fr.png", sep = "/"),
       fig_ncum_pa_fr,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "fig_ncum_pa_en.png", sep = "/"),
       fig_ncum_pa_en,
       device = "png",
       height = 6, width = 9)



#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/descriptive_stats/time_evolution/world/all", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

#### Number of PAs (world, non-marine)

```{r, eval = FALSE}

data_time_range = data.frame(year = 
                              c(min(data_stat_nodupl$year_funding_first, na.rm = TRUE):max(data_stat_nodupl$year_funding_first, na.rm = TRUE))
)


data_time_n = data_stat_nodupl %>%
  filter(marine %in% c(0,1)) %>%
  #filter(is.na(year_funding_first) == FALSE) %>%
  group_by(year_funding_first) %>%
  summarize(n = n()) %>%
  full_join(data_time_range, by = c("year_funding_first" = "year")) %>%
  mutate(n = case_when(is.na(n)~0, TRUE~n)) %>%
  arrange(year_funding_first) %>%
  mutate(n_cum = cumsum(n)) 

#Number of PAs funded by year 
#French
fig_n_pa_fr = ggplot(subset(data_time_n, is.na(year_funding_first) == FALSE),
                  aes(x = factor(year_funding_first), y = n)) %>%
  + geom_bar(stat = 'identity', fill = "#3182BD") %>% 
  # + geom_text(aes(y = n, label = ifelse(n == 0, NA, n)), 
  #             color = "black", size=4, vjust = -0.3) %>%
  + labs(title = "Nombre d'aires protégées non-marines appuyées par année par l'AFD",
         subtitle = paste("Echantillon :", sum(subset(data_time_n, is.na(year_funding_first) == FALSE)$n), "aires protégées"),
         caption = paste("Sur les", sum(data_time_n$n), "aires protégées non-marines financées recensées,", sum(subset(data_time_n, is.na(year_funding_first) == TRUE)$n, na.rm = TRUE), "ont une date de financement inconnue."),
         x = "Année",
         y = "Nombre d'aires protégées") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain', hjust = 0))
fig_n_pa_fr
#English
fig_n_pa_en = ggplot(subset(data_time_n, is.na(year_funding_first) == FALSE),
                  aes(x = factor(year_funding_first), y = n)) %>%
  + geom_bar(stat = 'identity', fill = "#3182BD") %>% 
  # + geom_text(aes(y = n, label = ifelse(n == 0, NA, n)), 
  #             color = "black", size=4, vjust = -0.3) %>%
  + labs(title = "Number of non-marine protected areas funded each year by AFD",
         subtitle = paste("Sample :", sum(subset(data_time_n, is.na(year_funding_first) == FALSE)$n), "protected areas"),
       caption = paste("Out of", sum(data_time_n$n), "known, non-marine funded protected areas,", sum(subset(data_time_n, is.na(year_funding_first) == TRUE)$n, na.rm = TRUE), "have unknown funding year."),
         x = "Year",
         y = "Number of protected areas") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain', hjust = 0))
fig_n_pa_en


#Cumulative number over time
#French
fig_ncum_pa_fr = ggplot(subset(data_time_n, is.na(year_funding_first) == FALSE),
                  aes(x = factor(year_funding_first), y = n_cum)) %>%
  # + geom_point(color = "#3182BD", size = 1.5) %>%
  # + geom_line(color = "#3182BD", size = 1) %>% 
  + geom_bar(stat = 'identity', fill = "#3182BD") %>%
  + geom_text(aes(y = n_cum, label = n_cum), 
              color = "black", size=3, vjust = -0.3) %>%
  + labs(title = "Evolution cumulée du nombre d'aires protégées non-marines appuyées par l'AFD",
         subtitle = paste("Echantillon :", sum(subset(data_time_n, is.na(year_funding_first) == FALSE)$n), "aires protégées"),
         caption = paste("Sur les", sum(data_time_n$n), "aires protégées non-marines financées recensées,", sum(subset(data_time_n, is.na(year_funding_first) == TRUE)$n, na.rm = TRUE), "ont une date de financement inconnue."),
         x = "Année",
         y = "Nombre d'aires protégées") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain', hjust = 0))
fig_ncum_pa_fr
#English
fig_ncum_pa_en = ggplot(subset(data_time_n, is.na(year_funding_first) == FALSE),
                  aes(x = factor(year_funding_first), y = n_cum)) %>%
  # + geom_point(color = "#3182BD", size = 1.5) %>%
  # + geom_line(color = "#3182BD", size = 1) %>% 
  + geom_bar(stat = 'identity', fill = "#3182BD") %>%
  + geom_text(aes(y = n_cum, label = n_cum), 
              color = "black", size=3, vjust = -0.3) %>%
  + labs(title = "Cumulative number of non-marine protected areas funded by AFD",
         subtitle = paste("Sample :", sum(subset(data_time_n, is.na(year_funding_first) == FALSE)$n), "protected areas"),
       caption = paste("Out of", sum(data_time_n$n), "known, non-marine funded protected areas,", sum(subset(data_time_n, is.na(year_funding_first) == TRUE)$n, na.rm = TRUE), "have unknown funding year."),
         x = "Year",
         y = "Number of protected areas") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain', hjust = 0))
fig_ncum_pa_en


```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

ggsave(paste(tmp, "fig_n_pa_fr.png", sep = "/"),
       fig_n_pa_fr,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "fig_n_pa_en.png", sep = "/"),
       fig_n_pa_en,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "fig_ncum_pa_fr.png", sep = "/"),
       fig_ncum_pa_fr,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "fig_ncum_pa_en.png", sep = "/"),
       fig_ncum_pa_en,
       device = "png",
       height = 6, width = 9)



#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/descriptive_stats/time_evolution/world/no_marine", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

#### Number of PAs (region, non-marine)

```{r, eval = FALSE}

roi = "Africa"

data_time_range = data.frame(year = 
                              c(min(data_stat_nodupl$year_funding_first, na.rm = TRUE):max(data_stat_nodupl$year_funding_first, na.rm = TRUE))
)


data_time_n = data_stat_nodupl %>%
  filter(region == roi & marine %in% c(0,1)) %>%
  #filter(is.na(year_funding_first) == FALSE) %>%
  group_by(year_funding_first) %>%
  summarize(n = n()) %>%
  full_join(data_time_range, by = c("year_funding_first" = "year")) %>%
  mutate(n = case_when(is.na(n)~0, TRUE~n)) %>%
  arrange(year_funding_first) %>%
  mutate(n_cum = cumsum(n)) 

#Number of PAs funded by year 
#French
fig_n_pa_fr = ggplot(subset(data_time_n, is.na(year_funding_first) == FALSE),
                  aes(x = factor(year_funding_first), y = n)) %>%
  + geom_bar(stat = 'identity', fill = "#3182BD") %>% 
  # + geom_text(aes(y = n, label = ifelse(n == 0, NA, n)), 
  #             color = "black", size=4, vjust = -0.3) %>%
  + labs(title = paste("Nombre d'aires protégées non-marines appuyées par année par l'AFD,", roi),
         subtitle = paste("Echantillon :", sum(subset(data_time_n, is.na(year_funding_first) == FALSE)$n), "aires protégées"),
         caption = paste("Sur les", sum(data_time_n$n), "aires protégées non-marines financées recensées,", sum(subset(data_time_n, is.na(year_funding_first) == TRUE)$n, na.rm = TRUE), "ont une date de financement inconnue."),
         x = "Année",
         y = "Nombre d'aires protégées") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain', hjust = 0))
fig_n_pa_fr
#English
fig_n_pa_en = ggplot(subset(data_time_n, is.na(year_funding_first) == FALSE),
                  aes(x = factor(year_funding_first), y = n)) %>%
  + geom_bar(stat = 'identity', fill = "#3182BD") %>% 
  # + geom_text(aes(y = n, label = ifelse(n == 0, NA, n)), 
  #             color = "black", size=4, vjust = -0.3) %>%
  + labs(title = paste("Number of non-marine protected areas funded each year by AFD,", roi),
         subtitle = paste("Sample :", sum(subset(data_time_n, is.na(year_funding_first) == FALSE)$n), "protected areas"),
       caption = paste("Out of", sum(data_time_n$n), "known non-marine, funded protected areas,", sum(subset(data_time_n, is.na(year_funding_first) == TRUE)$n, na.rm = TRUE), "have unknown funding year."),
         x = "Year",
         y = "Number of protected areas") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain', hjust = 0))
fig_n_pa_en


#Cumulative number over time
#French
fig_ncum_pa_fr = ggplot(subset(data_time_n, is.na(year_funding_first) == FALSE),
                  aes(x = factor(year_funding_first), y = n_cum)) %>%
  # + geom_point(color = "#3182BD", size = 1.5) %>%
  # + geom_line(color = "#3182BD", size = 1) %>% 
  + geom_bar(stat = 'identity', fill = "#3182BD") %>%
  + geom_text(aes(y = n_cum, label = n_cum), 
              color = "black", size=3, vjust = -0.3) %>%
  + labs(title = paste("Evolution cumulée du nombre d'aires protégées non-marines,", roi),
         subtitle = paste("Echantillon :", sum(subset(data_time_n, is.na(year_funding_first) == FALSE)$n), "aires protégées"),
         caption = paste("Sur les", sum(data_time_n$n), "aires protégées non-marines financées recensées,", sum(subset(data_time_n, is.na(year_funding_first) == TRUE)$n, na.rm = TRUE), "ont une date de financement inconnue."),
         x = "Année",
         y = "Nombre d'aires protégées") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain', hjust = 0))
fig_ncum_pa_fr
#English
fig_ncum_pa_en = ggplot(subset(data_time_n, is.na(year_funding_first) == FALSE),
                  aes(x = factor(year_funding_first), y = n_cum)) %>%
  # + geom_point(color = "#3182BD", size = 1.5) %>%
  # + geom_line(color = "#3182BD", size = 1) %>% 
  + geom_bar(stat = 'identity', fill = "#3182BD") %>%
  + geom_text(aes(y = n_cum, label = n_cum), 
              color = "black", size=3, vjust = -0.3) %>%
  + labs(title = paste("Cumulated number of non-marine protected areas funded by AFD,", roi),
         subtitle = paste("Sample :", sum(subset(data_time_n, is.na(year_funding_first) == FALSE)$n), "protected areas"),
       caption = paste("Out of", sum(data_time_n$n), "known non-marine, funded protected areas,", sum(subset(data_time_n, is.na(year_funding_first) == TRUE)$n, na.rm = TRUE), "have unknown funding year."),
         x = "Year",
         y = "Number of protected areas") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain', hjust = 0))
fig_ncum_pa_en


```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

ggsave(paste(tmp, "fig_n_pa_fr.png", sep = "/"),
       fig_n_pa_fr,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "fig_n_pa_en.png", sep = "/"),
       fig_n_pa_en,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "fig_ncum_pa_fr.png", sep = "/"),
       fig_ncum_pa_fr,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "fig_ncum_pa_en.png", sep = "/"),
       fig_ncum_pa_en,
       device = "png",
       height = 6, width = 9)



#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = paste("projet-afd-eva-ap/descriptive_stats/time_evolution", roi, "no_marine", sep = "/"), 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

#### Surface of PAs (world, all)

```{r, eval = FALSE}
data_time_range = data.frame(year = 
                              c(min(data_stat_nodupl$year_funding_first, na.rm = TRUE):max(data_stat_nodupl$year_funding_first, na.rm = TRUE))
)


data_time_area = data_stat_nodupl %>%
  #filter(is.na(year_funding_first) == FALSE) %>%
  group_by(year_funding_first) %>%
  summarize(tot_area_km2 = sum(area_km2),
            n = n()) %>%
  left_join(pa_int_yr, by = c("year_funding_first" = "annee_int")) %>%
  full_join(data_time_range, by = c("year_funding_first" = "year")) %>%
  mutate(tot_area_km2 = case_when(is.na(tot_area_km2)~0, TRUE~tot_area_km2),
         tot_int_km2 = case_when(is.na(tot_int_km2)~0, TRUE~tot_int_km2),
         tot_area_noint_km2 = tot_area_km2 - tot_int_km2) %>%
  arrange(year_funding_first)

#Evolution of area over time
##French
fig_area_pa_fr = ggplot(subset(data_time_area, is.na(year_funding_first) == FALSE),
                  aes(x = factor(year_funding_first), y = tot_area_noint_km2)) %>%
  + geom_bar(stat = 'identity', fill = "#3182BD") %>%
  + geom_text(aes(y = tot_area_noint_km2, 
                  label = ifelse(tot_area_noint_km2 != 0,
                                 format(tot_area_noint_km2, 
                                        digits = 2, 
                                        scientific = TRUE),
                                 NA)), 
              color = "black", size=2, vjust = -0.3) %>%
  + scale_y_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                  labels = scales::trans_format("log10", scales::math_format(10^.x))) %>%
  + annotation_logticks(base = 10, sides = "l", 
                        color = "grey20", outside = "TRUE",
                        short = unit(.5,"mm"),
                        mid = unit(1,"mm"),
                        long = unit(2,"mm")) %>%
  + coord_cartesian(clip = "off") %>%
  + labs(title = "Evolution de la superficie financée par l'AFD",
         subtitle = paste("Echantillon :", sum(subset(data_time_area, is.na(year_funding_first) == FALSE)$n, na.rm = TRUE), "aires protégées couvrant", format(sum(subset(data_time_area, is.na(year_funding_first) == FALSE)$tot_area_noint_km2), digits = 1, scientific = FALSE, big.mark = " "), "km²"),
         caption = paste0("Sur les ", sum(data_time_area$n, na.rm = TRUE), " aires protégées financées recensées, ", sum(subset(data_time_area, is.na(year_funding_first) == FALSE)$n, na.rm = TRUE), " ont une date de financement connue.\nSoit ", format(sum(subset(data_time_area, is.na(year_funding_first) == FALSE)$tot_area_noint_km2), digits = 1, scientific = FALSE, big.mark = " "), " km² sur ", format(sum(data_time_area$tot_area_noint_km2), digits = 1, scientific = FALSE, big.mark = " "), " km²."),
         x = "Année",
         y = "Superficie (km²)") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain', hjust = 0))
fig_area_pa_fr
##English
fig_area_pa_en = ggplot(subset(data_time_area, is.na(year_funding_first) == FALSE),
                  aes(x = factor(year_funding_first), y = tot_area_noint_km2)) %>%
  + geom_bar(stat = 'identity', fill = "#3182BD") %>%
  + geom_text(aes(y = tot_area_noint_km2, 
                  label = ifelse(tot_area_noint_km2 != 0,
                                 format(tot_area_noint_km2, 
                                        digits = 2, 
                                        scientific = TRUE),
                                 NA)), 
              color = "black", size=2, vjust = -0.3) %>%
  + scale_y_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                  labels = scales::trans_format("log10", scales::math_format(10^.x))) %>%
  + annotation_logticks(base = 10, sides = "l", 
                        color = "grey20", outside = "TRUE",
                        short = unit(.5,"mm"),
                        mid = unit(1,"mm"),
                        long = unit(2,"mm")) %>%
  + coord_cartesian(clip = "off") %>%
  + labs(title = "Evolution of AFD funded area",
         subtitle = paste("Sample :", sum(subset(data_time_area, is.na(year_funding_first) == FALSE)$n, na.rm = TRUE), "protected areas covering", format(sum(subset(data_time_area, is.na(year_funding_first) == FALSE)$tot_area_noint_km2), digits = 1, scientific = FALSE, big.mark = " "), "km²"),
         caption = paste0("Out of ", sum(data_time_area$n, na.rm = TRUE), " known funded protected areas, ", sum(subset(data_time_area, is.na(year_funding_first) == FALSE)$n, na.rm = TRUE), " have a known funding year.\nIn terms of area, ", format(sum(subset(data_time_area, is.na(year_funding_first) == FALSE)$tot_area_noint_km2), digits = 1, scientific = FALSE, big.mark = " "), " km² out of ", format(sum(data_time_area$tot_area_noint_km2), digits = 1, scientific = FALSE, big.mark = " "), " km²."),
         x = "Year",
         y = "Area (km²)") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain', hjust = 0))
fig_area_pa_en



#Cumulative area over time
##French
fig_area_cum_pa_fr = ggplot(subset(data_time_area, is.na(year_funding_first) == FALSE),
                  aes(x = factor(year_funding_first),
                      y = cumsum(tot_area_noint_km2))) %>%
  # + geom_point(color = "#3182BD", size = 1.5) %>%
  # + geom_line(color = "#3182BD", size = 1) %>% 
  + geom_bar(stat = 'identity', fill = "#3182BD") %>%
  + geom_text(aes(y = cumsum(tot_area_noint_km2), 
                  label = format(cumsum(tot_area_noint_km2), 
                                 digits = 2,
                                 scientific = TRUE)), 
              color = "black", size=2, vjust = -0.3) %>%
  + labs(title = "Evolution cumulée de la superficie des aires protégées, financées par l'AFD",
          subtitle = paste("Echantillon :", sum(subset(data_time_area, is.na(year_funding_first) == FALSE)$n, na.rm = TRUE), "aires protégées couvrant", format(sum(subset(data_time_area, is.na(year_funding_first) == FALSE)$tot_area_noint_km2), digits = 1, scientific = FALSE, big.mark = " "), "km²"),
         caption = paste0("Sur les ", sum(data_time_area$n), " aires protégées financées recensées, ", sum(subset(data_time_area, is.na(year_funding_first) == FALSE)$n, na.rm = TRUE), " ont une date de financement connue.\nSoit ", format(sum(subset(data_time_area, is.na(year_funding_first) == FALSE)$tot_area_noint_km2), digits = 1, scientific = FALSE, big.mark = " "), " km² sur ", format(sum(data_time_area$tot_area_noint_km2), digits = 1, scientific = FALSE, big.mark = " "), " km²."),
         x = "Année",
         y = "Superficie (km²)") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain', hjust = 0))
fig_area_cum_pa_fr
#English
fig_area_cum_pa_en = ggplot(subset(data_time_area, is.na(year_funding_first) == FALSE),
                  aes(x = factor(year_funding_first),
                      y = cumsum(tot_area_noint_km2))) %>%
  # + geom_point(color = "#3182BD", size = 1.5) %>%
  # + geom_line(color = "#3182BD", size = 1) %>% 
  + geom_bar(stat = 'identity', fill = "#3182BD") %>%
  + geom_text(aes(y = cumsum(tot_area_noint_km2), 
                  label = format(cumsum(tot_area_noint_km2), 
                                 digits = 2,
                                 scientific = TRUE)), 
              color = "black", size=2, vjust = -0.3) %>%
  + labs(title = "Cumulative evolution of area funded by AFD",
          subtitle = paste("Sample :", sum(subset(data_time_area, is.na(year_funding_first) == FALSE)$n, na.rm = TRUE), "protected areas covering", format(sum(subset(data_time_area, is.na(year_funding_first) == FALSE)$tot_area_noint_km2), digits = 1, scientific = FALSE, big.mark = " "), "km²"),
         caption = paste0("Out of ", sum(data_time_area$n), " known funded protected areas, ", sum(subset(data_time_area, is.na(year_funding_first) == FALSE)$n, na.rm = TRUE), " have a known funding year.\nIn terms of area, ", format(sum(subset(data_time_area, is.na(year_funding_first) == FALSE)$tot_area_noint_km2), digits = 1, scientific = FALSE, big.mark = " "), " km² out of ", format(sum(data_time_area$tot_area_noint_km2), digits = 1, scientific = FALSE, big.mark = " "), " km²."),
         y = "Area (km²)") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain', hjust = 0))
fig_area_cum_pa_en



```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

ggsave(paste(tmp, "fig_area_pa_fr.png", sep = "/"),
       fig_area_pa_fr,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "fig_area_pa_en.png", sep = "/"),
       fig_area_pa_en,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "fig_area_cum_pa_fr.png", sep = "/"),
       fig_area_cum_pa_fr,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "fig_area_cum_pa_en.png", sep = "/"),
       fig_area_cum_pa_en,
       device = "png",
       height = 6, width = 9)

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/descriptive_stats/time_evolution/world/all", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

#### Surface of PAs (world, non-marine)

```{r, eval = FALSE}
data_time_range = data.frame(year = 
                              c(min(data_stat_nodupl$year_funding_first, na.rm = TRUE):max(data_stat_nodupl$year_funding_first, na.rm = TRUE))
)


data_time_area = data_stat_nodupl %>%
  filter(marine %in% c(0,1)) %>%
  #filter(is.na(year_funding_first) == FALSE) %>%
  group_by(year_funding_first) %>%
  summarize(tot_area_km2 = sum(area_km2),
            n = n()) %>%
  left_join(pa_int_yr, by = c("year_funding_first" = "annee_int")) %>%
  full_join(data_time_range, by = c("year_funding_first" = "year")) %>%
  mutate(tot_area_km2 = case_when(is.na(tot_area_km2)~0, TRUE~tot_area_km2),
         tot_int_km2 = case_when(is.na(tot_int_km2)~0, TRUE~tot_int_km2),
         tot_area_noint_km2 = tot_area_km2 - tot_int_km2) %>%
  arrange(year_funding_first)

#Evolution of area over time
##French
fig_area_pa_fr = ggplot(subset(data_time_area, is.na(year_funding_first) == FALSE),
                  aes(x = factor(year_funding_first), y = tot_area_noint_km2)) %>%
  + geom_bar(stat = 'identity', fill = "#3182BD") %>%
  + geom_text(aes(y = tot_area_noint_km2, 
                  label = ifelse(tot_area_noint_km2 != 0,
                                 format(tot_area_noint_km2, 
                                        digits = 2, 
                                        scientific = TRUE),
                                 NA)), 
              color = "black", size=2, vjust = -0.3) %>%
  + scale_y_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                  labels = scales::trans_format("log10", scales::math_format(10^.x))) %>%
  + annotation_logticks(base = 10, sides = "l", 
                        color = "grey20", outside = "TRUE",
                        short = unit(.5,"mm"),
                        mid = unit(1,"mm"),
                        long = unit(2,"mm")) %>%
  + coord_cartesian(clip = "off") %>%
  + labs(title = "Evolution de la superficie non-marine financée par l'AFD",
         subtitle = paste("Echantillon :", sum(subset(data_time_area, is.na(year_funding_first) == FALSE)$n, na.rm = TRUE), "aires protégées couvrant", format(sum(subset(data_time_area, is.na(year_funding_first) == FALSE)$tot_area_noint_km2), digits = 1, scientific = FALSE, big.mark = " "), "km²"),
         caption = paste0("Sur les ", sum(data_time_area$n, na.rm = TRUE), " aires protégées financées recensées, ", sum(subset(data_time_area, is.na(year_funding_first) == FALSE)$n, na.rm = TRUE), " ont une date de financement connue.\nSoit ", format(sum(subset(data_time_area, is.na(year_funding_first) == FALSE)$tot_area_noint_km2), digits = 1, scientific = FALSE, big.mark = " "), " km² sur ", format(sum(data_time_area$tot_area_noint_km2), digits = 1, scientific = FALSE, big.mark = " "), " km²."),
         x = "Année",
         y = "Superficie (km²)") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain', hjust = 0))
fig_area_pa_fr

##English
fig_area_pa_en = ggplot(subset(data_time_area, is.na(year_funding_first) == FALSE),
                  aes(x = factor(year_funding_first), y = tot_area_noint_km2)) %>%
  + geom_bar(stat = 'identity', fill = "#3182BD") %>%
  + geom_text(aes(y = tot_area_noint_km2, 
                  label = ifelse(tot_area_noint_km2 != 0,
                                 format(tot_area_noint_km2, 
                                        digits = 2, 
                                        scientific = TRUE),
                                 NA)), 
              color = "black", size=2, vjust = -0.3) %>%
  + scale_y_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                  labels = scales::trans_format("log10", scales::math_format(10^.x))) %>%
  + annotation_logticks(base = 10, sides = "l", 
                        color = "grey20", outside = "TRUE",
                        short = unit(.5,"mm"),
                        mid = unit(1,"mm"),
                        long = unit(2,"mm")) %>%
  + coord_cartesian(clip = "off") %>%
  + labs(title = "Evolution of AFD funded non-marine protected areas",
         subtitle = paste("Sample :", sum(subset(data_time_area, is.na(year_funding_first) == FALSE)$n, na.rm = TRUE), "protected areas covering", format(sum(subset(data_time_area, is.na(year_funding_first) == FALSE)$tot_area_noint_km2), digits = 1, scientific = FALSE, big.mark = " "), "km²"),
         caption = paste0("Out of ", sum(data_time_area$n, na.rm = TRUE), " known funded protected areas, ", sum(subset(data_time_area, is.na(year_funding_first) == FALSE)$n, na.rm = TRUE), " have a known funding year.\nIn terms of area, ", format(sum(subset(data_time_area, is.na(year_funding_first) == FALSE)$tot_area_noint_km2), digits = 1, scientific = FALSE, big.mark = " "), " km² out of ", format(sum(data_time_area$tot_area_noint_km2), digits = 1, scientific = FALSE, big.mark = " "), " km²."),
         x = "Year",
         y = "Area (km²)") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain', hjust = 0))
fig_area_pa_en



#Cumulative area over time
##French
fig_area_cum_pa_fr = ggplot(subset(data_time_area, is.na(year_funding_first) == FALSE),
                  aes(x = factor(year_funding_first),
                      y = cumsum(tot_area_noint_km2))) %>%
  # + geom_point(color = "#3182BD", size = 1.5) %>%
  # + geom_line(color = "#3182BD", size = 1) %>% 
  + geom_bar(stat = 'identity', fill = "#3182BD") %>%
  + geom_text(aes(y = cumsum(tot_area_noint_km2), 
                  label = format(cumsum(tot_area_noint_km2), 
                                 digits = 2,
                                 scientific = TRUE)), 
              color = "black", size=2, vjust = -0.3) %>%
  + labs(title = "Evolution cumulée de la superficie des aires protégées non-marines, financées par l'AFD",
          subtitle = paste("Echantillon :", sum(subset(data_time_area, is.na(year_funding_first) == FALSE)$n, na.rm = TRUE), "aires protégées couvrant", format(sum(subset(data_time_area, is.na(year_funding_first) == FALSE)$tot_area_noint_km2), digits = 1, scientific = FALSE, big.mark = " "), "km²"),
         caption = paste0("Sur les ", sum(data_time_area$n, na.rm = TRUE), " aires protégées financées recensées, ", sum(subset(data_time_area, is.na(year_funding_first) == FALSE)$n, na.rm = TRUE), " ont une date de financement connue.\nSoit ", format(sum(subset(data_time_area, is.na(year_funding_first) == FALSE)$tot_area_noint_km2), digits = 1, scientific = FALSE, big.mark = " "), " km² sur ", format(sum(data_time_area$tot_area_noint_km2), digits = 1, scientific = FALSE, big.mark = " "), " km²."),
         x = "Année",
         y = "Superficie (km²)") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain', hjust = 0))
fig_area_cum_pa_fr

#English
fig_area_cum_pa_en = ggplot(subset(data_time_area, is.na(year_funding_first) == FALSE),
                  aes(x = factor(year_funding_first),
                      y = cumsum(tot_area_noint_km2))) %>%
  # + geom_point(color = "#3182BD", size = 1.5) %>%
  # + geom_line(color = "#3182BD", size = 1) %>% 
  + geom_bar(stat = 'identity', fill = "#3182BD") %>%
  + geom_text(aes(y = cumsum(tot_area_noint_km2), 
                  label = format(cumsum(tot_area_noint_km2), 
                                 digits = 2,
                                 scientific = TRUE)), 
              color = "black", size=2, vjust = -0.3) %>%
  + labs(title = "Cumulated evolution of non-marine protected areas funded by AFD",
          subtitle = paste("Sample :", sum(subset(data_time_area, is.na(year_funding_first) == FALSE)$n, na.rm = TRUE), "protected areas covering", format(sum(subset(data_time_area, is.na(year_funding_first) == FALSE)$tot_area_noint_km2), digits = 1, scientific = FALSE, big.mark = " "), "km²"),
         caption = paste0("Out of ", sum(data_time_area$n, na.rm = TRUE), " known funded protected areas, ", sum(subset(data_time_area, is.na(year_funding_first) == FALSE)$n, na.rm = TRUE), " have a known funding year.\nIn terms of area, ", format(sum(subset(data_time_area, is.na(year_funding_first) == FALSE)$tot_area_noint_km2), digits = 1, scientific = FALSE, big.mark = " "), " km² out of ", format(sum(data_time_area$tot_area_noint_km2), digits = 1, scientific = FALSE, big.mark = " "), " km²."),
         x = "Year",
         y = "Area (km²)") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain', hjust = 0))
fig_area_cum_pa_en
```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

ggsave(paste(tmp, "fig_area_pa_fr.png", sep = "/"),
       fig_area_pa_fr,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "fig_area_pa_en.png", sep = "/"),
       fig_area_pa_en,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "fig_area_cum_pa_fr.png", sep = "/"),
       fig_area_cum_pa_fr,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "fig_area_cum_pa_en.png", sep = "/"),
       fig_area_cum_pa_en,
       device = "png",
       height = 6, width = 9)

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/descriptive_stats/time_evolution/world/no_marine", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

#### Surface of PAs (region, non-marine)

```{r, eval = FALSE}

roi = "Africa"

data_time_range = data.frame(year = 
                              c(min(data_stat_nodupl$year_funding_first, na.rm = TRUE):max(data_stat_nodupl$year_funding_first, na.rm = TRUE))
)


data_time_area = data_stat_nodupl %>%
  filter(region == roi & marine %in% c(0,1)) %>%
  #filter(is.na(year_funding_first) == FALSE) %>%
  group_by(year_funding_first) %>%
  summarize(tot_area_km2 = sum(area_km2),
            n = n()) %>%
  left_join(pa_int_yr, by = c("year_funding_first" = "annee_int")) %>%
  full_join(data_time_range, by = c("year_funding_first" = "year")) %>%
  mutate(tot_area_km2 = case_when(is.na(tot_area_km2)~0, TRUE~tot_area_km2),
         tot_int_km2 = case_when(is.na(tot_int_km2)~0, TRUE~tot_int_km2),
         tot_area_noint_km2 = tot_area_km2 - tot_int_km2) %>%
  arrange(year_funding_first)

#Evolution of area over time
##French
fig_area_pa_fr = ggplot(subset(data_time_area, is.na(year_funding_first) == FALSE),
                  aes(x = factor(year_funding_first), y = tot_area_noint_km2)) %>%
  + geom_bar(stat = 'identity', fill = "#3182BD") %>%
  + geom_text(aes(y = tot_area_noint_km2, 
                  label = ifelse(tot_area_noint_km2 != 0,
                                 format(tot_area_noint_km2, 
                                        digits = 2, 
                                        scientific = TRUE),
                                 NA)), 
              color = "black", size=2, vjust = -0.3) %>%
  + scale_y_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                  labels = scales::trans_format("log10", scales::math_format(10^.x))) %>%
  + annotation_logticks(base = 10, sides = "l", 
                        color = "grey20", outside = "TRUE",
                        short = unit(.5,"mm"),
                        mid = unit(1,"mm"),
                        long = unit(2,"mm")) %>%
  + coord_cartesian(clip = "off") %>%
  + labs(title = paste("Evolution de la superficie non-marine financée par l'AFD,", roi), 
         subtitle = paste("Echantillon :", sum(subset(data_time_area, is.na(year_funding_first) == FALSE)$n, na.rm = TRUE), "aires protégées couvrant", format(sum(subset(data_time_area, is.na(year_funding_first) == FALSE)$tot_area_noint_km2), digits = 1, scientific = FALSE, big.mark = " "), "km²"),
         caption = paste0("Sur les ", sum(data_time_area$n, na.rm = TRUE), " aires protégées financées recensées, ", sum(subset(data_time_area, is.na(year_funding_first) == FALSE)$n, na.rm = TRUE), " ont une date de financement connue.\nSoit ", format(sum(subset(data_time_area, is.na(year_funding_first) == FALSE)$tot_area_noint_km2), digits = 1, scientific = FALSE, big.mark = " "), " km² sur ", format(sum(data_time_area$tot_area_noint_km2), digits = 1, scientific = FALSE, big.mark = " "), " km²."),
         x = "Année",
         y = "Superficie (km²)") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain', hjust = 0))
fig_area_pa_fr
##English
fig_area_pa_en = ggplot(subset(data_time_area, is.na(year_funding_first) == FALSE),
                  aes(x = factor(year_funding_first), y = tot_area_noint_km2)) %>%
  + geom_bar(stat = 'identity', fill = "#3182BD") %>%
  + geom_text(aes(y = tot_area_noint_km2, 
                  label = ifelse(tot_area_noint_km2 != 0,
                                 format(tot_area_noint_km2, 
                                        digits = 2, 
                                        scientific = TRUE),
                                 NA)), 
              color = "black", size=2, vjust = -0.3) %>%
  + scale_y_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                  labels = scales::trans_format("log10", scales::math_format(10^.x))) %>%
  + annotation_logticks(base = 10, sides = "l", 
                        color = "grey20", outside = "TRUE",
                        short = unit(.5,"mm"),
                        mid = unit(1,"mm"),
                        long = unit(2,"mm")) %>%
  + coord_cartesian(clip = "off") %>%
  + labs(title = paste("Evolution of AFD funded non-marine protected areas,", roi),
         subtitle = paste("Sample :", sum(subset(data_time_area, is.na(year_funding_first) == FALSE)$n, na.rm = TRUE), "protected areas covering", format(sum(subset(data_time_area, is.na(year_funding_first) == FALSE)$tot_area_noint_km2), digits = 1, scientific = FALSE, big.mark = " "), "km²"),
         caption = paste0("Out of ", sum(data_time_area$n, na.rm = TRUE), " known funded protected areas, ", sum(subset(data_time_area, is.na(year_funding_first) == FALSE)$n, na.rm = TRUE), " have a known funding year.\nIn terms of area, ", format(sum(subset(data_time_area, is.na(year_funding_first) == FALSE)$tot_area_noint_km2), digits = 1, scientific = FALSE, big.mark = " "), " km² out of ", format(sum(data_time_area$tot_area_noint_km2), digits = 1, scientific = FALSE, big.mark = " "), " km²."),
         x = "Year",
         y = "Area (km²)") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain', hjust = 0))
fig_area_pa_en



#Cumulative area over time
##French
fig_area_cum_pa_fr = ggplot(subset(data_time_area, is.na(year_funding_first) == FALSE),
                  aes(x = factor(year_funding_first),
                      y = cumsum(tot_area_noint_km2))) %>%
  # + geom_point(color = "#3182BD", size = 1.5) %>%
  # + geom_line(color = "#3182BD", size = 1) %>% 
  + geom_bar(stat = 'identity', fill = "#3182BD") %>%
  + geom_text(aes(y = cumsum(tot_area_noint_km2), 
                  label = format(cumsum(tot_area_noint_km2), 
                                 digits = 2,
                                 scientific = TRUE)), 
              color = "black", size=2, vjust = -0.3) %>%
  + labs(title = paste("Evolution cumulée de la superficie des aires protégées non-marines financées par l'AFD\n", roi),
          subtitle = paste("Echantillon :", sum(subset(data_time_area, is.na(year_funding_first) == FALSE)$n, na.rm = TRUE), "aires protégées couvrant", format(sum(subset(data_time_area, is.na(year_funding_first) == FALSE)$tot_area_noint_km2), digits = 1, scientific = FALSE, big.mark = " "), "km²"),
         caption = paste0("Sur les ", sum(data_time_area$n, na.rm = TRUE), " aires protégées financées recensées, ", sum(subset(data_time_area, is.na(year_funding_first) == FALSE)$n, na.rm = TRUE), " ont une date de financement connue.\nSoit ", format(sum(subset(data_time_area, is.na(year_funding_first) == FALSE)$tot_area_noint_km2), digits = 1, scientific = FALSE, big.mark = " "), " km² sur ", format(sum(data_time_area$tot_area_noint_km2), digits = 1, scientific = FALSE, big.mark = " "), " km²."),
         x = "Année",
         y = "Superficie (km²)") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain', hjust = 0))
fig_area_cum_pa_fr
#English
fig_area_cum_pa_en = ggplot(subset(data_time_area, is.na(year_funding_first) == FALSE),
                  aes(x = factor(year_funding_first),
                      y = cumsum(tot_area_noint_km2))) %>%
  # + geom_point(color = "#3182BD", size = 1.5) %>%
  # + geom_line(color = "#3182BD", size = 1) %>% 
  + geom_bar(stat = 'identity', fill = "#3182BD") %>%
  + geom_text(aes(y = cumsum(tot_area_noint_km2), 
                  label = format(cumsum(tot_area_noint_km2), 
                                 digits = 2,
                                 scientific = TRUE)), 
              color = "black", size=2, vjust = -0.3) %>%
  + labs(title = paste("Cumulated evolution of non-marine protected areas funded by AFD,", roi),
          subtitle = paste("Sample :", sum(subset(data_time_area, is.na(year_funding_first) == FALSE)$n, na.rm = TRUE), "protected areas covering", format(sum(subset(data_time_area, is.na(year_funding_first) == FALSE)$tot_area_noint_km2), digits = 1, scientific = FALSE, big.mark = " "), "km²"),
         caption = paste0("Out of ", sum(data_time_area$n, na.rm = TRUE), " known funded protected areas, ", sum(subset(data_time_area, is.na(year_funding_first) == FALSE)$n, na.rm = TRUE), " have a known funding year.\nIn terms of area, ", format(sum(subset(data_time_area, is.na(year_funding_first) == FALSE)$tot_area_noint_km2), digits = 1, scientific = FALSE, big.mark = " "), " km² out of ", format(sum(data_time_area$tot_area_noint_km2), digits = 1, scientific = FALSE, big.mark = " "), " km²."),
         x = "Year",
         y = "Area (km²)") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain', hjust = 0))
fig_area_cum_pa_en
```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

ggsave(paste(tmp, "fig_area_pa_fr.png", sep = "/"),
       fig_area_pa_fr,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "fig_area_pa_en.png", sep = "/"),
       fig_area_pa_en,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "fig_area_cum_pa_fr.png", sep = "/"),
       fig_area_cum_pa_fr,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "fig_area_cum_pa_en.png", sep = "/"),
       fig_area_cum_pa_en,
       device = "png",
       height = 6, width = 9)

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = paste("projet-afd-eva-ap/descriptive_stats/time_evolution", roi, "no_marine", sep = "/"), 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

### Governance

#### World, all

```{r, eval = FALSE}

#Table of the governance type distribution
##English version
data_gov_en = data_stat_nodupl %>%
  mutate(gov_type = case_when(is.na(gov_type) == TRUE ~ "Not referenced",
                              TRUE ~ gov_type)) %>%
  group_by(gov_type) %>%
  summarize(n = n()) %>%
  mutate(n_tot = sum(n),
         freq = round(n/n_tot*100,1)) %>%
  select(-n_tot) %>%
  arrange(-freq)

tbl_gov_en = data_gov_en
names(tbl_gov_en) = c("Governance","Number of PAs","Share of PAs (%)")


##French Version
data_gov_fr = data_stat_nodupl %>%
  mutate(gov_type = case_when(is.na(gov_type) == TRUE ~ "Non référencée",
                              gov_type == "Collaborative governance" ~ "Gouvernance collaborative",
                              gov_type == "Federal or national ministry or agency" ~ "Ministère ou agence, fédérale ou nationale",
                              gov_type == "Federal or national ministry or agency" ~ "Ministère ou agence, fédérale ou nationale",
                              gov_type == "Government-delegated management" ~ "Gestion déléguée par le gouvernement",
                              gov_type == "Indigenous peoples" ~ "Peuples indigènes",
                              gov_type == "Joint governance" ~ "Gouvernance conjointe",
                              gov_type == "Local communities" ~ "Communautés locales",
                              gov_type == "Non-profit organisations" ~ "Organisations non-lucratives",
                              gov_type == "Not Reported" ~ "Non rapportée",
                              gov_type == "Sub-national ministry or agency" ~ "Ministère ou agence sous-nationale",
                              TRUE ~ gov_type)) %>%
  group_by(gov_type) %>%
  summarize(n = n()) %>%
  mutate(n_tot = sum(n),
         freq = round(n/n_tot*100,1)) %>%
  select(-n_tot) %>%
  arrange(-freq)

tbl_gov_fr = data_gov_fr
names(tbl_gov_fr) = c("Gouvernance","Nombre d'AP","Proportion (%)")



#PAs with nureported or unreferenced governance types are removed
##Tables
###English
data_gov_knwn_en = data_stat_nodupl %>%
  mutate(gov_type = case_when(is.na(gov_type) == TRUE ~ "Not referenced",
                              TRUE ~ gov_type)) %>%
  filter(gov_type != "Not Reported" & gov_type != "Not referenced") %>%
  group_by(gov_type) %>%
  summarize(n = n()) %>%
  mutate(n_tot = sum(n),
         freq = round(n/n_tot*100,1)) %>%
  select(-n_tot) %>%
  arrange(-freq)

tbl_gov_knwn_en = data_gov_knwn_en
names(tbl_gov_knwn_en) = c("Governance","Number of PAs","Share of PAs (%)")

###French
data_gov_knwn_fr = data_stat_nodupl %>%
  mutate(gov_type = case_when(is.na(gov_type) == TRUE ~ "Non référencée",
                              gov_type == "Collaborative governance" ~ "Gouvernance collaborative",
                              gov_type == "Federal or national ministry or agency" ~ "Ministère ou agence, fédérale ou nationale",
                              gov_type == "Federal or national ministry or agency" ~ "Ministère ou agence, fédérale ou nationale",
                              gov_type == "Government-delegated management" ~ "Gestion déléguée par le gouvernement",
                              gov_type == "Indigenous peoples" ~ "Peuples indigènes",
                              gov_type == "Joint governance" ~ "Gouvernance conjointe",
                              gov_type == "Local communities" ~ "Communautés locales",
                              gov_type == "Non-profit organisations" ~ "Organisations non-lucratives",
                              gov_type == "Not Reported" ~ "Non rapportée",
                              gov_type == "Sub-national ministry or agency" ~ "Ministère ou agence sous-nationale",
                              TRUE ~ gov_type)) %>%
  filter(gov_type != "Non référencée" & gov_type != "Non rapportée") %>%
  group_by(gov_type) %>%
  summarize(n = n()) %>%
  mutate(n_tot = sum(n),
         freq = round(n/n_tot*100,1)) %>%
  select(-n_tot) %>%
  arrange(-freq)

tbl_gov_knwn_fr = data_gov_knwn_fr
names(tbl_gov_knwn_fr) = c("Gouvernance","Nombre d'AP","Proportion (%)")
 

##Pie charts
###English
pie_gov_knwn_en = 
  ggplot(data_gov_knwn_en, 
       aes(x="", y= freq, fill= gov_type)) %>%
  + geom_bar(width = 1, stat = "identity", color="white") %>%
  + geom_label(aes(x=1.3, 
                   label = paste0(format(freq, digits = 2), "%")), 
               color = "black", 
               position = position_stack(vjust = 0.55), 
               size=2.5, show.legend = FALSE) %>%
  + coord_polar("y", start=0) %>%
  + labs(title = "Governance type of protected areas except not referenced/reported",
         subtitle = paste("Sample :", sum(data_gov_knwn_en$n), "protected areas")) %>%
  + scale_fill_brewer(name = "Governance", palette="Paired") %>%
  + theme_void()
pie_gov_knwn_en


###French
pie_gov_knwn_fr =
  ggplot(data_gov_knwn_fr, 
       aes(x="", y= freq, fill= gov_type)) %>%
  + geom_bar(width = 1, stat = "identity", color="white") %>%
  + geom_label(aes(x=1.3, 
                   label = paste0(format(freq, digits = 2), "%")), 
               color = "black", 
               position = position_stack(vjust = 0.55), 
               size=2.5, show.legend = FALSE) %>%
  + coord_polar("y", start=0) %>%
  + labs(title = "Gouvernance, hors non-rapportées/référencées",
         subtitle = paste("Echantillon :", sum(data_gov_knwn_fr$n), "aires protégées" )) %>%
  + scale_fill_brewer(name = "Gouvernance", palette="Paired") %>%
  + theme_void()
pie_gov_knwn_fr

```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

print(xtable(tbl_gov_en,
             caption = "Governance of protected areas funded by AFD",
             type = "latex"),
      file = paste(tmp, "tbl_gov_en.tex", sep  ="/"))
print(xtable(tbl_gov_fr,
             caption = "Gouvernance des aires protégées appuyées par l'AFD",
             type = "latex"),
      file = paste(tmp, "tbl_gov_fr.tex", sep  ="/"))
print(xtable(tbl_gov_knwn_en, 
             caption = "Governance of protected areas funded by AFD (when known)",
             type = "latex"),
      file = paste(tmp, "tbl_gov_knwn_en.tex", sep  ="/"))
print(xtable(tbl_gov_knwn_fr, 
             caption = "Gouvernance des aires protégées appuyées par l'AFD (si connu)",
             type = "latex"),
      file = paste(tmp, "tbl_gov_knwn_fr.tex", sep  ="/"))

ggsave(paste(tmp, " pie_gov_knwn_en.png", sep = "/"),
       plot =  pie_gov_knwn_en,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "pie_gov_knwn_fr.png", sep = "/"),
       plot = pie_gov_knwn_fr,
       device = "png",
       height = 6, width = 9)

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/descriptive_stats/gouvernance/world/all", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

#### World, non-marine

```{r, eval = FALSE}

#Table of the governance type distribution
##English version
data_gov_en = data_stat_nodupl %>%
  filter(marine %in% c(0,1)) %>%
  mutate(gov_type = case_when(is.na(gov_type) == TRUE ~ "Not referenced",
                              TRUE ~ gov_type)) %>%
  group_by(gov_type) %>%
  summarize(n = n()) %>%
  mutate(n_tot = sum(n),
         freq = round(n/n_tot*100,1)) %>%
  select(-n_tot) %>%
  arrange(-freq)

tbl_gov_en = data_gov_en
names(tbl_gov_en) = c("Governance","Number of PAs","Share of PAs (%)")


##French Version
data_gov_fr = data_stat_nodupl %>%
  filter(marine %in% c(0,1)) %>%
  mutate(gov_type = case_when(is.na(gov_type) == TRUE ~ "Non référencée",
                              gov_type == "Collaborative governance" ~ "Gouvernance collaborative",
                              gov_type == "Federal or national ministry or agency" ~ "Ministère ou agence, fédérale ou nationale",
                              gov_type == "Federal or national ministry or agency" ~ "Ministère ou agence, fédérale ou nationale",
                              gov_type == "Government-delegated management" ~ "Gestion déléguée par le gouvernement",
                              gov_type == "Indigenous peoples" ~ "Peuples indigènes",
                              gov_type == "Joint governance" ~ "Gouvernance conjointe",
                              gov_type == "Local communities" ~ "Communautés locales",
                              gov_type == "Non-profit organisations" ~ "Organisations non-lucratives",
                              gov_type == "Not Reported" ~ "Non rapportée",
                              gov_type == "Sub-national ministry or agency" ~ "Ministère ou agence sous-nationale",
                              TRUE ~ gov_type)) %>%
  group_by(gov_type) %>%
  summarize(n = n()) %>%
  mutate(n_tot = sum(n),
         freq = round(n/n_tot*100,1)) %>%
  select(-n_tot) %>%
  arrange(-freq)

tbl_gov_fr = data_gov_fr
names(tbl_gov_fr) = c("Gouvernance","Nombre d'AP","Proportion (%)")



#PAs with nureported or unreferenced governance types are removed
##Tables
###English
data_gov_knwn_en = data_stat_nodupl %>%
  filter(marine %in% c(0,1)) %>%
  mutate(gov_type = case_when(is.na(gov_type) == TRUE ~ "Not referenced",
                              TRUE ~ gov_type)) %>%
  filter(gov_type != "Not Reported" & gov_type != "Not referenced") %>%
  group_by(gov_type) %>%
  summarize(n = n()) %>%
  mutate(n_tot = sum(n),
         freq = round(n/n_tot*100,1)) %>%
  select(-n_tot) %>%
  arrange(-freq)

tbl_gov_knwn_en = data_gov_knwn_en
names(tbl_gov_knwn_en) = c("Governance","Number of PAs","Share of PAs (%)")

###French
data_gov_knwn_fr = data_stat_nodupl %>%
  filter(marine %in% c(0,1)) %>%
  mutate(gov_type = case_when(is.na(gov_type) == TRUE ~ "Non référencée",
                              gov_type == "Collaborative governance" ~ "Gouvernance collaborative",
                              gov_type == "Federal or national ministry or agency" ~ "Ministère ou agence, fédérale ou nationale",
                              gov_type == "Federal or national ministry or agency" ~ "Ministère ou agence, fédérale ou nationale",
                              gov_type == "Government-delegated management" ~ "Gestion déléguée par le gouvernement",
                              gov_type == "Indigenous peoples" ~ "Peuples indigènes",
                              gov_type == "Joint governance" ~ "Gouvernance conjointe",
                              gov_type == "Local communities" ~ "Communautés locales",
                              gov_type == "Non-profit organisations" ~ "Organisations non-lucratives",
                              gov_type == "Not Reported" ~ "Non rapportée",
                              gov_type == "Sub-national ministry or agency" ~ "Ministère ou agence sous-nationale",
                              TRUE ~ gov_type)) %>%
  filter(gov_type != "Non référencée" & gov_type != "Non rapportée") %>%
  group_by(gov_type) %>%
  summarize(n = n()) %>%
  mutate(n_tot = sum(n),
         freq = round(n/n_tot*100,1)) %>%
  select(-n_tot) %>%
  arrange(-freq)

tbl_gov_knwn_fr = data_gov_knwn_fr
names(tbl_gov_knwn_fr) = c("Gouvernance","Nombre d'AP","Proportion (%)")
 

##Pie charts
###English
pie_gov_knwn_en = 
  ggplot(data_gov_knwn_en, 
       aes(x="", y= freq, fill= gov_type)) %>%
  + geom_bar(width = 1, stat = "identity", color="white") %>%
  + geom_label(aes(x=1.3, 
                   label = paste0(format(freq, digits = 2), "%")), 
               color = "black", 
               position = position_stack(vjust = 0.55), 
               size=2.5, show.legend = FALSE) %>%
  + coord_polar("y", start=0) %>%
  + labs(title = "Governance type of non-marine protected areas except not referenced/reported",
         subtitle = paste("Sample :", sum(data_gov_knwn_en$n), "non-marines protected areas")) %>%
  + scale_fill_brewer(name = "Governance", palette="Paired") %>%
  + theme_void()
pie_gov_knwn_en


###French
pie_gov_knwn_fr =
  ggplot(data_gov_knwn_fr, 
       aes(x="", y= freq, fill= gov_type)) %>%
  + geom_bar(width = 1, stat = "identity", color="white") %>%
  + geom_label(aes(x=1.3, 
                   label = paste0(format(freq, digits = 2), "%")), 
               color = "black", 
               position = position_stack(vjust = 0.55), 
               size=2.5, show.legend = FALSE) %>%
  + coord_polar("y", start=0) %>%
  + labs(title = "Gouvernance des aires protégées non-marines hors non-rapportées/référencées",
         subtitle = paste("Echantillon :", sum(data_gov_knwn_fr$n), "aires protégées non-marines")) %>%
  + scale_fill_brewer(name = "Gouvernance", palette="Paired") %>%
  + theme_void()
pie_gov_knwn_fr


```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

print(xtable(tbl_gov_en,
             caption = "Governance of non-marine protected areas funded by AFD",
             type = "latex"),
      file = paste(tmp, "tbl_gov_en.tex", sep  ="/"))
print(xtable(tbl_gov_fr,
             caption = "Gouvernance des aires protégées non-marines appuyées par l'AFD",
             type = "latex"),
      file = paste(tmp, "tbl_gov_fr.tex", sep  ="/"))
print(xtable(tbl_gov_knwn_en, 
             caption = "Governance of non-marine protected areas funded by AFD (when known)",
             type = "latex"),
      file = paste(tmp, "tbl_gov_knwn_en.tex", sep  ="/"))
print(xtable(tbl_gov_knwn_fr, 
             caption = "Gouvernance des aires protégées non-marines appuyées par l'AFD (si connu)",
             type = "latex"),
      file = paste(tmp, "tbl_gov_knwn_fr.tex", sep  ="/"))


ggsave(paste(tmp, "pie_gov_knwn_en.png", sep = "/"),
       plot =  pie_gov_knwn_en,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "pie_gov_knwn_fr.png", sep = "/"),
       plot = pie_gov_knwn_fr,
       device = "png",
       height = 6, width = 9)

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/descriptive_stats/gouvernance/world/no_marine", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))

```

#### Region, non-marine

```{r, eval = FALSE}

roi = "Africa"

#Table of the governance type distribution
##English version
data_gov_en = data_stat_nodupl %>%
  filter(region == roi & marine %in% c(0,1)) %>%
  mutate(gov_type = case_when(is.na(gov_type) == TRUE ~ "Not referenced",
                              TRUE ~ gov_type)) %>%
  group_by(gov_type) %>%
  summarize(n = n()) %>%
  mutate(n_tot = sum(n),
         freq = round(n/n_tot*100,1)) %>%
  select(-n_tot) %>%
  arrange(-freq)

tbl_gov_en = data_gov_en
names(tbl_gov_en) = c("Governance","Number of PAs","Share of PAs (%)")


##French Version
data_gov_fr = data_stat_nodupl %>%
  filter(region == roi & marine %in% c(0,1)) %>%
  mutate(gov_type = case_when(is.na(gov_type) == TRUE ~ "Non référencée",
                              gov_type == "Collaborative governance" ~ "Gouvernance collaborative",
                              gov_type == "Federal or national ministry or agency" ~ "Ministère ou agence, fédérale ou nationale",
                              gov_type == "Federal or national ministry or agency" ~ "Ministère ou agence, fédérale ou nationale",
                              gov_type == "Government-delegated management" ~ "Gestion déléguée par le gouvernement",
                              gov_type == "Indigenous peoples" ~ "Peuples indigènes",
                              gov_type == "Joint governance" ~ "Gouvernance conjointe",
                              gov_type == "Local communities" ~ "Communautés locales",
                              gov_type == "Non-profit organisations" ~ "Organisations non-lucratives",
                              gov_type == "Not Reported" ~ "Non rapportée",
                              gov_type == "Sub-national ministry or agency" ~ "Ministère ou agence sous-nationale",
                              TRUE ~ gov_type)) %>%
  group_by(gov_type) %>%
  summarize(n = n()) %>%
  mutate(n_tot = sum(n),
         freq = round(n/n_tot*100,1)) %>%
  select(-n_tot) %>%
  arrange(-freq)

tbl_gov_fr = data_gov_fr
names(tbl_gov_fr) = c("Gouvernance","Nombre d'AP","Proportion (%)")



#PAs with unreported or unreferenced governance types are removed
##Tables
###English
data_gov_knwn_en = data_stat_nodupl %>%
  filter(region == roi & marine %in% c(0,1)) %>%
  mutate(gov_type = case_when(is.na(gov_type) == TRUE ~ "Not referenced",
                              TRUE ~ gov_type)) %>%
  filter(gov_type != "Not Reported" & gov_type != "Not referenced") %>%
  group_by(gov_type) %>%
  summarize(n = n()) %>%
  mutate(n_tot = sum(n),
         freq = round(n/n_tot*100,1)) %>%
  select(-n_tot) %>%
  arrange(-freq)

tbl_gov_knwn_en = data_gov_knwn_en
names(tbl_gov_knwn_en) = c("Governance","Number of PAs","Share of PAs (%)")

###French
data_gov_knwn_fr = data_stat_nodupl %>%
  filter(region == roi & marine %in% c(0,1)) %>%
  mutate(gov_type = case_when(is.na(gov_type) == TRUE ~ "Non référencée",
                              gov_type == "Collaborative governance" ~ "Gouvernance collaborative",
                              gov_type == "Federal or national ministry or agency" ~ "Ministère ou agence, fédérale ou nationale",
                              gov_type == "Federal or national ministry or agency" ~ "Ministère ou agence, fédérale ou nationale",
                              gov_type == "Government-delegated management" ~ "Gestion déléguée par le gouvernement",
                              gov_type == "Indigenous peoples" ~ "Peuples indigènes",
                              gov_type == "Joint governance" ~ "Gouvernance conjointe",
                              gov_type == "Local communities" ~ "Communautés locales",
                              gov_type == "Non-profit organisations" ~ "Organisations non-lucratives",
                              gov_type == "Not Reported" ~ "Non rapportée",
                              gov_type == "Sub-national ministry or agency" ~ "Ministère ou agence sous-nationale",
                              TRUE ~ gov_type)) %>%
  filter(gov_type != "Non référencée" & gov_type != "Non rapportée") %>%
  group_by(gov_type) %>%
  summarize(n = n()) %>%
  mutate(n_tot = sum(n),
         freq = round(n/n_tot*100,1)) %>%
  select(-n_tot) %>%
  arrange(-freq)

tbl_gov_knwn_fr = data_gov_knwn_fr
names(tbl_gov_knwn_fr) = c("Gouvernance","Nombre d'AP","Proportion (%)")
 

##Pie charts
###English
pie_gov_knwn_en = 
  ggplot(data_gov_knwn_en, 
       aes(x="", y= freq, fill= gov_type)) %>%
  + geom_bar(width = 1, stat = "identity", color="white") %>%
  + geom_label(aes(x=1.3, 
                   label = paste0(format(freq, digits = 2), "%")), 
               color = "black", 
               position = position_stack(vjust = 0.55), 
               size=2.5, show.legend = FALSE) %>%
  + coord_polar("y", start=0) %>%
  + labs(title = paste0("Governance type of non-marine protected areas except not referenced/reported\n", roi),
         subtitle = paste("Sample :", sum(data_gov_knwn_en$n), "non-marine protected areas")) %>%
  + scale_fill_brewer(name = "Governance", palette="Paired") %>%
  + theme_void()
pie_gov_knwn_en


###French
pie_gov_knwn_fr =
  ggplot(data_gov_knwn_fr, 
       aes(x="", y= freq, fill= gov_type)) %>%
  + geom_bar(width = 1, stat = "identity", color="white") %>%
  + geom_label(aes(x=1.3, 
                   label = paste0(format(freq, digits = 2), "%")), 
               color = "black", 
               position = position_stack(vjust = 0.55), 
               size=2.5, show.legend = FALSE) %>%
  + coord_polar("y", start=0) %>%
  + labs(title = paste0("Gouvernance des aires protégées non-marines hors non-rapportées/référencées\n", roi),
         subtitle = paste("Echantillon :", sum(data_gov_knwn_fr$n), "aires protégées")) %>%
  + scale_fill_brewer(name = "Gouvernance", palette="Paired") %>%
  + theme_void()
pie_gov_knwn_fr


```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

print(xtable(tbl_gov_en,
             caption = paste("Governance of non-marine protected areas funded by AFD,", roi),
             type = "latex"),
      file = paste(tmp, "tbl_gov_en.tex", sep  ="/"))
print(xtable(tbl_gov_fr,
             caption = paste("Gouvernance des aires protégées non-marines appuyées par l'AFD,", roi),
             type = "latex"),
      file = paste(tmp, "tbl_gov_fr.tex", sep  ="/"))
print(xtable(tbl_gov_knwn_en, 
             caption = paste("Governance of non-marine protected areas funded by AFD,", roi, "(when known)"),
             type = "latex"),
      file = paste(tmp, "tbl_gov_knwn_en.tex", sep  ="/"))
print(xtable(tbl_gov_knwn_fr, 
             caption = paste("Gouvernance des aires protégées non-marines appuyées par l'AFD,", roi, "(si connu)"),
             type = "latex"),
      file = paste(tmp, "tbl_gov_knwn_fr.tex", sep  ="/"))

ggsave(paste(tmp, "pie_gov_knwn_en.png", sep = "/"),
       plot =  pie_gov_knwn_en,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "pie_gov_knwn_fr.png", sep = "/"),
       plot = pie_gov_knwn_fr,
       device = "png",
       height = 6, width = 9)

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = paste("projet-afd-eva-ap/descriptive_stats/gouvernance" , roi, "no_marine", sep = "/"), 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

### Map of PA 

<!-- #### Map of portfolio in Africa -->

```{r }

install.packages("rnaturalearth")
library(rnaturalearth)
# Load the polygon data of protected areas from AWS S3 bucket
data_afd <- aws.s3::s3read_using(
  sf::st_read,
  object = "data_tidy/BDD_PA_AFD_nofund_shp.geojson",
  bucket = "projet-afd-eva-ap",
  opts = list("region" = "")
)

data_fapbm = 
  aws.s3::s3read_using(
  sf::st_read,
  object = "data_tidy/BDD_PA_FAPBM.geojson",
  bucket = "projet-afd-eva-ap",
  opts = list("region" = ""))

data_fapbm_map=data_fapbm %>% dplyr::select("name","geometry","wdpaid","region","iso3","marine") # for the GIE chapter we are adding FAPBM PAs
data_map= data_afd %>% dplyr::select("name_pa","geometry","wdpaid","region","iso3","marine")%>% dplyr::rename(name=name_pa)

data_map=rbind(data_map,data_fapbm_map)
# Download marine geography data from Natural Earth
marine <- ne_download(type = "geography_marine_polys", category = "physical", scale = 10)

# Set the continent focus
focus <- "Africa"

# filter the PA in the focus region 
data_map_focus=data_map %>% filter(region==focus)

# Load countries boundaries for the specified continent
focus_map <- ne_countries(continent = focus, returnclass = "sf")


```



```{r}
 s3write_using(data_map,
                    sf::st_write,
                    object = "data_raw/data_map_africa/data_map_africa.gpkg",
                    bucket = "projet-afd-eva-ap",
                    opts = list("region" = ""))
```


```{r , echo=FALSE}

# Plot of protected areas in Africa
ggplot() +
   geom_sf(data = focus_map, fill = "antiquewhite", color = "white") +   # Fond de carte
  geom_sf(data = data_map_focus, aes(fill = iso3)) + 
  geom_sf_text(data = focus_map, aes(label = name), size = 2, color = "gray40", check_overlap = TRUE) +  # Noms des pays
  #geom_sf_text(data = marine, aes(label = name), size = 3, color = "gray", check_overlap = TRUE) +  # Noms des mers
  theme(panel.grid.major = element_line(color = gray(.5), linetype = "dashed", size = 0.1), panel.background = element_rect(fill = "grey85"),
        legend.position = c(0.95, 0.13),
        #legend.position= "none"
        legend.text = element_text(size = 6), legend.key.size = unit(0.3, 'cm'),legend.title = element_text(size = 7),
        axis.title = element_blank(), 
        axis.text = element_blank(),  
        axis.ticks = element_blank())+
  coord_sf(xlim = c(-16, 56), ylim = c(-23,33)) +
  labs(fill="Country")

```


```{r}
# Plot with different colors for Ecosystem type (marine,terrestrial, coastal)
ggplot() +
   geom_sf(data = focus_map, fill = "antiquewhite", color = "white") +   # Fond de carte
  geom_sf(data = data_map_focus, aes(fill = marine)) + 
  geom_sf_text(data = focus_map, aes(label = name), size = 2, color = "gray40", check_overlap = TRUE) +  # Noms des pays
  #geom_sf_text(data = marine, aes(label = name), size = 3, color = "gray", check_overlap = TRUE) +  # Noms des mers
  theme(panel.grid.major = element_line(color = gray(.5), linetype = "dashed", size = 0.1), panel.background = element_rect(fill = "grey85"),
        legend.position = c(0.95, 0.13),
        #legend.position= "none"
        legend.text = element_text(size = 6), legend.key.size = unit(0.3, 'cm'),legend.title = element_text(size = 7),
        axis.title = element_blank(), 
        axis.text = element_blank(),  
        axis.ticks = element_blank())+
  coord_sf(xlim = c(-16, 56), ylim = c(-23,33)) +
  labs(fill="Country")

```



```{r , echo=FALSE}
# Zoomed map of West Africa

map_west=ggplot() +
  geom_sf(data = focus_map, fill = "antiquewhite", color = "white") +  # Fond de carte
  
  geom_sf(data = data_map_focus, fill = "chartreuse3", color = "darkgreen") +  # Polygones de zones protégées
#  geom_sf_text(data = marine, aes(label = name), size = 3, color = "gray", check_overlap = TRUE) +  # Noms des mers
  geom_sf_text(data = focus_map, aes(label = name), size = 3, color = "black", check_overlap = TRUE) +  # Noms des pays
  theme(panel.grid.major = element_line(color = gray(.5), linetype = "dashed", size = 0.1), panel.background = element_rect(fill = "aliceblue"))+
  labs(title = "Zones Protégées en Afrique, zoom ouest",
       x = "Longitude",
       y = "Latitude")+
  coord_sf(xlim = c(-17, 16), ylim = c(-2,22)) 
```

```{r}
# Zoomed map of East Africa

ggplot() +
  geom_sf(data = focus_map, fill = "antiquewhite", color = "white") +  # Fond de carte
  geom_sf(data = data_map_focus, fill = "chartreuse3", color = "darkgreen") +  # Polygones de zones protégées
  geom_sf_text(data = africa, aes(label = name), size = 3, color = "black", check_overlap = TRUE) +  # Noms des pays
  theme(panel.grid.major = element_line(color = gray(.5), linetype = "dashed", size = 0.1), panel.background = element_rect(fill = "aliceblue"))+
  labs(title = "Zones Protégées en Afrique, zoom ouest",
       x = "Longitude",
       y = "Latitude")+
  coord_sf(xlim = c(22, 50), ylim = c(-23,9)) 
```

```{r}
# Zoomed map of Madagascar
ggplot() +
  geom_sf(data = focus_map, fill = "white", color = "grey") +  # Fond de carte
  geom_sf(data = data_map_focus, aes(fill = country), aes(color = country)) +  # Polygones de zones protégées
#  geom_sf_text(data = africa, aes(label = name), size = 3, color = "black", check_overlap = TRUE) +  # Noms des pays
  theme(panel.grid.major = element_line(color = gray(.5), linetype = "dashed", size = 0.1), panel.background = element_rect(fill = "aliceblue"))+
  labs(title = "Zones Protégées en Afrique, zoom ouest",
       x = "Longitude",
       y = "Latitude")+
  coord_sf(xlim = c(22, 50), ylim = c(-23,9)) 
```

