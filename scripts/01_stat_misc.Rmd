# Miscellaneous statistics

In this document are performed and plotted statistics for particular needs (analysis of a particular portfolio, some specific group of PAs, etc.)

## Initial settings

Configuring Rmarkdown.

\#`{r setup, include=FALSE, eval = FALSE} #knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file()) #`

```{r, eval = F}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

Installing and importing relevant packages.

```{r message=FALSE, warning=FALSE, eval = FALSE}
install.packages(c("stargazer", "janitor", "questionr", "countrycode", "WDI", "mapme.biodiversity","ggrepel"))
library(tidyverse)
library(stargazer)
library(dplyr)
library(sf)
library(ggplot2)  
library(ggrepel)
library(RColorBrewer)
library(countrycode)
library(data.table)
#library(readxl)
#library(splitstackshape) 
library(janitor)
library(xtable)
library(questionr)
library(aws.s3)
library(WDI)
library(countrycode)
library(mapme.biodiversity)
```

## Importing datasets

A dataset with information for each protected area funded by the AFD, and datasets on aggregated size at country/region/world level and by year. The latter takes into account potential overlap between PAs reported in the World Database on Protected Areas (WDPA).

```{r, eval = FALSE}
#Dataset of AFD supported protected area, with one line per protected area
data_stat_nodupl = 
  #fread("data_tidy/BDD_PA_AFD_nofund_nodupl.csv" , encoding = "UTF-8")
  aws.s3::s3read_using(
  FUN = data.table::fread,
  encoding = "UTF-8",
  # Mettre les options de FUN ici
  object = "data_tidy/BDD_PA_AFD_nofund_nodupl.csv",
  bucket = "projet-afd-eva-ap",
  opts = list("region" = ""))

# Portfolio of protected areas supported by the FAPBM
data_pa_fapbm = 
  #fread("data_tidy/BDD_PA_AFD_ie.csv" , encoding = "UTF-8")
  aws.s3::s3read_using(
  FUN = data.table::fread,
  encoding = "UTF-8",
  object = "data_tidy/BDD_PA_FAPBM.csv",
  bucket = "projet-afd-eva-ap",
  opts = list("region" = ""))

# PA in Africa
data_pa_africa = 
  aws.s3::s3read_using(
  FUN = data.table::fread,
  encoding = "UTF-8",
  object = "data_tidy/BDD_PA_africa.csv",
  bucket = "projet-afd-eva-ap",
  opts = list("region" = ""))

# PA in African countries where at least one AFD PA can be analyszed
data_pa_africa_ie_afd = data_pa_africa %>%
  filter(focus == T & status_yr >= 2002 & area_km2 > 1 & marine %in% c(0,1))
list_iso_africa_ie_focus = unique(data_pa_africa_ie_afd$iso3)

data_pa_africa_ie = data_pa_africa %>%
  filter(iso3 %in% list_iso_africa_ie_focus)

#Import WDPA data
## Download and save data
# data_wdpa = wdpa_fetch(x = "global", wait = TRUE, download_dir = "data_raw",
#                        page_wait = 2, verbose = TRUE)
# st_write(wdpa,
#          dsn = "data_raw/wdpa/wdpa_shp_global_raw.gpkg",
#          delete_dsn = TRUE)

## Load data
data_wdpa = 
  #st_read("data_raw/wdpa/wdpa_shp_global_raw.gpkg") %>%
  s3read_using(sf::st_read,
              object = "data_raw/wdpa/wdpa_shp_global_raw.gpkg",
              bucket = "projet-afd-eva-ap",
              opts = list("region" = "")) %>%
  #st_drop_geometry() %>%
  clean_names() %>%
  #Add region, sub-region and country names 
  mutate(region = countrycode(sourcevar = iso3,
                              origin = "iso3c",
                              destination = "un.region.name"),
         sub_region = countrycode(sourcevar = iso3,
                              origin = "iso3c",
                              destination = "un.regionsub.name"),
         country_en = countrycode(sourcevar = iso3,
                              origin = "iso3c",
                              destination = "un.name.en"),
         country_fr = countrycode(sourcevar = iso3,
                              origin = "iso3c",
                              destination = "un.name.fr"),
         .after = "iso3")  %>%
  #Add the description of IUCN from its category
    mutate(iucn_des_fr = case_when(
  !is.na(wdpaid) & iucn_cat == "Ia" ~ "Réserve naturelle intégrale",
  !is.na(wdpaid) & iucn_cat == "Ib" ~ "Zone de nature sauvage",
  !is.na(wdpaid) & iucn_cat == "II" ~ "Parc national", 
  !is.na(wdpaid) & iucn_cat == "III" ~ "Monument naturel",
  !is.na(wdpaid) & iucn_cat == "IV" ~ "Gest. des habitats/espèces",
  !is.na(wdpaid) & iucn_cat == "V" ~ "Paysage protégé",
  !is.na(wdpaid) & iucn_cat == "VI" ~ "Gest. de ress. protégées",
  !is.na(wdpaid) & iucn_cat == "Not Applicable" ~ "Non catégorisée",
  !is.na(wdpaid) & iucn_cat == "Not Reported" ~ "Non catégorisée",
  !is.na(wdpaid) & iucn_cat == "Not Assigned" ~ "Non catégorisée",
  TRUE ~ "Non référencée"), .after = iucn_cat) %>%
      mutate(iucn_des_en = case_when(
  !is.na(wdpaid) & iucn_cat == "Ia" ~ "Strict nature reserve",
  !is.na(wdpaid) & iucn_cat == "Ib" ~ "Wilderness area",
  !is.na(wdpaid) & iucn_cat == "II" ~ "National park",
  !is.na(wdpaid) & iucn_cat == "III" ~ "Natural monument or feature",
  !is.na(wdpaid) & iucn_cat == "IV" ~ "Habitat or species management area",
  !is.na(wdpaid) & iucn_cat == "V" ~ "Protected landscape or seascape",
  !is.na(wdpaid) & iucn_cat == "VI" ~ "Protected area with sust. use of nat. res.",
  !is.na(wdpaid) & iucn_cat == "Not Applicable" ~ "Not categorized",
  !is.na(wdpaid) & iucn_cat == "Not Reported" ~ "Not categorized",
  !is.na(wdpaid) & iucn_cat == "Not Assigned" ~ "Not categorized",
  TRUE ~ "Not referenced"), .after = iucn_cat) %>%
  st_drop_geometry()

#Subset of WDPA data for Madagascar, with IUCN category description (English and French)
# data_wdpa_mdg = data_wdpa %>%
#   filter(iso3 == "MDG") %>%
#   #Add the description of IUCN from its category
#     mutate(iucn_des_fr = case_when(
#   !is.na(wdpaid) & iucn_cat == "Ia" ~ "Réserve naturelle intégrale",
#   !is.na(wdpaid) & iucn_cat == "Ib" ~ "Zone de nature sauvage",
#   !is.na(wdpaid) & iucn_cat == "II" ~ "Parc national", 
#   !is.na(wdpaid) & iucn_cat == "III" ~ "Monument naturel",
#   !is.na(wdpaid) & iucn_cat == "IV" ~ "Gest. des habitats/espèces",
#   !is.na(wdpaid) & iucn_cat == "V" ~ "Paysage protégé",
#   !is.na(wdpaid) & iucn_cat == "VI" ~ "Gest. de ress. protégées",
#   !is.na(wdpaid) & iucn_cat == "Not Applicable" ~ "Non catégorisée",
#   !is.na(wdpaid) & iucn_cat == "Not Reported" ~ "Non catégorisée",
#   !is.na(wdpaid) & iucn_cat == "Not Assigned" ~ "Non catégorisée",
#   TRUE ~ "Non référencée"), .after = iucn_cat) %>%
#       mutate(iucn_des_en = case_when(
#   !is.na(wdpaid) & iucn_cat == "Ia" ~ "Strict nature reserve",
#   !is.na(wdpaid) & iucn_cat == "Ib" ~ "Wilderness area",
#   !is.na(wdpaid) & iucn_cat == "II" ~ "National park",
#   !is.na(wdpaid) & iucn_cat == "III" ~ "Natural monument or feature",
#   !is.na(wdpaid) & iucn_cat == "IV" ~ "Habitat or species management area",
#   !is.na(wdpaid) & iucn_cat == "V" ~ "Protected landscape or seascape",
#   !is.na(wdpaid) & iucn_cat == "VI" ~ "Protected area with sust. use of nat. res.",
#   !is.na(wdpaid) & iucn_cat == "Not Applicable" ~ "Not categorized",
#   !is.na(wdpaid) & iucn_cat == "Not Reported" ~ "Not categorized",
#   !is.na(wdpaid) & iucn_cat == "Not Assigned" ~ "Not categorized",
#   TRUE ~ "Not referenced"), .after = iucn_cat) %>%
#   st_drop_geometry()

#To perform statistics on the distribution of PAs reported by the WDPA across countries/regions, we focus on not high-income countries.
#Precisely, we restrict to countries defined as low-income, lower middle-income, upper-middle income, minus Russia, and including Chile, Uruguay New Caledonia and Panama
df_ctry_stat_wdpa = WDI(country = "all", start = "1960", end = "2022", extra = TRUE, language = "en") %>%
  group_by(iso3c) %>%
  slice(1) %>%
  ungroup() %>%
  select(c("iso3c", "income")) %>%
  rename("iso3" = "iso3c",
         "wb_inc_grp" = "income") %>%
  filter((wb_inc_grp %in% c("Low income",  "Lower middle income", "Upper middle income") & iso3 != "RUS") | iso3 %in% c("CHL", "URY", "PAN", "NCL"))

lst_ctry_stat_wdpa = df_ctry_stat_wdpa$iso3


```

## Performing descriptive statistics

### PA of interest, other PA and all PA in a given sample

```{r, eval = F}

#Define the saving directory
save_dir = "AFD_africa_ie_"

#Define the datasets : with PA of interest (focus), other PA (no focus) and all PA (all)
## For PA in Africa
data_pa_focus = data_pa_africa_ie %>% filter(focus == T)
data_pa_nofocus = data_pa_africa_ie %>% filter(focus == F)
data_pa_all = data_pa_africa_ie
## For FAPBM and Madagascar
# data_pa_focus = data_pa_fapbm
# data_pa_nofocus = data_wdpa_mdg %>% filter(!(wdpaid %in% data_pa_fapbm$wdpaid))
# data_pa_all = data_wdpa_mdg

#Define colors
iucn_cat_colors = c(
  "Not categorized" = "#B0B0B0",                  # Gris
  "Habitat or species management area" = "#AE642D", # Marron
  "Protected landscape or seascape" = "#80D0D0",   # Bleu
  "Protected area with sust. use of nat. res." = "#94812B", # Orange
  "Natural monument or feature"="#842E1B",
  "National park" = "#228B22", # Vert
  "Wilderness area"="#DFAF2C",
  "Strict nature reserve" = "#18391E"              
)


```

#### IUCN : non-marine

PA of interest

```{r, eval = FALSE}
#Building the relevant dataset
##For all PAs ..
data_cat_iucn = data_pa_focus %>%
  filter(marine %in% c(0,1)) %>%
  group_by(iucn_des_en, iucn_des_fr) %>%
  #number of PAs per IUCN category
  summarize(n_iucn = n()) %>%
  ungroup() %>%
  #Frequency of IUCN categories
  mutate(n_pa = sum(n_iucn),
         freq_iucn = round(n_iucn/n_pa*100, 2)) %>%
  arrange(desc(iucn_des_en)) %>%
  mutate(ypos_iucn = cumsum(freq_iucn) - 0.5*freq_iucn) 


##... and for referenced PAs only
data_cat_iucn_ref = data_pa_focus %>%
  filter(marine %in% c(0,1)) %>%
  #Remove not referenced PAs
  subset(!(iucn_des_fr %in% c("Non catégorisée", "Non référencée"))) %>%
  group_by(iucn_des_en, iucn_des_fr) %>%
  #number of PAs per IUCN category
  summarize(n_iucn = n()) %>%
  ungroup() %>%
  #Frequency of IUCN categories
  mutate(n_pa = sum(n_iucn),
         freq_iucn = round(n_iucn/n_pa*100, 2)) %>%
  arrange(freq_iucn) %>%
  mutate(ypos_iucn = cumsum(freq_iucn) - 0.5*freq_iucn) 

#Pie charts
pie_cat_iucn_en = ggplot(data_cat_iucn, 
                      aes(x="", y= freq_iucn, fill = iucn_des_en)) %>%
  + geom_bar(width = 1, stat = "identity", color="white") %>%
  + coord_polar("y", start=0) %>%
  + geom_label_repel(aes(x=1.2, label = paste0(round(freq_iucn, 1), "%")), 
             color = "white", 
             position = position_stack(vjust = 0.55), 
             size=2.5, show.legend = FALSE) %>%
  # + geom_label(aes(x=1.4, label = paste0(freq_iucn, "%")), 
  #              color = "white", 
  #              position = position_stack(vjust = 0.7), size=2.5, 
  #              show.legend = FALSE) %>%
  + labs(x = "", y = "",
         title = "Distribution of non-marine protected areas by IUCN categories (%)",
         subtitle = paste("Sample :", sum(data_cat_iucn$n_iucn), "non-marine protected areas of interest")) %>%
  #+ scale_fill_brewer(name = "Categories", palette = "Dark2") %>%
  + scale_fill_manual(name = "Categories",
                      values = iucn_cat_colors ) %>%
  + theme_void()
pie_cat_iucn_en

pie_cat_iucn_ref_en = ggplot(data_cat_iucn_ref, 
                      aes(x="", y= freq_iucn, fill = iucn_des_en)) %>%
  + geom_bar(width = 1, stat = "identity", color="white") %>%
  + coord_polar("y", start=0) %>%
  + geom_label_repel(aes(x=1.2, label = paste0(round(freq_iucn, 1), "%")), 
             color = "white", 
             position = position_stack(vjust = 0.55), 
             size=2.5, show.legend = FALSE) %>%
  # + geom_label(aes(x=1.4, label = paste0(freq_iucn, "%")), 
  #              color = "white", 
  #              position = position_stack(vjust = 0.7), size=2.5, 
  #              show.legend = FALSE) %>%
  + labs(x = "", y = "",
         title = "Distribution of non-marine protected areas by IUCN categories \nexcept for not categorized (%)",
         subtitle = paste("Sample :", sum(data_cat_iucn_ref$n_iucn), "out of", sum(data_cat_iucn$n_iucn),  "non-marine protected areas of interest")) %>%
  #+ scale_fill_brewer(name = "Categories", palette = "Dark2") %>%
    + scale_fill_manual(name = "Categories",
                      values = c("Not categorized" = "#7570B3",
                                 "Habitat or species management area" = "#E7298A",
                                 "Protected landscape or seascape" = "#66A61E",
                                 "Protected area with sust. use of nat. res." = "#D95F02",
                                 "National park" = "#1B9E77",
                                 "Strict nature reserve" = "#E6AB02")) %>%
  + theme_void()
pie_cat_iucn_ref_en


```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

ggsave(paste(tmp, "pie_cat_iucn_en.png", sep = "/"),
       plot = pie_cat_iucn_en,
       device = "png",
       height = 6, width = 9)

ggsave(paste(tmp, "pie_cat_iucn_ref_en.png", sep = "/"),
       plot = pie_cat_iucn_ref_en,
       device = "png",
       height = 6, width = 9)

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
for(f in files) 
  {
  cat("Uploading file", paste0("'", f, "'"), "\n")
  aws.s3::put_object(file = f,
                     bucket = paste("projet-afd-eva-ap/descriptive_stats", save_dir, "focus/IUCN/no_marine", sep = "/"),
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))

```

All protected areas (reported by the WDPA)

```{r, eval = FALSE}
#Building the relevant dataset
##For all PAs ..
data_cat_iucn = data_pa_all %>%
  filter(marine %in% c(0,1)) %>%
  group_by(iucn_des_en, iucn_des_fr) %>%
  #number of PAs per IUCN category
  summarize(n_iucn = n()) %>%
  ungroup() %>%
  #Frequency of IUCN categories
  mutate(n_pa = sum(n_iucn),
         freq_iucn = round(n_iucn/n_pa*100, 2)) %>%
  arrange(desc(iucn_des_en)) %>%
  mutate(ypos_iucn = cumsum(freq_iucn) - 0.5*freq_iucn) 


##... and for referenced PAs only
data_cat_iucn_ref = data_pa_all %>%
  filter(marine %in% c(0,1)) %>%
  #Remove not referenced PAs
  subset(!(iucn_des_fr %in% c("Non catégorisée", "Non référencée"))) %>%
  group_by(iucn_des_en, iucn_des_fr) %>%
  #number of PAs per IUCN category
  summarize(n_iucn = n()) %>%
  ungroup() %>%
  #Frequency of IUCN categories
  mutate(n_pa = sum(n_iucn),
         freq_iucn = round(n_iucn/n_pa*100, 2)) %>%
  arrange(freq_iucn) %>%
  mutate(ypos_iucn = cumsum(freq_iucn) - 0.5*freq_iucn) 

#Pie charts
pie_cat_iucn_en = ggplot(data_cat_iucn, 
                      aes(x="", y= freq_iucn, fill = iucn_des_en)) %>%
  + geom_bar(width = 1, stat = "identity", color="white") %>%
  + coord_polar("y", start=0) %>%
  + geom_label_repel(aes(x=1.2, label = paste0(round(freq_iucn, 1), "%")), 
             color = "white", 
             position = position_stack(vjust = 0.55), 
             size=2.5, show.legend = FALSE) %>%
  # + geom_label(aes(x=1.4, label = paste0(freq_iucn, "%")), 
  #              color = "white", 
  #              position = position_stack(vjust = 0.7), size=2.5, 
  #              show.legend = FALSE) %>%
  + labs(x = "", y = "",
         title = "Distribution of non-marine protected areas by IUCN categories (%)",
         subtitle = paste("Sample :", sum(data_cat_iucn$n_iucn), "non-marine protected areas")) %>%
  # + scale_fill_brewer(name = "Categories", palette = "Dark2") %>%
      + scale_fill_manual(name = "Categories",
                      values = iucn_cat_colors) %>%
  + theme_void()
pie_cat_iucn_en

pie_cat_iucn_ref_en = ggplot(data_cat_iucn_ref, 
                      aes(x="", y= freq_iucn, fill = iucn_des_en)) %>%
  + geom_bar(width = 1, stat = "identity", color="white") %>%
  + coord_polar("y", start=0) %>%
  + geom_label_repel(aes(x=1.2, label = paste0(round(freq_iucn, 1), "%")), 
             color = "white", 
             position = position_stack(vjust = 0.55), 
             size=2.5, show.legend = FALSE) %>%
  # + geom_label(aes(x=1.4, label = paste0(freq_iucn, "%")), 
  #              color = "white", 
  #              position = position_stack(vjust = 0.7), size=2.5, 
  #              show.legend = FALSE) %>%
  + labs(x = "", y = "",
         title = "Distribution of non-marine protected areas by IUCN categories \nexcept for not categorized (%)",
         subtitle = paste("Sample :", sum(data_cat_iucn_ref$n_iucn), "out of", sum(data_cat_iucn$n_iucn),  "non-marine protected areas")) %>%
  # + scale_fill_brewer(name = "Categories", palette = "Dark2") %>%
    + scale_fill_manual(name = "Categories",
                      values = iucn_cat_colors) %>%
  + theme_void()
pie_cat_iucn_ref_en

```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

ggsave(paste(tmp, "pie_cat_iucn_en.png", sep = "/"),
       plot = pie_cat_iucn_en,
       device = "png",
       height = 6, width = 9)

ggsave(paste(tmp, "pie_cat_iucn_ref_en.png", sep = "/"),
       plot = pie_cat_iucn_ref_en,
       device = "png",
       height = 6, width = 9)

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
for(f in files) 
  {
  cat("Uploading file", paste0("'", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = paste("projet-afd-eva-ap/descriptive_stats", save_dir, "all/IUCN/no_marine", sep = "/"),
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

All protected areas except PA of interest

```{r, eval = FALSE}
#Building the relevant dataset
##For all PAs ..
data_cat_iucn = data_pa_nofocus %>%
  filter(marine %in% c(0,1)) %>%
  group_by(iucn_des_en, iucn_des_fr) %>%
  #number of PAs per IUCN category
  summarize(n_iucn = n()) %>%
  ungroup() %>%
  #Frequency of IUCN categories
  mutate(n_pa = sum(n_iucn),
         freq_iucn = round(n_iucn/n_pa*100, 2)) %>%
  arrange(desc(iucn_des_en)) %>%
  mutate(ypos_iucn = cumsum(freq_iucn) - 0.5*freq_iucn) 


##... and for referenced PAs only
data_cat_iucn_ref = data_pa_nofocus %>%
  filter(marine %in% c(0,1)) %>%
  #Remove not referenced PAs
  subset(!(iucn_des_fr %in% c("Non catégorisée", "Non référencée"))) %>%
  group_by(iucn_des_en, iucn_des_fr) %>%
  #number of PAs per IUCN category
  summarize(n_iucn = n()) %>%
  ungroup() %>%
  #Frequency of IUCN categories
  mutate(n_pa = sum(n_iucn),
         freq_iucn = round(n_iucn/n_pa*100, 2)) %>%
  arrange(freq_iucn) %>%
  mutate(ypos_iucn = cumsum(freq_iucn) - 0.5*freq_iucn) 

#Pie charts
pie_cat_iucn_en = ggplot(data_cat_iucn, 
                      aes(x="", y= freq_iucn, fill = iucn_des_en)) %>%
  + geom_bar(width = 1, stat = "identity", color="white") %>%
  + coord_polar("y", start=0) %>%
  + geom_label_repel(aes(x=1.2, label = paste0(round(freq_iucn, 1), "%")), 
             color = "white", 
             position = position_stack(vjust = 0.55), 
             size=2.5, show.legend = FALSE) %>%
  # + geom_label(aes(x=1.4, label = paste0(freq_iucn, "%")), 
  #              color = "white", 
  #              position = position_stack(vjust = 0.7), size=2.5, 
  #              show.legend = FALSE) %>%
  + labs(x = "", y = "",
         title = "Distribution of non-marine protected areas by IUCN categories (%)",
         subtitle = paste("Sample :", sum(data_cat_iucn$n_iucn), "other non-marine protected areas")) %>%
  # + scale_fill_brewer(name = "Categories", palette = "Dark2") %>%
      + scale_fill_manual(name = "Categories",
                      values = iucn_cat_colors) %>%
  + theme_void()
pie_cat_iucn_en

pie_cat_iucn_ref_en = ggplot(data_cat_iucn_ref, 
                      aes(x="", y= freq_iucn, fill = iucn_des_en)) %>%
  + geom_bar(width = 1, stat = "identity", color="white") %>%
  + coord_polar("y", start=0) %>%
  + geom_label_repel(aes(x=1.2, label = paste0(round(freq_iucn, 1), "%")), 
             color = "white", 
             position = position_stack(vjust = 0.55), 
             size=2.5, show.legend = FALSE) %>%
  # + geom_label(aes(x=1.4, label = paste0(freq_iucn, "%")), 
  #              color = "white", 
  #              position = position_stack(vjust = 0.7), size=2.5, 
  #              show.legend = FALSE) %>%
  + labs(x = "", y = "",
         title = "Distribution of non-marine protected areas by IUCN categories \nexcept for not categorized (%)",
         subtitle = paste("Sample :", sum(data_cat_iucn_ref$n_iucn), "out of", sum(data_cat_iucn$n_iucn),  "other non-marine protected areas")) %>%
  # + scale_fill_brewer(name = "Categories", palette = "Dark2") %>%
    + scale_fill_manual(name = "Categories",
                      values = iucn_cat_colors) %>%
  + theme_void()
pie_cat_iucn_ref_en
```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

ggsave(paste(tmp, "pie_cat_iucn_en.png", sep = "/"),
       plot = pie_cat_iucn_en,
       device = "png",
       height = 6, width = 9)

ggsave(paste(tmp, "pie_cat_iucn_ref_en.png", sep = "/"),
       plot = pie_cat_iucn_ref_en,
       device = "png",
       height = 6, width = 9)

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
for(f in files) 
  {
  cat("Uploading file", paste0("'", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = paste("projet-afd-eva-ap/descriptive_stats", save_dir, "nofocus/no_marine", sep = "/"),
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

#### IUCN : marine

PA of interest

```{r, eval = FALSE}
#Building the relevant dataset
##For all PAs ..
data_cat_iucn = data_pa_focus %>%
  filter(marine ==2) %>%
  group_by(iucn_des_en, iucn_des_fr) %>%
  #number of PAs per IUCN category
  summarize(n_iucn = n()) %>%
  ungroup() %>%
  #Frequency of IUCN categories
  mutate(n_pa = sum(n_iucn),
         freq_iucn = round(n_iucn/n_pa*100, 2)) %>%
  arrange(desc(iucn_des_en)) %>%
  mutate(ypos_iucn = cumsum(freq_iucn) - 0.5*freq_iucn) 


##... and for referenced PAs only
data_cat_iucn_ref = data_pa_focus %>%
  filter(marine == 2) %>%
  #Remove not referenced PAs
  subset(!(iucn_des_fr %in% c("Non catégorisée", "Non référencée"))) %>%
  group_by(iucn_des_en, iucn_des_fr) %>%
  #number of PAs per IUCN category
  summarize(n_iucn = n()) %>%
  ungroup() %>%
  #Frequency of IUCN categories
  mutate(n_pa = sum(n_iucn),
         freq_iucn = round(n_iucn/n_pa*100, 2)) %>%
  arrange(freq_iucn) %>%
  mutate(ypos_iucn = cumsum(freq_iucn) - 0.5*freq_iucn) 

#Pie charts
pie_cat_iucn_en = ggplot(data_cat_iucn, 
                      aes(x="", y= freq_iucn, fill = iucn_des_en)) %>%
  + geom_bar(width = 1, stat = "identity", color="white") %>%
  + coord_polar("y", start=0) %>%
  + geom_label_repel(aes(x=1.2, label = paste0(round(freq_iucn, 1), "%")), 
             color = "white", 
             position = position_stack(vjust = 0.55), 
             size=2.5, show.legend = FALSE) %>%
  # + geom_label(aes(x=1.4, label = paste0(freq_iucn, "%")), 
  #              color = "white", 
  #              position = position_stack(vjust = 0.7), size=2.5, 
  #              show.legend = FALSE) %>%
  + labs(x = "", y = "",
         title = "Distribution of marine protected areas by IUCN categories (%)",
         subtitle = paste("Sample :", sum(data_cat_iucn$n_iucn), "marine protected areas of interest")) %>%
  #+ scale_fill_brewer(name = "Categories", palette = "Dark2") %>%
  + scale_fill_manual(name = "Categories",
                      values = iucn_cat_colors ) %>%
  + theme_void()
pie_cat_iucn_en

pie_cat_iucn_ref_en = ggplot(data_cat_iucn_ref, 
                      aes(x="", y= freq_iucn, fill = iucn_des_en)) %>%
  + geom_bar(width = 1, stat = "identity", color="white") %>%
  + coord_polar("y", start=0) %>%
  + geom_label_repel(aes(x=1.2, label = paste0(round(freq_iucn, 1), "%")), 
             color = "white", 
             position = position_stack(vjust = 0.55), 
             size=2.5, show.legend = FALSE) %>%
  # + geom_label(aes(x=1.4, label = paste0(freq_iucn, "%")), 
  #              color = "white", 
  #              position = position_stack(vjust = 0.7), size=2.5, 
  #              show.legend = FALSE) %>%
  + labs(x = "", y = "",
         title = "Distribution of marine protected areas by IUCN categories \nexcept for not categorized (%)",
         subtitle = paste("Sample :", sum(data_cat_iucn_ref$n_iucn), "out of", sum(data_cat_iucn$n_iucn),  "marine protected areas of interest")) %>%
  #+ scale_fill_brewer(name = "Categories", palette = "Dark2") %>%
    + scale_fill_manual(name = "Categories",
                      values = iucn_cat_colors) %>%
  + theme_void()
pie_cat_iucn_ref_en


```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

ggsave(paste(tmp, "pie_cat_iucn_en.png", sep = "/"),
       plot = pie_cat_iucn_en,
       device = "png",
       height = 6, width = 9)

ggsave(paste(tmp, "pie_cat_iucn_ref_en.png", sep = "/"),
       plot = pie_cat_iucn_ref_en,
       device = "png",
       height = 6, width = 9)

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
for(f in files) 
  {
  cat("Uploading file", paste0("'", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = paste("projet-afd-eva-ap/descriptive_stats", save_dir, "focus/IUCN/marine", sep = "/"),
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))

```

All protected areas (reported by the WDPA)

```{r, eval = FALSE}
#Building the relevant dataset
##For all PAs ..
data_cat_iucn = data_pa_all %>%
  filter(marine == 2) %>%
  group_by(iucn_des_en, iucn_des_fr) %>%
  #number of PAs per IUCN category
  summarize(n_iucn = n()) %>%
  ungroup() %>%
  #Frequency of IUCN categories
  mutate(n_pa = sum(n_iucn),
         freq_iucn = round(n_iucn/n_pa*100, 2)) %>%
  arrange(desc(iucn_des_en)) %>%
  mutate(ypos_iucn = cumsum(freq_iucn) - 0.5*freq_iucn) 


##... and for referenced PAs only
data_cat_iucn_ref = data_wdpa_mdg %>%
  filter(marine == 2) %>%
  #Remove not referenced PAs
  subset(!(iucn_des_fr %in% c("Non catégorisée", "Non référencée"))) %>%
  group_by(iucn_des_en, iucn_des_fr) %>%
  #number of PAs per IUCN category
  summarize(n_iucn = n()) %>%
  ungroup() %>%
  #Frequency of IUCN categories
  mutate(n_pa = sum(n_iucn),
         freq_iucn = round(n_iucn/n_pa*100, 2)) %>%
  arrange(freq_iucn) %>%
  mutate(ypos_iucn = cumsum(freq_iucn) - 0.5*freq_iucn) 

#Pie charts
pie_cat_iucn_en = ggplot(data_cat_iucn, 
                      aes(x="", y= freq_iucn, fill = iucn_des_en)) %>%
  + geom_bar(width = 1, stat = "identity", color="white") %>%
  + coord_polar("y", start=0) %>%
  + geom_label_repel(aes(x=1.2, label = paste0(round(freq_iucn, 1), "%")), 
             color = "white", 
             position = position_stack(vjust = 0.55), 
             size=2.5, show.legend = FALSE) %>%
  # + geom_label(aes(x=1.4, label = paste0(freq_iucn, "%")), 
  #              color = "white", 
  #              position = position_stack(vjust = 0.7), size=2.5, 
  #              show.legend = FALSE) %>%
  + labs(x = "", y = "",
         title = "Distribution of marine protected areas by IUCN categories (%)",
         subtitle = paste("Sample :", sum(data_cat_iucn$n_iucn), "marine protected areas ")) %>%
  # + scale_fill_brewer(name = "Categories", palette = "Dark2") %>%
      + scale_fill_manual(name = "Categories",
                      values = iucn_cat_colors) %>%
  + theme_void()
pie_cat_iucn_en

pie_cat_iucn_ref_en = ggplot(data_cat_iucn_ref, 
                      aes(x="", y= freq_iucn, fill = iucn_des_en)) %>%
  + geom_bar(width = 1, stat = "identity", color="white") %>%
  + coord_polar("y", start=0) %>%
  + geom_label_repel(aes(x=1.2, label = paste0(round(freq_iucn, 1), "%")), 
             color = "white", 
             position = position_stack(vjust = 0.55), 
             size=2.5, show.legend = FALSE) %>%
  # + geom_label(aes(x=1.4, label = paste0(freq_iucn, "%")), 
  #              color = "white", 
  #              position = position_stack(vjust = 0.7), size=2.5, 
  #              show.legend = FALSE) %>%
  + labs(x = "", y = "",
         title = "Distribution of marine protected areas by IUCN categories \nexcept for not categorized (%)",
         subtitle = paste("Sample :", sum(data_cat_iucn_ref$n_iucn), "out of", sum(data_cat_iucn$n_iucn),  "marine protected areas")) %>%
  # + scale_fill_brewer(name = "Categories", palette = "Dark2") %>%
    + scale_fill_manual(name = "Categories",
                      values = iucn_cat_colors) %>%
  + theme_void()
pie_cat_iucn_ref_en

```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

ggsave(paste(tmp, "pie_cat_iucn_en.png", sep = "/"),
       plot = pie_cat_iucn_en,
       device = "png",
       height = 6, width = 9)

ggsave(paste(tmp, "pie_cat_iucn_ref_en.png", sep = "/"),
       plot = pie_cat_iucn_ref_en,
       device = "png",
       height = 6, width = 9)

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
for(f in files) 
  {
  cat("Uploading file", paste0("'", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = paste("projet-afd-eva-ap/descriptive_stats", save_dir, "all/IUCN/marine", sep = "/"),
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

PA not of interest

```{r, eval = FALSE}
#Building the relevant dataset
##For all PAs ..
data_cat_iucn = data_pa_nofocus %>%
  filter(marine == 2) %>%
  group_by(iucn_des_en, iucn_des_fr) %>%
  #number of PAs per IUCN category
  summarize(n_iucn = n()) %>%
  ungroup() %>%
  #Frequency of IUCN categories
  mutate(n_pa = sum(n_iucn),
         freq_iucn = round(n_iucn/n_pa*100, 2)) %>%
  arrange(desc(iucn_des_en)) %>%
  mutate(ypos_iucn = cumsum(freq_iucn) - 0.5*freq_iucn) 


##... and for referenced PAs only
data_cat_iucn_ref = data_pa_nofocus %>%
  filter(marine == 2) %>%
  #Remove not referenced PAs
  subset(!(iucn_des_fr %in% c("Non catégorisée", "Non référencée"))) %>%
  group_by(iucn_des_en, iucn_des_fr) %>%
  #number of PAs per IUCN category
  summarize(n_iucn = n()) %>%
  ungroup() %>%
  #Frequency of IUCN categories
  mutate(n_pa = sum(n_iucn),
         freq_iucn = round(n_iucn/n_pa*100, 2)) %>%
  arrange(freq_iucn) %>%
  mutate(ypos_iucn = cumsum(freq_iucn) - 0.5*freq_iucn) 

#Pie charts
pie_cat_iucn_en = ggplot(data_cat_iucn, 
                      aes(x="", y= freq_iucn, fill = iucn_des_en)) %>%
  + geom_bar(width = 1, stat = "identity", color="white") %>%
  + coord_polar("y", start=0) %>%
  + geom_label_repel(aes(x=1.2, label = paste0(round(freq_iucn, 1), "%")), 
             color = "white", 
             position = position_stack(vjust = 0.55), 
             size=2.5, show.legend = FALSE) %>%
  # + geom_label(aes(x=1.4, label = paste0(freq_iucn, "%")), 
  #              color = "white", 
  #              position = position_stack(vjust = 0.7), size=2.5, 
  #              show.legend = FALSE) %>%
  + labs(x = "", y = "",
         title = "Distribution of marine protected areas by IUCN categories (%)",
         subtitle = paste("Sample :", sum(data_cat_iucn$n_iucn), "marine, not FAPBM funded protected areas")) %>%
  # + scale_fill_brewer(name = "Categories", palette = "Dark2") %>%
      + scale_fill_manual(name = "Categories",
                      values = iucn_cat_colors) %>%
  + theme_void()
pie_cat_iucn_en

pie_cat_iucn_ref_en = ggplot(data_cat_iucn_ref, 
                      aes(x="", y= freq_iucn, fill = iucn_des_en)) %>%
  + geom_bar(width = 1, stat = "identity", color="white") %>%
  + coord_polar("y", start=0) %>%
  + geom_label_repel(aes(x=1.2, label = paste0(round(freq_iucn, 1), "%")), 
             color = "white", 
             position = position_stack(vjust = 0.55), 
             size=2.5, show.legend = FALSE) %>%
  # + geom_label(aes(x=1.4, label = paste0(freq_iucn, "%")), 
  #              color = "white", 
  #              position = position_stack(vjust = 0.7), size=2.5, 
  #              show.legend = FALSE) %>%
  + labs(x = "", y = "",
         title = "Distribution of marine protected areas by IUCN categories \nexcept for not categorized (%)",
         subtitle = paste("Sample :", sum(data_cat_iucn_ref$n_iucn), "out of", sum(data_cat_iucn$n_iucn),  "other marine protected areas")) %>%
  # + scale_fill_brewer(name = "Categories", palette = "Dark2") %>%
    + scale_fill_manual(name = "Categories",
                      values = iucn_cat_colors) %>%
  + theme_void()
pie_cat_iucn_ref_en
```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

ggsave(paste(tmp, "pie_cat_iucn_en.png", sep = "/"),
       plot = pie_cat_iucn_en,
       device = "png",
       height = 6, width = 9)

ggsave(paste(tmp, "pie_cat_iucn_ref_en.png", sep = "/"),
       plot = pie_cat_iucn_ref_en,
       device = "png",
       height = 6, width = 9)

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
for(f in files) 
  {
  cat("Uploading file", paste0("'", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = paste("projet-afd-eva-ap/descriptive_stats", save_dir, "nofocus/IUCN/marine", sep = "/"),
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

#### Ecosystem

PA of interest

```{r, eval = FALSE}

#Build datasets
data_eco = data_pa_focus %>%
  #subset non-referencded PAs (have NA ecosysteme)
  subset(is.na(marine) == FALSE) %>%
  mutate(marine = as.factor(marine))
data_eco$ecosyst_en = fct_recode(data_eco$marine, 
                              "Terrestrial"="0", 
                              "Coastal"="1", 
                              "Marine"="2")
data_eco$ecosyst_fr = fct_recode(data_eco$marine, 
                              "Terrestre"="0", 
                              "Côtier"="1", 
                              "Marin"="2")

data_eco_hist = data_eco %>%
  group_by(ecosyst_en, ecosyst_fr) %>%
  summarize(n = n(),
            freq = round(n/nrow(data_eco), 2)*100) %>%
  ungroup()

#Histogram in number (in English)
pie_eco_en = ggplot(data_eco_hist, 
                     aes(x = "", y = n, fill = ecosyst_en)) %>%
+ geom_bar(width = 1, stat = "identity",color="white") %>%
+ geom_label(aes(x=1.3, label = paste0(freq, "%")), 
             color = "black", position = position_stack(vjust = 0.55), 
             size=2.5, show.legend = FALSE) %>%
+ coord_polar("y", start=0) %>%
+ labs(title = "Proportion of protected areas by ecosystem type",
       subtitle = paste("Sample :", sum(data_eco_hist$n), "protected areas of interest"),
         x = "Ecosystem type",
         y = "Proportion of protected areas") %>%
  #+ scale_fill_brewer(name = "Ecosystem", palette="Paired") %>%
  + scale_fill_manual(name = "Ecosystem",
                      values = c("Marine" = "#1F78B4",
                                 "Terrestrial" = "#B2DF8A",
                                 "Coastal" = "#A6CEE3")) %>%
  + theme_void()
pie_eco_en

```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

ggsave(paste(tmp, "pie_eco_en.png", sep = "/"),
       plot = pie_eco_en,
       device = "png",
       height = 6, width = 9)

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = paste("projet-afd-eva-ap/descriptive_stats", save_dir, "focus/ecosysteme", sep = "/"),
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))

```

All PA

```{r, eval = FALSE}

#Build datasets
data_eco = data_pa_all %>%
  #subset non-referencded PAs (have NA ecosysteme)
  subset(is.na(marine) == FALSE) %>%
  mutate(marine = as.factor(marine))
data_eco$ecosyst_en = fct_recode(data_eco$marine, 
                              "Terrestrial"="0", 
                              "Coastal"="1", 
                              "Marine"="2")
data_eco$ecosyst_fr = fct_recode(data_eco$marine, 
                              "Terrestre"="0", 
                              "Côtier"="1", 
                              "Marin"="2")

data_eco_hist = data_eco %>%
  group_by(ecosyst_en, ecosyst_fr) %>%
  summarize(n = n(),
            freq = round(n/nrow(data_eco), 2)*100) %>%
  ungroup()

#Histogram in number (in English)
pie_eco_en = ggplot(data_eco_hist, 
                     aes(x = "", y = n, fill = ecosyst_en)) %>%
+ geom_bar(width = 1, stat = "identity",color="white") %>%
+ geom_label(aes(x=1.3, label = paste0(freq, "%")), 
             color = "black", position = position_stack(vjust = 0.55), 
             size=2.5, show.legend = FALSE) %>%
+ coord_polar("y", start=0) %>%
+ labs(title = "Proportion of protected areas by ecosystem type",
       subtitle = paste("Sample :", sum(data_eco_hist$n), "protected areas"),
         x = "Ecosystem type",
         y = "Proportion of protected areas") %>%
  # + scale_fill_brewer(name = "Ecosystem", palette="Paired") %>%
  + scale_fill_manual(name = "Ecosystem",
                      values = c("Marine" = "#1F78B4",
                                 "Terrestrial" = "#B2DF8A",
                                 "Coastal" = "#A6CEE3")) %>%
  + theme_void()
pie_eco_en
```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

ggsave(paste(tmp, "pie_eco_en.png", sep = "/"),
       plot = pie_eco_en,
       device = "png",
       height = 6, width = 9)

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = paste("projet-afd-eva-ap/descriptive_stats", save_dir, "all/ecosysteme", sep = "/"),
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))

```

PA not of interest

```{r, eval = FALSE}

#Build datasets
data_eco = data_pa_nofocus %>%
  #subset non-referencded PAs (have NA ecosysteme)
  subset(is.na(marine) == FALSE) %>%
  mutate(marine = as.factor(marine))
data_eco$ecosyst_en = fct_recode(data_eco$marine, 
                              "Terrestrial"="0", 
                              "Coastal"="1", 
                              "Marine"="2")
data_eco$ecosyst_fr = fct_recode(data_eco$marine, 
                              "Terrestre"="0", 
                              "Côtier"="1", 
                              "Marin"="2")

data_eco_hist = data_eco %>%
  group_by(ecosyst_en, ecosyst_fr) %>%
  summarize(n = n(),
            freq = round(n/nrow(data_eco), 2)*100) %>%
  ungroup()

#Histogram in number (in English)
pie_eco_en = ggplot(data_eco_hist, 
                     aes(x = "", y = n, fill = ecosyst_en)) %>%
+ geom_bar(width = 1, stat = "identity",color="white") %>%
+ geom_label(aes(x=1.3, label = paste0(freq, "%")), 
             color = "black", position = position_stack(vjust = 0.55), 
             size=2.5, show.legend = FALSE) %>%
+ coord_polar("y", start=0) %>%
+ labs(title = "Proportion of protected areas by ecosystem type",
       subtitle = paste("Sample :", sum(data_eco_hist$n), "other protected areas"),
         x = "Ecosystem type",
         y = "Proportion of protected areas") %>%
  # + scale_fill_brewer(name = "Ecosystem", palette="Paired") %>%
  + scale_fill_manual(name = "Ecosystem",
                      values = c("Marine" = "#1F78B4",
                                 "Terrestrial" = "#B2DF8A",
                                 "Coastal" = "#A6CEE3")) %>%
  + theme_void()
pie_eco_en
```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

ggsave(paste(tmp, "pie_eco_en.png", sep = "/"),
       plot = pie_eco_en,
       device = "png",
       height = 6, width = 9)

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = paste("projet-afd-eva-ap/descriptive_stats", save_dir, "nofocus/ecosysteme", sep = "/"),
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

#### Governance : non-marine

PA of interest

```{r, eval = FALSE}

#Table of the governance type distribution
##English version
data_gov_en = data_pa_focus %>%
  filter(marine %in% c(0,1)) %>%
  mutate(gov_type = case_when(is.na(gov_type) == TRUE ~ "Not referenced",
                              TRUE ~ gov_type)) %>%
  group_by(gov_type) %>%
  summarize(n = n()) %>%
  mutate(n_tot = sum(n),
         freq = round(n/n_tot*100,1)) %>%
  select(-n_tot) %>%
  arrange(-freq)

tbl_gov_en = data_gov_en
names(tbl_gov_en) = c("Governance","Number of PAs","Share of PAs (%)")


#PAs with nureported or unreferenced governance types are removed
##Tables
###English
data_gov_knwn_en = data_pa_focus %>%
  filter(marine %in% c(0,1)) %>%
  mutate(gov_type = case_when(is.na(gov_type) == TRUE ~ "Not referenced",
                              TRUE ~ gov_type)) %>%
  filter(gov_type != "Not Reported" & gov_type != "Not referenced") %>%
  group_by(gov_type) %>%
  summarize(n = n()) %>%
  mutate(n_tot = sum(n),
         freq = round(n/n_tot*100,1)) %>%
  select(-n_tot) %>%
  arrange(-freq)

tbl_gov_knwn_en = data_gov_knwn_en
names(tbl_gov_knwn_en) = c("Governance","Number of PAs","Share of PAs (%)")


##Pie charts
###English
pie_gov_knwn_en = 
  ggplot(data_gov_knwn_en, 
       aes(x="", y= freq, fill= gov_type)) %>%
  + geom_bar(width = 1, stat = "identity", color="white") %>%
  + geom_label_repel(aes(x=1.3, 
                   label = paste0(format(freq, digits = 2), "%")), 
               color = "black", 
               position = position_stack(vjust = 0.55), 
               size=2.5, show.legend = FALSE) %>%
  + coord_polar("y", start=0) %>%
  + labs(title = "Governance type of non-marine protected areas \nexcept for not reported governance",
         subtitle = paste("Sample :", sum(data_gov_knwn_en$n), "out of", sum(data_gov_en$n), "non-marine protected areas of interest")) %>%
  # + scale_fill_brewer(name = "Governance", palette="Paired") %>%
  + scale_fill_manual(name = "Governance",
                      values = c("Not Reported" = "#A6CEE3",
                                 "Local communities" = "#1F78B4",
                                 "Government-delegated management" = "#B2DF8A",
                                 "Non-profit organisations" = "#33A02C",
                                 "Collaborative governance" = "#FB9A99",
                                 "Federal or national ministry or agency" = "#E31A1C",
                                 "Indigenous peoples" = "#E6F598",
                                 "Joint governance" ="#FEE08B",
                                 "For-profit organisations" = "#FDAE61",
                                 "Sub-national ministry or agency" = "#F46D43")
                                 ) %>%
  + theme_void()
pie_gov_knwn_en


```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

print(xtable(tbl_gov_knwn_en, 
             caption = "Governance of non-marine protected areas of interest (when known)",
             type = "latex"),
      file = paste(tmp, "tbl_gov_knwn_en.tex", sep  ="/"))

ggsave(paste(tmp, "pie_gov_knwn_en.png", sep = "/"),
       plot =  pie_gov_knwn_en,
       device = "png",
       height = 6, width = 9)

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = paste("projet-afd-eva-ap/descriptive_stats", save_dir, "focus/governance/no_marine", sep = "/"),
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

All protected areas (reported by the WDPA)

```{r, eval = FALSE}

#Table of the governance type distribution
##English version
data_gov_en = data_pa_all %>%
  filter(marine %in% c(0,1)) %>%
  mutate(gov_type = case_when(is.na(gov_type) == TRUE ~ "Not referenced",
                              TRUE ~ gov_type)) %>%
  group_by(gov_type) %>%
  summarize(n = n()) %>%
  mutate(n_tot = sum(n),
         freq = round(n/n_tot*100,1)) %>%
  select(-n_tot) %>%
  arrange(-freq)

tbl_gov_en = data_gov_en
names(tbl_gov_en) = c("Governance","Number of PAs","Share of PAs (%)")


#PAs with nureported or unreferenced governance types are removed
##Tables
###English
data_gov_knwn_en = data_pa_all %>%
  filter(marine %in% c(0,1)) %>%
  mutate(gov_type = case_when(is.na(gov_type) == TRUE ~ "Not referenced",
                              TRUE ~ gov_type)) %>%
  filter(gov_type != "Not Reported" & gov_type != "Not referenced") %>%
  group_by(gov_type) %>%
  summarize(n = n()) %>%
  mutate(n_tot = sum(n),
         freq = round(n/n_tot*100,1)) %>%
  select(-n_tot) %>%
  arrange(-freq)

tbl_gov_knwn_en = data_gov_knwn_en
names(tbl_gov_knwn_en) = c("Governance","Number of PAs","Share of PAs (%)")


##Pie charts
###English
pie_gov_knwn_en = 
  ggplot(data_gov_knwn_en, 
       aes(x="", y= freq, fill= gov_type)) %>%
  + geom_bar(width = 1, stat = "identity", color="white") %>%
  + geom_label_repel(aes(x=1.3, 
                   label = paste0(format(freq, digits = 2), "%")), 
               color = "black", 
               position = position_stack(vjust = 0.55), 
               size=2.5, show.legend = FALSE) %>%
  + coord_polar("y", start=0) %>%
  + labs(title = "Governance type of non-marine protected areas \nexcept for not reported governance",
         subtitle = paste("Sample :", sum(data_gov_knwn_en$n), "out of", sum(data_gov_en$n), "protected areas")) %>%
  #+ scale_fill_brewer(name = "Governance", palette="Paired") %>%
  + scale_fill_manual(name = "Governance",
                      values = c("Not Reported" = "#A6CEE3",
                                 "Local communities" = "#1F78B4",
                                 "Government-delegated management" = "#B2DF8A",
                                 "Non-profit organisations" = "#33A02C",
                                 "Collaborative governance" = "#FB9A99",
                                 "Federal or national ministry or agency" = "#E31A1C",
                                 "Indigenous peoples" = "#E6F598",
                                 "Joint governance" ="#FEE08B",
                                 "For-profit organisations" = "#FDAE61",
                                 "Sub-national ministry or agency" = "#F46D43")
                                 ) %>%
  + theme_void()
pie_gov_knwn_en
```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

print(xtable(tbl_gov_knwn_en, 
             caption = "Governance of non-marine protected areas (when known)",
             type = "latex"),
      file = paste(tmp, "tbl_gov_knwn_en.tex", sep  ="/"))

ggsave(paste(tmp, "pie_gov_knwn_en.png", sep = "/"),
       plot =  pie_gov_knwn_en,
       device = "png",
       height = 6, width = 9)

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = paste("projet-afd-eva-ap/descriptive_stats", save_dir, "all/governance/no_marine", sep = "/"),
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

Other PA

```{r, eval = FALSE}

#Table of the governance type distribution
##English version
data_gov_en = data_pa_nofocus %>%
  filter(marine %in% c(0,1)) %>%
  mutate(gov_type = case_when(is.na(gov_type) == TRUE ~ "Not referenced",
                              TRUE ~ gov_type)) %>%
  group_by(gov_type) %>%
  summarize(n = n()) %>%
  mutate(n_tot = sum(n),
         freq = round(n/n_tot*100,1)) %>%
  select(-n_tot) %>%
  arrange(-freq)

tbl_gov_en = data_gov_en
names(tbl_gov_en) = c("Governance","Number of PAs","Share of PAs (%)")


#PAs with nureported or unreferenced governance types are removed
##Tables
###English
data_gov_knwn_en = data_pa_nofocus %>%
  filter(marine %in% c(0,1)) %>%
  mutate(gov_type = case_when(is.na(gov_type) == TRUE ~ "Not referenced",
                              TRUE ~ gov_type)) %>%
  filter(gov_type != "Not Reported" & gov_type != "Not referenced") %>%
  group_by(gov_type) %>%
  summarize(n = n()) %>%
  mutate(n_tot = sum(n),
         freq = round(n/n_tot*100,1)) %>%
  select(-n_tot) %>%
  arrange(-freq)

tbl_gov_knwn_en = data_gov_knwn_en
names(tbl_gov_knwn_en) = c("Governance","Number of PAs","Share of PAs (%)")


##Pie charts
###English
pie_gov_knwn_en = 
  ggplot(data_gov_knwn_en, 
       aes(x="", y= freq, fill= gov_type)) %>%
  + geom_bar(width = 1, stat = "identity", color="white") %>%
  + geom_label_repel(aes(x=1.3, 
                   label = paste0(format(freq, digits = 2), "%")), 
               color = "black", 
               position = position_stack(vjust = 0.55), 
               size=2.5, show.legend = FALSE) %>%
  + coord_polar("y", start=0) %>%
  + labs(title = "Governance type of non-marine protected areas \nexcept for not reported governance",
         subtitle = paste("Sample :", sum(data_gov_knwn_en$n), "out of", sum(data_gov_en$n), "other protected areas")) %>%
  #+ scale_fill_brewer(name = "Governance", palette="Paired") %>%
  + scale_fill_manual(name = "Governance",
                      values = c("Not Reported" = "#A6CEE3",
                                 "Local communities" = "#1F78B4",
                                 "Government-delegated management" = "#B2DF8A",
                                 "Non-profit organisations" = "#33A02C",
                                 "Collaborative governance" = "#FB9A99",
                                 "Federal or national ministry or agency" = "#E31A1C",
                                 "Indigenous peoples" = "#E6F598",
                                 "Joint governance" ="#FEE08B",
                                 "For-profit organisations" = "#FDAE61",
                                 "Sub-national ministry or agency" = "#F46D43")
                                 ) %>%
  + theme_void()
pie_gov_knwn_en
```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

print(xtable(tbl_gov_knwn_en, 
             caption = "Governance of non-marine other protected areas (when known)",
             type = "latex"),
      file = paste(tmp, "tbl_gov_knwn_en.tex", sep  ="/"))

ggsave(paste(tmp, "pie_gov_knwn_en.png", sep = "/"),
       plot =  pie_gov_knwn_en,
       device = "png",
       height = 6, width = 9)

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = paste("projet-afd-eva-ap/descriptive_stats", save_dir, "nofocus/governance/no_marine", sep = "/"),
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

#### Governance : marine

PA of interest

```{r, eval = FALSE}

#Table of the governance type distribution
##English version
data_gov_en = data_pa_focus %>%
  filter(marine == 2) %>%
  mutate(gov_type = case_when(is.na(gov_type) == TRUE ~ "Not referenced",
                              TRUE ~ gov_type)) %>%
  group_by(gov_type) %>%
  summarize(n = n()) %>%
  mutate(n_tot = sum(n),
         freq = round(n/n_tot*100,1)) %>%
  select(-n_tot) %>%
  arrange(-freq)

tbl_gov_en = data_gov_en
names(tbl_gov_en) = c("Governance","Number of PAs","Share of PAs (%)")


#PAs with nureported or unreferenced governance types are removed
##Tables
###English
data_gov_knwn_en = data_pa_focus %>%
  filter(marine == 2) %>%
  mutate(gov_type = case_when(is.na(gov_type) == TRUE ~ "Not referenced",
                              TRUE ~ gov_type)) %>%
  filter(gov_type != "Not Reported" & gov_type != "Not referenced") %>%
  group_by(gov_type) %>%
  summarize(n = n()) %>%
  mutate(n_tot = sum(n),
         freq = round(n/n_tot*100,1)) %>%
  select(-n_tot) %>%
  arrange(-freq)

tbl_gov_knwn_en = data_gov_knwn_en
names(tbl_gov_knwn_en) = c("Governance","Number of PAs","Share of PAs (%)")


##Pie charts
###English
pie_gov_knwn_en = 
  ggplot(data_gov_knwn_en, 
       aes(x="", y= freq, fill= gov_type)) %>%
  + geom_bar(width = 1, stat = "identity", color="white") %>%
  + geom_label_repel(aes(x=1.3, 
                   label = paste0(format(freq, digits = 2), "%")), 
               color = "black", 
               position = position_stack(vjust = 0.55), 
               size=2.5, show.legend = FALSE) %>%
  + coord_polar("y", start=0) %>%
  + labs(title = "Governance type of marine protected areas \nexcept for not reported governance",
         subtitle = paste("Sample :", sum(data_gov_knwn_en$n), "out of", sum(data_gov_en$n), "protected areas of interest")) %>%
  # + scale_fill_brewer(name = "Governance", palette="Paired") %>%
  + scale_fill_manual(name = "Governance",
                      values = c("Not Reported" = "#A6CEE3",
                                 "Local communities" = "#1F78B4",
                                 "Government-delegated management" = "#B2DF8A",
                                 "Non-profit organisations" = "#33A02C",
                                 "Collaborative governance" = "#FB9A99",
                                 "Federal or national ministry or agency" = "#E31A1C",
                                 "Indigenous peoples" = "#E6F598",
                                 "Joint governance" ="#FEE08B",
                                 "For-profit organisations" = "#FDAE61",
                                 "Sub-national ministry or agency" = "#F46D43")
                                 ) %>%
  + theme_void()
pie_gov_knwn_en


```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

print(xtable(tbl_gov_knwn_en, 
             caption = "Governance of marine protected areas of interest (when known)",
             type = "latex"),
      file = paste(tmp, "tbl_gov_knwn_en.tex", sep  ="/"))

ggsave(paste(tmp, "pie_gov_knwn_en.png", sep = "/"),
       plot =  pie_gov_knwn_en,
       device = "png",
       height = 6, width = 9)

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = paste("projet-afd-eva-ap/descriptive_stats", save_dir, "focus/governance/marine", sep = "/"),
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

All PA

```{r, eval = FALSE}

#Table of the governance type distribution
##English version
data_gov_en = data_pa_all %>%
  filter(marine == 2) %>%
  mutate(gov_type = case_when(is.na(gov_type) == TRUE ~ "Not referenced",
                              TRUE ~ gov_type)) %>%
  group_by(gov_type) %>%
  summarize(n = n()) %>%
  mutate(n_tot = sum(n),
         freq = round(n/n_tot*100,1)) %>%
  select(-n_tot) %>%
  arrange(-freq)

tbl_gov_en = data_gov_en
names(tbl_gov_en) = c("Governance","Number of PAs","Share of PAs (%)")


#PAs with nureported or unreferenced governance types are removed
##Tables
###English
data_gov_knwn_en = data_pa_all %>%
  filter(marine == 2) %>%
  mutate(gov_type = case_when(is.na(gov_type) == TRUE ~ "Not referenced",
                              TRUE ~ gov_type)) %>%
  filter(gov_type != "Not Reported" & gov_type != "Not referenced") %>%
  group_by(gov_type) %>%
  summarize(n = n()) %>%
  mutate(n_tot = sum(n),
         freq = round(n/n_tot*100,1)) %>%
  select(-n_tot) %>%
  arrange(-freq)

tbl_gov_knwn_en = data_gov_knwn_en
names(tbl_gov_knwn_en) = c("Governance","Number of PAs","Share of PAs (%)")


##Pie charts
###English
pie_gov_knwn_en = 
  ggplot(data_gov_knwn_en, 
       aes(x="", y= freq, fill= gov_type)) %>%
  + geom_bar(width = 1, stat = "identity", color="white") %>%
  + geom_label_repel(aes(x=1.3, 
                   label = paste0(format(freq, digits = 2), "%")), 
               color = "black", 
               position = position_stack(vjust = 0.55), 
               size=2.5, show.legend = FALSE) %>%
  + coord_polar("y", start=0) %>%
  + labs(title = "Governance type of marine protected areas \nexcept for not reported governance",
         subtitle = paste("Sample :", sum(data_gov_knwn_en$n), "out of", sum(data_gov_en$n), "protected areas")) %>%
  #+ scale_fill_brewer(name = "Governance", palette="Paired") %>%
  + scale_fill_manual(name = "Governance",
                      values = c("Not Reported" = "#A6CEE3",
                                 "Local communities" = "#1F78B4",
                                 "Government-delegated management" = "#B2DF8A",
                                 "Non-profit organisations" = "#33A02C",
                                 "Collaborative governance" = "#FB9A99",
                                 "Federal or national ministry or agency" = "#E31A1C",
                                 "Indigenous peoples" = "#E6F598",
                                 "Joint governance" ="#FEE08B",
                                 "For-profit organisations" = "#FDAE61",
                                 "Sub-national ministry or agency" = "#F46D43")
                                 ) %>%
  + theme_void()
pie_gov_knwn_en
```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

print(xtable(tbl_gov_knwn_en, 
             caption = "Governance of marine protected areas (when known)",
             type = "latex"),
      file = paste(tmp, "tbl_gov_knwn_en.tex", sep  ="/"))

ggsave(paste(tmp, "pie_gov_knwn_en.png", sep = "/"),
       plot =  pie_gov_knwn_en,
       device = "png",
       height = 6, width = 9)

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = paste("projet-afd-eva-ap/descriptive_stats", save_dir, "all/governance/marine", sep = "/"),
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

Other PA

```{r, eval = FALSE}

#Table of the governance type distribution
##English version
data_gov_en = data_pa_nofocus %>%
  filter(marine == 2) %>%
  mutate(gov_type = case_when(is.na(gov_type) == TRUE ~ "Not referenced",
                              TRUE ~ gov_type)) %>%
  group_by(gov_type) %>%
  summarize(n = n()) %>%
  mutate(n_tot = sum(n),
         freq = round(n/n_tot*100,1)) %>%
  select(-n_tot) %>%
  arrange(-freq)

tbl_gov_en = data_gov_en
names(tbl_gov_en) = c("Governance","Number of PAs","Share of PAs (%)")


#PAs with nureported or unreferenced governance types are removed
##Tables
###English
data_gov_knwn_en = data_pa_nofocus %>%
  filter(marine == 2) %>%
  mutate(gov_type = case_when(is.na(gov_type) == TRUE ~ "Not referenced",
                              TRUE ~ gov_type)) %>%
  filter(gov_type != "Not Reported" & gov_type != "Not referenced") %>%
  group_by(gov_type) %>%
  summarize(n = n()) %>%
  mutate(n_tot = sum(n),
         freq = round(n/n_tot*100,1)) %>%
  select(-n_tot) %>%
  arrange(-freq)

tbl_gov_knwn_en = data_gov_knwn_en
names(tbl_gov_knwn_en) = c("Governance","Number of PAs","Share of PAs (%)")


##Pie charts
###English
pie_gov_knwn_en = 
  ggplot(data_gov_knwn_en, 
       aes(x="", y= freq, fill= gov_type)) %>%
  + geom_bar(width = 1, stat = "identity", color="white") %>%
  + geom_label_repel(aes(x=1.3, 
                   label = paste0(format(freq, digits = 2), "%")), 
               color = "black", 
               position = position_stack(vjust = 0.55), 
               size=2.5, show.legend = FALSE) %>%
  + coord_polar("y", start=0) %>%
  + labs(title = "Governance type of marine protected areas \nexcept for not reported governance",
         subtitle = paste("Sample :", sum(data_gov_knwn_en$n), "out of", sum(data_gov_en$n), "other protected areas")) %>%
  #+ scale_fill_brewer(name = "Governance", palette="Paired") %>%
  + scale_fill_manual(name = "Governance",
                      values = c("Not Reported" = "#A6CEE3",
                                 "Local communities" = "#1F78B4",
                                 "Government-delegated management" = "#B2DF8A",
                                 "Non-profit organisations" = "#33A02C",
                                 "Collaborative governance" = "#FB9A99",
                                 "Federal or national ministry or agency" = "#E31A1C",
                                 "Indigenous peoples" = "#E6F598",
                                 "Joint governance" ="#FEE08B",
                                 "For-profit organisations" = "#FDAE61",
                                 "Sub-national ministry or agency" = "#F46D43")
                                 ) %>%
  + theme_void()
pie_gov_knwn_en
```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

print(xtable(tbl_gov_knwn_en, 
             caption = "Governance of marine other protected areas (when known)",
             type = "latex"),
      file = paste(tmp, "tbl_gov_knwn_en.tex", sep  ="/"))

ggsave(paste(tmp, "pie_gov_knwn_en.png", sep = "/"),
       plot =  pie_gov_knwn_en,
       device = "png",
       height = 6, width = 9)

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket =paste("projet-afd-eva-ap/descriptive_stats", save_dir, "nofocus/governance/marine", sep = "/"),
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

#### Number of PAs

```{r, eval = FALSE}
#Statistics

## PAs in the WDAP
n_all = nrow(data_pa_all)
n_focus = nrow(data_pa_focus)

## PAs in the WDAP, not marine
n_all_nomarine = data_pa_all %>%
  filter(marine %in% c(0,1)) %>%
  nrow()
n_focus_nomarine = data_pa_focus %>%
  filter(marine %in% c(0,1)) %>%
  nrow()

donnees_sum <- data_pa_all %>%
  group_by(focus) %>%
  summarise(
    n = n(),
    part_marine = sum(marine == 2) 
  )

# Créer le graphique en barres
ggplot(data_pa_all, aes(x = focus, fill = as.factor(marine)) )+
  geom_bar() +
  labs()


## PA we can analyze with our methodology
yr_min = 2002
n_all_ie = data_pa_all %>%
  filter(is.na(wdpaid) == F & status_yr >= yr_min & marine %in% c(0,1) & area_km2 > 1 ) %>%
  nrow()
n_focus_ie = data_pa_focus %>%
  filter(is.na(wdpaid) == F & status_yr >= yr_min & marine %in% c(0,1) & area_km2 > 1 ) %>%
  nrow()
```

#### Area of PAs : non-marine

PA of interest

```{r, eval = FALSE}

tbl_area_focus = data_pa_focus %>%
  filter(marine %in% c(0,1)) %>%
  summarize(n = n(),
            tot = format(sum(area_km2), big.mark = ",", digits = 1, scientific = FALSE),
            min = format(min(area_km2), big.mark = ",", digits = 1, scientific = FALSE),
            max = format(max(area_km2), big.mark = ",", digits = 1, scientific = FALSE),
            mean = format(mean(area_km2), big.mark = ",", digits = 1, scientific = FALSE)
            )
names(tbl_area_focus) = c("Number of PAs", "Total area (km²)", "Min. area (km²)", "Max. area (km²)", "Average area (km²)")
```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

print(xtable(tbl_area_focus, 
             caption = "Statistics on non-marine protected areas of interest",
             type = "latex"), 
      file = paste(tmp, "tbl_area_focus.tex", sep = "/"))

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = paste("projet-afd-eva-ap/descriptive_stats", save_dir, "focus/surface/no_marine", sep = "/"),
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory 

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))  
```

All PA

```{r, eval = FALSE}

tbl_area_all = data_pa_all %>%
  st_drop_geometry() %>%
  filter(marine %in% c(0,1)) %>%
  summarize(n = n(),
            tot = format(sum(rep_area), big.mark = ",", digits = 1, scientific = FALSE),
            min = format(min(rep_area), big.mark = ",", digits = 1, scientific = FALSE),
            max = format(max(rep_area), big.mark = ",", digits = 1, scientific = FALSE),
            mean = format(mean(rep_area), big.mark = ",", digits = 1, scientific = FALSE)
            )
names(tbl_area_all) = c("Number of PAs", "Total area (km²)", "Min. area (km²)", "Max. area (km²)", "Average area (km²)")
```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

print(xtable(tbl_area_all, 
             caption = "Statistics on non-marine protected areas",
             type = "latex"), 
      file = paste(tmp, "tbl_area_all.tex", sep = "/"))


#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = paste("projet-afd-eva-ap/descriptive_stats", save_dir, "all/surface/no_marine", sep = "/"),
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

Other PA

```{r, eval = FALSE}

tbl_area_nofocus = data_pa_nofocus %>%
  st_drop_geometry() %>%
  filter(marine %in% c(0,1)) %>%
  summarize(n = n(),
            tot = format(sum(rep_area), big.mark = ",", digits = 1, scientific = FALSE),
            min = format(min(rep_area), big.mark = ",", digits = 1, scientific = FALSE),
            max = format(max(rep_area), big.mark = ",", digits = 1, scientific = FALSE),
            mean = format(mean(rep_area), big.mark = ",", digits = 1, scientific = FALSE)
            )
names(tbl_area_nofocus) = c("Number of PAs", "Total area (km²)", "Min. area (km²)", "Max. area (km²)", "Average area (km²)")
```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

print(xtable(tbl_area_nofocus, 
             caption = "Statistics on non-marine other protected areas",
             type = "latex"), 
      file = paste(tmp, "tbl_area_nofocus.tex", sep = "/"))


#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = paste("projet-afd-eva-ap/descriptive_stats", save_dir, "nofocus/surface/no_marine", sep = "/"),
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

#### Area of PAs : marine

PA of interest

```{r, eval = FALSE}

tbl_area_focus = data_pa_focus %>%
  filter(marine == 2) %>%
  summarize(n = n(),
            tot = format(sum(area_km2), big.mark = ",", digits = 1, scientific = FALSE),
            min = format(min(area_km2), big.mark = ",", digits = 1, scientific = FALSE),
            max = format(max(area_km2), big.mark = ",", digits = 1, scientific = FALSE),
            mean = format(mean(area_km2), big.mark = ",", digits = 1, scientific = FALSE)
            )
names(tbl_area_focus) = c("Number of PAs", "Total area (km²)", "Min. area (km²)", "Max. area (km²)", "Average area (km²)")
```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

print(xtable(tbl_area_focus, 
             caption = "Statistics on marine protected areas of interest",
             type = "latex"), 
      file = paste(tmp, "tbl_area_focus.tex", sep = "/"))

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = paste("projet-afd-eva-ap/descriptive_stats", save_dir, "focus/surface/marine", sep = "/"), 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory 

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))  
```

All PA

```{r, eval = FALSE}

tbl_area_all = data_pa_all %>%
  st_drop_geometry() %>%
  filter(marine == 2) %>%
  summarize(n = n(),
            tot = format(sum(rep_area), big.mark = ",", digits = 1, scientific = FALSE),
            min = format(min(rep_area), big.mark = ",", digits = 1, scientific = FALSE),
            max = format(max(rep_area), big.mark = ",", digits = 1, scientific = FALSE),
            mean = format(mean(rep_area), big.mark = ",", digits = 1, scientific = FALSE)
            )
names(tbl_area_all) = c("Number of PAs", "Total area (km²)", "Min. area (km²)", "Max. area (km²)", "Average area (km²)")
```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

print(xtable(tbl_area_all, 
             caption = "Statistics on marine protected areas",
             type = "latex"), 
      file = paste(tmp, "tbl_area_all.tex", sep = "/"))


#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = paste("projet-afd-eva-ap/descriptive_stats", save_dir, "all/surface/marine", sep = "/"),
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

Other PA

```{r, eval = FALSE}

tbl_area_nofocus = data_pa_nofocus %>%
  st_drop_geometry() %>%
  filter(marine == 2) %>%
  summarize(n = n(),
            tot = format(sum(rep_area), big.mark = ",", digits = 1, scientific = FALSE),
            min = format(min(rep_area), big.mark = ",", digits = 1, scientific = FALSE),
            max = format(max(rep_area), big.mark = ",", digits = 1, scientific = FALSE),
            mean = format(mean(rep_area), big.mark = ",", digits = 1, scientific = FALSE)
            )
names(tbl_area_nofocus) = c("Number of PAs", "Total area (km²)", "Min. area (km²)", "Max. area (km²)", "Average area (km²)")
```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

print(xtable(tbl_area_nofocus, 
             caption = "Statistics on marine other protected areas",
             type = "latex"), 
      file = paste(tmp, "tbl_area_nofocus.tex", sep = "/"))


#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = paste("projet-afd-eva-ap/descriptive_stats", save_dir, "nofocus/surface/marine", sep = "/"),
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

## Evolution of tree cover and deforestation

Tests : access to GFW via its API

```{r, eval = F}
install.packages(c("httr2", "jsonlite"))
library(httr)
library(httr2)
library(jsonlite)

#Obtain a token

##The request to perform
# curl --location --request POST 'https://data-api.globalforestwatch.org/auth/token' \ --header 'Content-Type: application/x-www-form-urlencoded' \ --data-urlencode'username=duboisl@afd.fr' \ --data-urlencode 'password='

##With httr2
# req_sign = request('https://data-api.globalforestwatch.org/auth/sign-up') %>%
# req_headers("Content-Type" = "application/json") %>% 
# req_body_json(list(name = "Louise Dubois", email = "duboisl@afd.fr"))
# resp_sign = req_perform(req_sign)

req_token = request('https://data-api.globalforestwatch.org/auth/token') %>%
  req_headers("Content-Type" = "application/x-www-form-urlencoded") %>%
  req_body_form(list("username = duboisl@afd.fr", "password = "))
resp_token = req_perform(req_token)

##With httr
url_token = "https://data-api.globalforestwatch.org/auth/token"
#custom_headers = c("Content-Type" =  "application/x-www-form-urlencoded")
body_token = list(username = "duboisl@afd.fr", 
                  password = "")

resp_token = httr::POST(url_token, 
                  body = body_token,
                  encode = "form") 
token = fromJSON(rawToChar(resp_token$content))$data$access_token

#Check token is still valid
## With httr
url_token_valid = "https://api.resourcewatch.org/auth/user/me"
resp_token_valid = httr::GET(url_token_valid,
                             body = body_token,
                             encode = "form")

#Create an API key

##The request to perform
# curl --location --request POST 'https://data-api.globalforestwatch.org/auth/apikey' \ --header 'Authorization: Bearer ey2923…\ --header 'Content-Type: application/json' \ --data-raw '{ "alias": "api-key-for-new-app", "email": "gfw.guides@yahoo.com", "organization": "GFW", "domains": [] }'

##With httr
url_api = "https://data-api.globalforestwatch.org/auth/apikey"
body_api = list(alias = "api-key-ie-ap",
                email = "dduboisl@afd.fr",
                organization = "Agence Française de Développement")
resp_api = httr::POST(url_api,
                     add_headers("Authorization" = paste("Bearer", token, sep = " ")),
                     body = body_api,
                     encode = "json")
content(resp_api) #Error 500 Internal Server Error : try again ???

##With httr2
req_api = request('https://data-api.globalforestwatch.org/auth/apikey') %>%
  req_headers("Content-Type" = "application/json") %>%
  req_auth_bearer_token(token) %>%
  req_body_json(list("alias = api-key-ie-ap",
                     "email = duboisl@afd.fr", 
                     "organization = AFD",
                     "domains = []"))
resp_api = req_perform(req_api)
```

All PA

```{r, eval = F}
##2000 tree cover 
data_treecover_2000 = 
  aws.s3::s3read_using(
  FUN = data.table::fread,
  encoding = "UTF-8",
  # Mettre les options de FUN ici
  object = "data_tidy/GFW/MDG/treecover_extent_2000__ha.csv",
  bucket = "projet-afd-eva-ap",
  opts = list("region" = ""))

##Deforestation 2001-2022
data_treeloss = 
  aws.s3::s3read_using(
  FUN = data.table::fread,
  encoding = "UTF-8",
  # Mettre les options de FUN ici
  object = "data_tidy/GFW/MDG/treecover_loss__ha.csv",
  bucket = "projet-afd-eva-ap",
  opts = list("region" = ""))

data_plot_mdg = data_treeloss %>%
  left_join(data_treecover_2000, by = "iso") %>%
  rename("year" = "umd_tree_cover_loss__year",
         "loss_ha" = "umd_tree_cover_loss__ha",
         "emissions_Mg" = "gfw_gross_emissions_co2e_all_gases__Mg",
         "area_ha" = "area__ha",
         "treecover_2000_ha" = "umd_tree_cover_extent_2000__ha" 
         ) %>%
  arrange(year) %>%
  mutate(cum_loss = cumsum(loss_ha),
         treecover_ha_mdg = treecover_2000_ha - cum_loss,
         treecover_rel00_mdg = treecover_ha_mdg/treecover_2000_ha*100)

fig_treeloss_mdg = ggplot(data = data_plot_mdg,
                      aes(x = year, y = treecover_rel00_mdg)) %>%
  + geom_line(color = "#3182BD") %>%
  + geom_point(color = "#3182BD") %>%
  + labs(x = "", y = "% of 2000 tree cover", 
         title = "Evolution of forest cover in Madagascar",
         subtitle = paste("Treecover in 2000 :", format(data_plot_mdg$treecover_2000_ha[1], digits = 1, big.mark = ",", scientific = F), "ha"),
         caption = "Data : Global Forest Watch") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain', hjust = 0))
fig_treeloss_mdg
```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

ggsave(paste(tmp, "fig_treeloss_mdg.png", sep = "/"),
       plot =  fig_treeloss_mdg,
       device = "png",
       height = 6, width = 9)


#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/descriptive_stats/GFW/MDG/all", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

FAPBM funded protected areas.

```{r, eval = FALSE}
#Filter the WDPA to non-marine PAs in MDG funded by the FAPBM
wdpa_fapbm = data_wdpa %>%
  filter(iso3 == "MDG" & marine %in% c(0,1) & st_geometry_type(geom) == "MULTIPOLYGON" & wdpaid %in% unique(data_pa_fapbm$wdpaid)) %>%
  st_make_valid() %>%
  st_cast(to = "POLYGON") %>%
  mutate()

#Download the data with the MAPME package 
data.tree.fapbm = init_portfolio(wdpa_fapbm,
                     years = 2000:2022,
                     add_resources = FALSE) %>%
  get_resources(resources = c("gfw_treecover", "gfw_lossyear")) %>%
  calc_indicators(indicators = "treecover_area",
                  min_size=1, # indicator-specific argument
                  min_cover=10) %>%
  unnest(treecover_area) %>%
  drop_na(treecover) %>% #get rid of units with NA values 
  mutate(across(c("treecover"), \(x) round(x, 3))) %>% # Round numeric columns
  pivot_wider(names_from = "years", values_from = "treecover", names_prefix = "treecover_") %>%
  st_drop_geometry() %>%
  group_by(wdpaid) %>%
  summarize(across(.cols = starts_with("treecover"),
                   .fns = ~sum(.x, na.rm = TRUE))) %>%
  ungroup()

#Build a plotting dataset
data_plot_fapbm = data.tree.fapbm %>%
  st_drop_geometry() %>%
  group_by(wdpaid) %>%
  summarize(across(.cols = starts_with("treecover"),
                   .fns = ~sum(.x, na.rm = TRUE))) %>%
  ungroup() %>%
  mutate(across(.cols = starts_with("treecover"),
                   .fns = ~sum(.x, na.rm = TRUE))) %>%
  slice(1) %>%
  # mutate(across(.cols = starts_with("treecover"),
  #                .fns = ~.x/treecover_2000*100))  %>%
  pivot_longer(cols = c(starts_with("treecover")),
               names_to = c("var", "year"),
               names_sep = "_",
               values_to = "treecover_ha_fapbm") %>%
  mutate(treecover_rel00_fapbm = treecover_ha_fapbm/treecover_ha_fapbm[year == 2000]*100) %>%
  select(c(year, treecover_ha_fapbm, treecover_rel00_fapbm)) %>%
  mutate(year = as.numeric(year)) 
  

fig_treeloss_fapbm = ggplot(data = data_plot_fapbm,
                      aes(x = year, y = treecover_rel00_fapbm)) %>%
  + geom_line(color = "#3182BD") %>%
  + geom_point(color = "#3182BD") %>%
  + labs(x = "", y = "% of 2000 tree cover", 
         title = "Evolution of forest cover in FAPBM funded protected areas",
        subtitle = paste("Treecover in 2000 :", format(data_plot_fapbm[data_plot_fapbm$year == 2000,]$treecover_ha_fapbm, digits = 1, big.mark = ",", scientific = F), "ha"),
         caption = "Data : Global Forest Watch") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain', hjust = 0))
fig_treeloss_fapbm

# aws.s3::s3write_using(
# FUN = data.table::fwrite,
# data.tree.fapbm,
# # Mettre les options de FUN ici
# object = "data_tidy/GFW/MDG/FAPBM/data_treecover_2000_2022.csv",
# bucket = "projet-afd-eva-ap",
# opts = list("region" = ""))

```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

ggsave(paste(tmp, "fig_treeloss_fapbm.png", sep = "/"),
       plot =  fig_treeloss_fapbm,
       device = "png",
       height = 6, width = 9)


#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/descriptive_stats/GFW/MDG/FAPBM", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

Madagascar protected areas without FAPBM funded ones.

```{r, eval = FALSE}

wdpa_nofapbm = data_wdpa %>%
  filter(iso3 == "MDG" & marine %in% c(0,1) & st_geometry_type(geom) == "MULTIPOLYGON" & !(wdpaid %in% unique(data_pa_fapbm$wdpaid))) %>%
  st_make_valid() %>%
  st_cast(to = "POLYGON")

data.tree.nofapbm = init_portfolio(wdpa_nofapbm,
                     years = 2000:2022,
                     add_resources = FALSE) %>%
  get_resources(resources = c("gfw_treecover", "gfw_lossyear")) %>%
  calc_indicators(indicators = "treecover_area",
                  min_size=1, # indicator-specific argument
                  min_cover=10) %>%
  unnest(treecover_area) %>%
  drop_na(treecover) %>% #get rid of units with NA values 
  mutate(across(c("treecover"), \(x) round(x, 3))) %>% # Round numeric columns
  pivot_wider(names_from = "years", values_from = "treecover", names_prefix = "treecover_") %>%
  st_drop_geometry() %>%
  group_by(wdpaid) %>%
  summarize(across(.cols = starts_with("treecover"),
                   .fns = ~sum(.x, na.rm = TRUE))) %>%   
  ungroup()

aws.s3::s3write_using(
FUN = data.table::fwrite,
data.tree.nofapbm,
# Mettre les options de FUN ici
object = "data_tidy/GFW/MDG/noFAPBM/data_treecover_2000_2022.csv",
bucket = "projet-afd-eva-ap",
opts = list("region" = ""))

data_plot_nofapbm = data.tree.nofapbm %>%
  st_drop_geometry() %>%
  group_by(wdpaid) %>%
  summarize(across(.cols = starts_with("treecover"),
                   .fns = ~sum(.x, na.rm = TRUE))) %>%
  ungroup() %>%
  mutate(across(.cols = starts_with("treecover"),
                   .fns = ~sum(.x, na.rm = TRUE))) %>%
  slice(1) %>%
  # mutate(across(.cols = starts_with("treecover"),
  #                .fns = ~.x/treecover_2000*100))  %>%
  pivot_longer(cols = c(starts_with("treecover")),
               names_to = c("var", "year"),
               names_sep = "_",
               values_to = "treecover_ha_nofapbm") %>%
  mutate(treecover_rel00_nofapbm = treecover_ha_nofapbm/treecover_ha_nofapbm[year == 2000]*100) %>%
  select(c(year, treecover_ha_nofapbm, treecover_rel00_nofapbm)) %>%
  mutate(year = as.numeric(year)) 
  

fig_treeloss_nofapbm = ggplot(data = data_plot_nofapbm,
                      aes(x = year, y = treecover_rel00_nofapbm)) %>%
  + geom_line(color = "#3182BD") %>%
  + geom_point(color = "#3182BD") %>%
  + labs(x = "", y = "% of 2000 tree cover", 
         title = "Evolution of forest cover, in protected areas not FAPBM funded",
        subtitle = paste("Treecover in 2000 :", format(data_plot_nofapbm[data_plot_nofapbm$year == 2000,]$treecover_ha_nofapbm, digits = 1, big.mark = ",", scientific = F), "ha"),
         caption = "Data : Global Forest Watch") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain', hjust = 0))
fig_treeloss_nofapbm
```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

ggsave(paste(tmp, "fig_treeloss_nofapbm.png", sep = "/"),
       plot =  fig_treeloss_nofapbm,
       device = "png",
       height = 6, width = 9)


#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/descriptive_stats/GFW/MDG/noFAPBM", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

Plotting the evolution of forest cover in Madagascar, FAPBM funded and not FAPMB funded protected areas in the same figure.

```{r, eval = FALSE}
data_plot_all = data_plot_fapbm %>%
  left_join(data_plot_nofapbm, by = "year") %>%
  left_join(select(data_plot_mdg, c(year, treecover_ha_mdg, treecover_rel00_mdg)), by = "year") %>%
  mutate(treecover_rel00_mdg = case_when(is.na(treecover_rel00_mdg) == TRUE ~ 100,
                   TRUE ~ treecover_rel00_mdg),
         treecover_ha_mdg = case_when(is.na(treecover_ha_mdg) == TRUE ~ data_plot_mdg$treecover_2000_ha[1],
                   TRUE ~ treecover_ha_mdg))
#CARFEUL NEED TO RENAME VARIABLES   

fig_treeloss_all =  ggplot(data_plot_all,
                           aes(x = year)) %>%
  + geom_line(aes(y = treecover_rel00_mdg, color = "Madagascar")) %>%
  + geom_point(aes(y = treecover_rel00_mdg, color = "Madagascar")) %>%
  + geom_line(aes(y = treecover_rel00_nofapbm, color = "Not FAPBM")) %>%
  + geom_point(aes(y = treecover_rel00_nofapbm, color = "Not FAPBM")) %>%
  + geom_line(aes(y = treecover_rel00_fapbm, color = "FAPBM")) %>%
  + geom_point(aes(y = treecover_rel00_fapbm, color = "FAPBM")) %>%
  + scale_color_manual(name = "", values = c("Madagascar" = "grey50",
                                  "Not FAPBM" = "#DE2D26",
                                  "FAPBM" = "#31A354")) %>%
  + labs(x = "", y = "% of 2000 tree cover", 
         title = "Evolution of forest cover",
        caption = paste("Data : Global Forest Watch\nTreecover in 2000 :", format(data_plot_all[data_plot_all$year == 2000,]$treecover_ha_mdg, digits = 1, big.mark = ",", scientific = F), "ha in Madagascar,", format(data_plot_all[data_plot_all$year == 2000,]$treecover_ha_fapbm, digits = 1, big.mark = ",", scientific = F), "ha of FAPBM funded protected areas and", format(data_plot_all[data_plot_all$year == 2000,]$treecover_ha_nofapbm, digits = 1, big.mark = ",", scientific = F), "ha of non-funded.")) %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white',  
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain', hjust = 0))
fig_treeloss_all
```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

ggsave(paste(tmp, "fig_treeloss_all.png", sep = "/"),
       plot =  fig_treeloss_all,
       device = "png",
       height = 6, width = 9)


#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/descriptive_stats/GFW/MDG", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

## Forest cover by country

Import and clean the dataset

```{r, eval = F}
#Dataset of forest as a share of land for each country
data_fc = 
  #fread("data_tidy/BDD_PA_AFD_nofund_nodupl.csv" , encoding = "UTF-8")
  aws.s3::s3read_using(
  FUN = data.table::fread,
  encoding = "UTF-8",
  # Mettre les options de FUN ici
  object = "data_tidy/misc/treecover_extent_2010_ha_GFW.csv",
  bucket = "projet-afd-eva-ap",
  opts = list("region" = "")) %>%
  clean_names() %>%
  rename("iso3" = "iso",
         "fc_2010_ha" = "umd_tree_cover_extent_2010_ha",
         "area_land_ha" = "area_ha") %>%
  # pivot_wider(names_from = "year",
  #              values_from = "fc_per") %>%
  filter(iso3 != "") %>%
  mutate(region = countrycode(sourcevar = iso3,
                            origin = "iso3c",
                            destination = "un.region.name"),
       sub_region = countrycode(sourcevar = iso3,
                            origin = "iso3c",
                            destination = "un.regionsub.name"),
       country_en = countrycode(sourcevar = iso3,
                            origin = "iso3c",
                            destination = "un.name.en"),
       country_fr = countrycode(sourcevar = iso3,
                            origin = "iso3c",
                            destination = "un.name.fr"),
       .after = "iso3") %>%
  mutate(fc_2010_km2 = 0.01*fc_2010_ha,
         area_land_km2 = 0.01*area_land_ha,
         fc_2010_per = fc_2010_ha/area_land_ha*100)

#Non-marine PA funded by the AFD : # and total area by country
## Non-marine
data_pa_afd = data_stat_nodupl %>% 
  filter(marine %in% c(0,1)) %>%
  group_by(region, iso3, country_en) %>%
  summarize(n_afd = n(),
            area_afd_km2 = sum(area_km2)) %>%
  ungroup()
## Non-marine we can analyse
data_pa_afd_ie = data_stat_nodupl %>% 
  filter(marine %in% c(0,1) & area_km2 >= 1 & status_yr >= 2002 & status != "Proposed" & is.na(wdpaid) == FALSE) %>%
  group_by(region, iso3, country_en) %>%
  summarize(n_afd_ie = n(),
            area_afd_ie_km2 = sum(area_km2)) %>%
  ungroup()

#Non-marine PA reported in the WDPA worldwide: # and total area by country
## Non-marine
data_pa_wdpa = data_wdpa %>% 
  st_drop_geometry() %>%
  filter(marine %in% c(0,1)) %>%
  filter(grepl(";", iso3) == FALSE) %>%
  group_by(region, iso3, country_en) %>%
  summarize(n_wdpa = n(),
            area_wdpa_km2 = sum(rep_area)) %>%
  ungroup()
## Non-marine we can analyse
data_pa_wdpa_ie = data_wdpa %>% 
  st_drop_geometry() %>%
  filter(marine %in% c(0,1) & rep_area >= 1 & status_yr >= 2002 & status != "Proposed" & is.na(wdpaid) == FALSE) %>%
  filter(grepl(";", iso3) == FALSE) %>%
  group_by(region, iso3, country_en) %>%
  summarize(n_wdpa_ie = n(),
            area_wdpa_ie_km2 = sum(rep_area)) %>%
  ungroup()

data_fc_africa =  data_fc %>%
  filter(region == "Africa") %>%
  left_join(dplyr::select(data_pa_afd, c(iso3, n_afd, area_afd_km2)), by = "iso3") %>%
  left_join(dplyr::select(data_pa_wdpa, c(iso3, n_wdpa, area_wdpa_km2)), by = "iso3") %>%
    left_join(dplyr::select(data_pa_afd_ie, c(iso3, n_afd_ie, area_afd_ie_km2)), by = "iso3") %>%
  left_join(dplyr::select(data_pa_wdpa_ie, c(iso3, n_wdpa_ie, area_wdpa_ie_km2)), by = "iso3")
```

Perform plots

```{r, eval = F}
tbl_fc_africa = data_fc_africa %>%
  # filter(year %in% c(2000, 2010, 2020)) %>%
  dplyr::select(c(country_en, iso3, area_land_km2, n_wdpa, n_wdpa_ie, n_afd, n_afd_ie, area_wdpa_km2, area_wdpa_ie_km2, area_afd_km2, area_afd_ie_km2, fc_2010_per)) %>%
  mutate(country_en = case_when(iso3 == "MYT" ~ "Mayotte",
                             iso3 == "SHN" ~ "Saint Helena",
                             iso3 == "ESH" ~ "Western Sahara",
                             iso3 == "ATF" ~ "French Southern and Antarctic Lands",
                             iso3 == "REU" ~ "Reunion",
                             TRUE ~ country_en),
        per_pa_afd = case_when(is.na(area_afd_km2) == TRUE ~ "/",
                               is.na(area_afd_km2) == F ~ format(area_afd_km2/area_land_km2*100, digits = 1, big.mark = ",", scientific = F)),
         per_pa_wdpa = case_when(is.na(area_wdpa_km2) == TRUE ~ "/",
                                 is.na(area_wdpa_km2) == F ~ format(area_wdpa_km2/area_land_km2*100, digits = 1, big.mark = ",", scientific = F)),
        per_pa_afd_ie = case_when(is.na(area_afd_ie_km2) == TRUE ~ "/",
                               is.na(area_afd_ie_km2) == F ~ format(area_afd_ie_km2/area_land_km2*100, digits = 1, big.mark = ",", scientific = F)),
         per_pa_wdpa_ie = case_when(is.na(area_wdpa_ie_km2) == TRUE ~ "/",
                                 is.na(area_wdpa_ie_km2) == F ~ format(area_wdpa_ie_km2/area_land_km2*100, digits = 1, big.mark = ",", scientific = F)),
          included = case_when(fc_2010_per >= 5 & n_wdpa > 0 & area_wdpa_km2 > 0 ~ "Included",
                     fc_2010_per < 1 & (n_wdpa == 0 | area_wdpa_km2 == 0) ~ "Excluded",
                     fc_2010_per < 5 & n_wdpa > 0 & area_wdpa_km2 > 0 ~ "?"),
        area_land_km2 = format(area_land_km2, digit = 1, big.mark = ",", scientific = F),
         # area_afd_km2 = case_when(is.na(area_afd_km2) == TRUE ~ "/",
         #                          is.na(area_afd_km2) == F ~ format(area_afd_km2, digits = 1, big.mark = ",", scientific = F)),
         # area_wdpa_km2 = case_when(is.na(area_wdpa_km2) == TRUE ~ "/",
         #                          is.na(area_wdpa_km2) == F ~ format(area_wdpa_km2, digits = 1, big.mark = ",", scientific = F)),
         # area_afd_ie_km2 = case_when(is.na(area_afd_ie_km2) == TRUE ~ "/",
         #                          is.na(area_afd_ie_km2) == F ~ format(area_afd_ie_km2, digits = 1, big.mark = ",", scientific = F)),
         # area_wdpa_ie_km2 = case_when(is.na(area_wdpa_ie_km2) == TRUE ~ "/",
         #                          is.na(area_wdpa_ie_km2) == F ~ format(area_wdpa_ie_km2, digits = 1, big.mark = ",", scientific = F)),
         n_afd = as.character(n_afd),
         n_wdpa = as.character(n_wdpa),
         n_afd_ie = as.character(n_afd_ie),
         n_wdpa_ie = as.character(n_wdpa_ie),
         fc_2010_per = as.character(round(fc_2010_per, 1))
                             ) %>%
  replace_na(replace = list("n_afd" = "/",
                            "n_wdpa" = "/",
                            "n_afd_ie" = "/",
                            "n_wdpa_ie" = "/",
                            # "area_afd_km2" = "/",
                            # "area_wdpa_km2" = "/",
                            "included" = "Excluded",
                            "fc_2010_per" = "/")) %>%
  # group_by(iso3) %>%
  # pivot_wider(names_from = "year",
  #              values_from = "fc_per",
  #             names_prefix = "FC (%) in ") %>%
  # ungroup() %>%
  select(c(country_en, iso3, area_land_km2, n_wdpa, n_wdpa_ie, n_afd, n_afd_ie, per_pa_wdpa, per_pa_wdpa_ie, per_pa_afd, per_pa_afd_ie, fc_2010_per, included)) %>%
  rename("AFD (#)" = "n_afd",
         "AFD (#, IE)" = "n_afd_ie",
         "Total #" = "n_wdpa",
         "Total # (IE)" = "n_wdpa_ie",
         "AFD (%)" = "per_pa_afd",
         "AFD (%, IE)" = "per_pa_afd_ie",
         "Total (%)" = "per_pa_wdpa",
         "Total (%, IE)" = "per_pa_wdpa_ie",
         # "AFD (km²)" = "area_afd_km2",
         # "AFD (km², IE)" = "area_afd_ie_km2",
         # "Total (km²)" = "area_wdpa_km2",
         # "Total (km², IE)" = "area_wdpa_ie_km2",
         "Land area (km²)" = "area_land_km2",
         "Code" = "iso3",
         "Country" = "country_en",
         "Forest cover in 2010 (%)" = "fc_2010_per",
         "Analysis" = "included"
         ) %>%
  arrange(-as.numeric(`Forest cover in 2010 (%)`))
  # replace_na(replace = list("FC in 2010 (%)" = "/",
  #                           "FC (%) in 2020" = "/")) 

a = ggplot(tbl_fc_africa, aes(x = Code, y = `Total #`)) %>%
  + geom_line()
```

Save

```{r, eval = F}
tmp = paste(tempdir(), "fig", sep = "/")

  ggsave(paste(tmp, "a.png", sep = "/"),
         plot = a,
         device = "png",
         height = 8, width = 12)

print(xtable(tbl_fc_africa, 
             type = "latex", 
             auto = T,
             caption = "Data source: Global Forest Watch. Protected areas (PA) considered are reported in the WDPA and terrestrial or coastal. IE : restriction to PA we can analysis ($>1km^2$, created after 2002, without 'proposed' status). Analysis : included if forest cover (FC) above 5% and at least one PA and total area non-null; excluded if forest cover below 1% and no PA reported/null total area reported; unknown (?) if forest cover below 5% and at least one PA reported/non-zero total area."),
      include.rownames=FALSE,
      file = paste(tmp, "tbl_fc_africa.tex", sep = "/"))

files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
for(f in files) 
{
  cat("Uploading file", paste0("'", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                    bucket = "projet-afd-eva-ap/descriptive_stats/misc/forest_cover",
                     region = "", show_progress = TRUE)
}
do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

## Mapping of sample

```{r, eval = F}

#Loading directory
load_dir = paste("impact_analysis/did", "2023-10-23", sep = "/")
save_dir = paste("descriptive_stats/misc/map_att_2023-10-23")

#Import datasets
## The sample
data_pa =
  aws.s3::s3read_using(
  FUN = data.table::fread,
  encoding = "UTF-8",
  object = "data_tidy/BDD_PA_africa.csv",
  bucket = "projet-afd-eva-ap",
  opts = list("region" = ""))

data_pa_ie_focus = data_pa %>%
  filter(region == "Africa" & is.na(wdpaid) == FALSE & area_km2 >=1 & marine %in% c(0,1) & status_yr >= yr_min & focus == T)
list_iso = unique(data_pa_ie_focus$iso3)

data_pa_sample = data_pa %>%
  filter(iso3 %in% list_iso) %>%
  dplyr::select(c(wdpaid, wdpa_pid, iso3, name, focus, status_yr, status, iucn_cat, marine, gov_type, year_funding_first, year_funding_all)) %>%
  rename("treatment_year" = "status_yr")

## WDPA 
wdpa_wld_raw = s3read_using(
              sf::st_read,
              object = "data_raw/wdpa/wdpa_shp_global_raw.gpkg",
              bucket = "projet-afd-eva-ap",
              opts = list("region" = ""))
wdpa_poly = wdpa_wld_raw %>%
  st_as_sf() %>%
  dplyr::select(c(WDPA_PID, geom)) %>%
  mutate(type_geom = st_geometry_type(geom))

#Create a dataset with all PA
sf_pa_sample = data_pa_sample %>%
  left_join(wdpa_poly, by = c("wdpa_pid" = "WDPA_PID"))

#Save it
aws.s3::s3write_using(
FUN = sf::st_write,
sf_pa_sample,
object = paste(save_dir, "sf_pa_sample.gpkg", sep = "/"), 
bucket = "projet-afd-eva-ap",
opts = list("region" = ""))
```

## Mapping of results

```{r, eval = F}

#Loading directory
load_dir = paste("impact_analysis/did", "2023-10-23", sep = "/")
save_dir = paste("descriptive_stats/misc/map_att_2023-10-23")

#Import datasets
## The sample
data_pa =
  aws.s3::s3read_using(
  FUN = data.table::fread,
  encoding = "UTF-8",
  object = "data_tidy/BDD_PA_africa.csv",
  bucket = "projet-afd-eva-ap",
  opts = list("region" = ""))

data_pa2 = data_pa %>%
  dplyr::select(c(wdpaid, wdpa_pid, iso3, name, status_yr, status, iucn_cat, marine, gov_type, year_funding_first, year_funding_all)) %>%
  rename("treatment_year" = "status_yr")

## WDPA 
wdpa_wld_raw = s3read_using(
              sf::st_read,
              object = "data_raw/wdpa/wdpa_shp_global_raw.gpkg",
              bucket = "projet-afd-eva-ap",
              opts = list("region" = ""))
wdpa_poly = wdpa_wld_raw %>%
  st_as_sf() %>%
  dplyr::select(c(WDPA_PID, geom))

## Treatment effects computed from the sample
### After non-academic filtering (cf DiD)
df_fc_att_tidy_noaca = aws.s3::s3read_using(
FUN = data.table::fread,
object = paste(load_dir, "df_fc_att_tidy_noaca.csv", sep = "/"),
bucket = "projet-afd-eva-ap",
opts = list("region" = ""))

### For PA out of focus
df_fc_att_tidy_noaca_nofocus = df_fc_att_tidy_noaca %>%
  filter(focus == F & time %in% c(5,10)) %>%
  dplyr::select(c(wdpaid, time, att_per, sig)) %>%
  pivot_wider(names_from = "time",
              values_from = c("att_per", "sig"))
### For PA of interest
df_fc_att_tidy_noaca_focus = df_fc_att_tidy_noaca %>%
  filter(focus == T & time %in% c(5,10)) %>%
  dplyr::select(c(wdpaid, time, att_per, sig)) %>%
  pivot_wider(names_from = "time",
              values_from = c("att_per", "sig"))

### For PA of interest
df_fc_att_tidy_noaca_all = df_fc_att_tidy_noaca %>%
  filter(time %in% c(5,10)) %>%
  dplyr::select(c(wdpaid, time, att_per, sig, focus)) %>%
  pivot_wider(names_from = "time",
              values_from = c("att_per", "sig"))

## Treatment effects computed for Geo4Impact presentation, performed 2023-08-29
### The more recent version of the code are not compatible with the computation of the TE on this folder. Then, I create manually a dataset with computed treatment effects
df_fc_att_geo4impact = data.frame(wdpaid = c(1240, 555547995, 15089, 9035, 555705345, 72324, 303873, 903025, 903026, 903129, 317051, 342655, 478033, 555651504, 902838),
                                  att_per_5 = c(0.140, -0.325, 0.151, -0.085,  -0.318, 0.017, 0.005,  0.621,  0.331, -0.191, -2.988,  0.162,  0.407, -2.392,  1.071),
                                  sig_5 = c(TRUE, FALSE, FALSE, FALSE, FALSE, TRUE, FALSE, FALSE, TRUE, TRUE, TRUE, FALSE, TRUE, FALSE, FALSE),
                                  att_per_10 = c(0.443,  -0.891, 0.259, -0.132, -1.478,  0.009, 0.017, 1.618, 1.084, -0.082, NA, -0.130, 1.620, NA, 2.123),
                                  sig_10 = c(TRUE, FALSE, FALSE, FALSE, TRUE, FALSE, FALSE, FALSE, TRUE, FALSE, NA, FALSE, TRUE, NA, TRUE ))

#Create a dataset to map results
df_map_fc_att_tidy_noaca_geo4impact = df_fc_att_geo4impact %>%
  left_join(data_pa2, by = "wdpaid") %>% 
  left_join(wdpa_poly, by = c("wdpa_pid" = "WDPA_PID"))
  
df_map_fc_att_tidy_noaca_nofocus = df_fc_att_tidy_noaca_nofocus %>%
  left_join(data_pa2, by = "wdpaid") %>% 
  left_join(wdpa_poly, by = c("wdpa_pid" = "WDPA_PID"))

df_map_fc_att_tidy_noaca_focus = df_fc_att_tidy_noaca_focus %>%
  left_join(data_pa2, by = "wdpaid") %>% 
  left_join(wdpa_poly, by = c("wdpa_pid" = "WDPA_PID"))

df_map_fc_att_tidy_noaca_all = df_fc_att_tidy_noaca_all %>%
  left_join(data_pa2, by = "wdpaid") %>% 
  left_join(wdpa_poly, by = c("wdpa_pid" = "WDPA_PID"))

#Save datasets
## GEo4Impact
aws.s3::s3write_using(
FUN = sf::st_write,
df_map_fc_att_tidy_noaca_geo4impact,
object = paste(save_dir, "df_map_fc_att_tidy_noaca_geo4impact.gpkg", sep = "/"), 
bucket = "projet-afd-eva-ap",
opts = list("region" = ""))
## Non-focus PA
aws.s3::s3write_using(
FUN = sf::st_write,
df_map_fc_att_tidy_noaca_nofocus,
object = paste(save_dir, "df_map_fc_att_tidy_noaca_nofocus.gpkg", sep = "/"), 
bucket = "projet-afd-eva-ap",
opts = list("region" = ""))
## PA of interest
aws.s3::s3write_using(
FUN = sf::st_write,
df_map_fc_att_tidy_noaca_focus,
object = paste(save_dir, "df_map_fc_att_tidy_noaca_focus.gpkg", sep = "/"), 
bucket = "projet-afd-eva-ap",
opts = list("region" = ""))
## All PA
aws.s3::s3write_using(
FUN = sf::st_write,
df_map_fc_att_tidy_noaca_all,
object = paste(save_dir, "df_map_fc_att_tidy_noaca_all.gpkg", sep = "/"), 
bucket = "projet-afd-eva-ap",
opts = list("region" = ""))

#The maps can be drawn using the tmap library or directly on QGIS !
```

## Evolution of forest cover for specific polygons

Using the mapme.biodiversity R package, one can plot the evolution of forest cover for any polygon using Global Forest Watch data (Hansen et al. 2013).

```{r, eval = F}

#Import the polygon(s) of interest
terr_tidy =
  #st_read("data_raw/wdpa/wdpa_shp_global_raw.gpkg") %>%
  s3read_using(sf::st_read,
              object = "data_tidy/TerrIndigena/TE_TerrIndigena1y2_20230208_Pg_tidy.gpkg",
              bucket = "projet-afd-eva-ap",
              opts = list("region" = ""))

# Version of Global Forest Cover data to consider
list_version_gfc = mapme.biodiversity:::.available_gfw_versions() #all versions available
version_gfc = list_version_gfc[length(list_version_gfc)] #last version considered

#Download forest cover data : initialize a portfolio, get data and compute forest cover
dl.fc = terr_tidy %>%
  get_resources(get_gfw_treecover(version =  version_gfc),
    get_gfw_lossyear(version = version_gfc),
    get_gfw_emissions()
  ) %>% calc_indicators(calc_treecover_area(years=2000:2021,
                  min_size=0.5, # FAO definition of forest :  Minimum treecover = 10%, minimum size =0.5 hectare (FAO 2020 Global Forest Resources Assessment, https://www.fao.org/3/I8661EN/i8661en.pdf)
                  min_cover=10))

    
  


#Create a dataset with evolution of forest cover
data.fc = dl.fc %>%
  st_drop_geometry() %>%
  unnest(treecover_area) %>%
  group_by(ID_raw) %>%
  mutate(treecover_base2000 = (treecover - treecover[years == 2000])/treecover[years == 2000],
         treecover_ini = treecover[years == 2000]) %>%
  ungroup() 

#Save the dataset
aws.s3::s3write_using(
FUN = data.table::fwrite,
data.fc,
object = "descriptive_stats/misc/TerrIndigena/df_fc_terrindigena.csv", 
bucket = "projet-afd-eva-ap",
opts = list("region" = ""))


  
#Figures
## Evolution of relative forest cover for all polygons
fig_fc_all = ggplot(data = data.fc %>% arrange(country_en, ID_raw),
                aes(x = years, y = treecover_base2000*100, color = ID_raw)) %>%
  + geom_point() %>%
  + geom_line() %>%
  + labs(title = "Country-wise evolution of forest cover for the TerrIndigena project areas",
         x = "Year", 
         y = "Evolution of forest cover relative to 2000 (%)",
         caption = "Interpretation : a value of -0.10 in 2015 represents a loss of 10% of 2000 forest cover") %>%
  + scale_color_discrete(name = "Project ID",
                         breaks = c("1_Bra", "2_Bra", "3_Bra", "4_Bra", "1_Col", "2_Col", "3_Col", "1_Ecu", "2_Ecu", "3_Ecu", "1_Per", "2_Per")) %>%
  + facet_wrap(~country_en) %>%
  + theme_minimal() %>%
  + theme(plot.caption = element_text(hjust = 0))

  ggsave(paste0(tempdir(), "/terrindigena/fig_terrindigena_fc_all.png"),
         plot = fig_fc_all,
         device = "png",
         height = 8, width = 12)
  files <- list.files(paste0(tempdir(), "/terrindigena"), full.names = TRUE)
  ##Add each file in the bucket (same foler for every file in the temp)
  for (f in files) 
  {
    cat("Uploading file", paste0("'", f, "'"), "\n")
    aws.s3::put_object(file = f, 
                       bucket = "projet-afd-eva-ap/descriptive_stats/misc/TerrIndigena",
                       region = "", show_progress = TRUE)
  }
  do.call(file.remove, list(list.files(paste0(tempdir(), "/terrindigena"), full.names = TRUE)))

##Evolution by country
for (i in unique(data.fc$country_en)) 
{
  fig_fc_i = ggplot(data = filter(data.fc, country_en == i),
                aes(x = years, y = treecover_base2000*100, color = ID_raw)) %>%
  + geom_point() %>%
  + geom_line() %>%
  + scale_color_brewer(name = "Project ID", palette = "Blues") %>%
  + labs(title = "Evolution of forest cover for the TerrIndigena project areas",
         subtitle = paste("Country :", i),
         x = "Year", 
         y = "Evolution of forest cover relative to 2000 (%)",
         caption = "Interpretation : a value of -0.10 in 2015 represents a loss of 10% of 2000 forest cover") %>%
  + theme_minimal() %>%
  + theme(plot.caption = element_text(hjust = 0))
  fig_fc_i
  ggsave(paste0(tempdir(), "/terrindigena/fig_terrindigena_fc_", i, ".png"),
         plot = fig_fc_i,
         device = "png",
         height = 6, width = 9)
  files <- list.files(paste0(tempdir(), "/terrindigena"), full.names = TRUE)
  ##Add each file in the bucket (same foler for every file in the temp)
  for(f in files) 
  {
    cat("Uploading file", paste0("'", f, "'"), "\n")
    aws.s3::put_object(file = f, 
                       bucket = "projet-afd-eva-ap/descriptive_stats/misc/TerrIndigena",
                       region = "", show_progress = TRUE)
  }
  do.call(file.remove, list(list.files(paste0(tempdir(), "/terrindigena"), full.names = TRUE)))
}

##Evolution for each polygon
for (i in unique(data.fc$ID_raw)) 
{
  # fig_fc_rel_i = ggplot(data = filter(data.fc, ID_raw == i),
  #               aes(x = years, y = treecover_base2000*100, color = ID_raw)) %>%
  # + geom_point(color = "#006D2C") %>%
  # + geom_line(color = "#006D2C") %>%
  # + labs(title = "Evolution of forest cover for the TerrIndigena project areas",
  #        subtitle = paste("Project ID :", i),
  #        x = "Year", 
  #        y = "Evolution of forest cover relative to 2000 (%)",
  #        caption = "Interpretation : a value of -0.10 in 2015 represents a loss of 10% of 2000 forest cover") %>%
  # + theme_minimal() %>%
  # + theme(plot.caption = element_text(hjust = 0))
  # 
  fig_fc_ha_i = ggplot(data = filter(data.fc, ID_raw == i),
                aes(x = years, y = treecover, color = ID_raw)) %>%
  + geom_point(color = "#006D2C") %>%
  + geom_line(color = "#006D2C") %>%
  + labs(title = "Evolution of forest cover for the TerrIndigena project areas",
         subtitle = paste("Project ID :", i),
         x = "Year",
         y = "Evolution of forest cover (ha)",) %>%
  + theme_minimal() %>%
  + theme(plot.caption = element_text(hjust = 0))

  # ggsave(paste0(tempdir(), "/terrindigena/fig_terrindigena_fc_rel_", i, ".png"),
  #        plot = fig_fc_rel_i,
  #        device = "png",
  #        height = 8, width = 12)
  ggsave(paste0(tempdir(), "/terrindigena/fig_terrindigena_fc_ha_", i, ".png"),
         plot = fig_fc_ha_i,
         device = "png",
         height = 6, width = 9)
  files <- list.files(paste0(tempdir(), "/terrindigena"), full.names = TRUE)
  ##Add each file in the bucket (same foler for every file in the temp)
  for(f in files) 
  {
    cat("Uploading file", paste0("'", f, "'"), "\n")
    aws.s3::put_object(file = f, 
                       bucket = "projet-afd-eva-ap/descriptive_stats/misc/TerrIndigena",
                       region = "", show_progress = TRUE)
  }
  do.call(file.remove, list(list.files(paste0(tempdir(), "/terrindigena"), full.names = TRUE)))
}
```








```{r, eval = F}

#Import the polygon(s) of interest
terr_tidy =
  #st_read("data_raw/wdpa/wdpa_shp_global_raw.gpkg") %>%
  s3read_using(sf::st_read,
              object = "data_tidy/TerrIndigena/TE_TerrIndigena1y2_20230208_Pg_tidy.gpkg",
              bucket = "projet-afd-eva-ap",
              opts = list("region" = ""))

# Version of Global Forest Cover data to consider
list_version_gfc = mapme.biodiversity:::.available_gfw_versions() #all versions available
version_gfc = list_version_gfc[length(list_version_gfc)] #last version considered

#Download forest cover data : initialize a portfolio, get data and compute forest cover
dl.fc = init_portfolio(terr_tidy,
                       years = 2000:2021,
                       add_resources = FALSE) %>%
  get_resources(resources = c("gfw_treecover", "gfw_lossyear"),
                vers_treecover = version_gfc,
                vers_lossyear = version_gfc) %>%
  calc_indicators(indicators = "treecover_area",
                  min_size=0.5, # FAO definition of forest :  Minimum treecover = 10%, minimum size =0.5 hectare (FAO 2020 Global Forest Resources Assessment, https://www.fao.org/3/I8661EN/i8661en.pdf)
                  min_cover=10)

#Create a dataset with evolution of forest cover
data.fc = dl.fc %>%
  st_drop_geometry() %>%
  unnest(treecover_area) %>%
  group_by(ID_raw) %>%
  mutate(treecover_base2000 = (treecover - treecover[years == 2000])/treecover[years == 2000],
         treecover_ini = treecover[years == 2000]) %>%
  ungroup() 

#Save the dataset
aws.s3::s3write_using(
FUN = data.table::fwrite,
data.fc,
object = "descriptive_stats/misc/TerrIndigena/df_fc_terrindigena.csv", 
bucket = "projet-afd-eva-ap",
opts = list("region" = ""))


  
#Figures
## Evolution of relative forest cover for all polygons
fig_fc_all = ggplot(data = data.fc %>% arrange(country_en, ID_raw),
                aes(x = years, y = treecover_base2000*100, color = ID_raw)) %>%
  + geom_point() %>%
  + geom_line() %>%
  + labs(title = "Country-wise evolution of forest cover for the TerrIndigena project areas",
         x = "Year", 
         y = "Evolution of forest cover relative to 2000 (%)",
         caption = "Interpretation : a value of -0.10 in 2015 represents a loss of 10% of 2000 forest cover") %>%
  + scale_color_discrete(name = "Project ID",
                         breaks = c("1_Bra", "2_Bra", "3_Bra", "4_Bra", "1_Col", "2_Col", "3_Col", "1_Ecu", "2_Ecu", "3_Ecu", "1_Per", "2_Per")) %>%
  + facet_wrap(~country_en) %>%
  + theme_minimal() %>%
  + theme(plot.caption = element_text(hjust = 0))

  ggsave(paste0(tempdir(), "/terrindigena/fig_terrindigena_fc_all.png"),
         plot = fig_fc_all,
         device = "png",
         height = 8, width = 12)
  files <- list.files(paste0(tempdir(), "/terrindigena"), full.names = TRUE)
  ##Add each file in the bucket (same foler for every file in the temp)
  for (f in files) 
  {
    cat("Uploading file", paste0("'", f, "'"), "\n")
    aws.s3::put_object(file = f, 
                       bucket = "projet-afd-eva-ap/descriptive_stats/misc/TerrIndigena",
                       region = "", show_progress = TRUE)
  }
  do.call(file.remove, list(list.files(paste0(tempdir(), "/terrindigena"), full.names = TRUE)))

##Evolution by country
for (i in unique(data.fc$country_en)) 
{
  fig_fc_i = ggplot(data = filter(data.fc, country_en == i),
                aes(x = years, y = treecover_base2000*100, color = ID_raw)) %>%
  + geom_point() %>%
  + geom_line() %>%
  + scale_color_brewer(name = "Project ID", palette = "Blues") %>%
  + labs(title = "Evolution of forest cover for the TerrIndigena project areas",
         subtitle = paste("Country :", i),
         x = "Year", 
         y = "Evolution of forest cover relative to 2000 (%)",
         caption = "Interpretation : a value of -0.10 in 2015 represents a loss of 10% of 2000 forest cover") %>%
  + theme_minimal() %>%
  + theme(plot.caption = element_text(hjust = 0))
  fig_fc_i
  ggsave(paste0(tempdir(), "/terrindigena/fig_terrindigena_fc_", i, ".png"),
         plot = fig_fc_i,
         device = "png",
         height = 6, width = 9)
  files <- list.files(paste0(tempdir(), "/terrindigena"), full.names = TRUE)
  ##Add each file in the bucket (same foler for every file in the temp)
  for(f in files) 
  {
    cat("Uploading file", paste0("'", f, "'"), "\n")
    aws.s3::put_object(file = f, 
                       bucket = "projet-afd-eva-ap/descriptive_stats/misc/TerrIndigena",
                       region = "", show_progress = TRUE)
  }
  do.call(file.remove, list(list.files(paste0(tempdir(), "/terrindigena"), full.names = TRUE)))
}

##Evolution for each polygon
for (i in unique(data.fc$ID_raw)) 
{
  # fig_fc_rel_i = ggplot(data = filter(data.fc, ID_raw == i),
  #               aes(x = years, y = treecover_base2000*100, color = ID_raw)) %>%
  # + geom_point(color = "#006D2C") %>%
  # + geom_line(color = "#006D2C") %>%
  # + labs(title = "Evolution of forest cover for the TerrIndigena project areas",
  #        subtitle = paste("Project ID :", i),
  #        x = "Year", 
  #        y = "Evolution of forest cover relative to 2000 (%)",
  #        caption = "Interpretation : a value of -0.10 in 2015 represents a loss of 10% of 2000 forest cover") %>%
  # + theme_minimal() %>%
  # + theme(plot.caption = element_text(hjust = 0))
  # 
  fig_fc_ha_i = ggplot(data = filter(data.fc, ID_raw == i),
                aes(x = years, y = treecover, color = ID_raw)) %>%
  + geom_point(color = "#006D2C") %>%
  + geom_line(color = "#006D2C") %>%
  + labs(title = "Evolution of forest cover for the TerrIndigena project areas",
         subtitle = paste("Project ID :", i),
         x = "Year",
         y = "Evolution of forest cover (ha)",) %>%
  + theme_minimal() %>%
  + theme(plot.caption = element_text(hjust = 0))

  # ggsave(paste0(tempdir(), "/terrindigena/fig_terrindigena_fc_rel_", i, ".png"),
  #        plot = fig_fc_rel_i,
  #        device = "png",
  #        height = 8, width = 12)
  ggsave(paste0(tempdir(), "/terrindigena/fig_terrindigena_fc_ha_", i, ".png"),
         plot = fig_fc_ha_i,
         device = "png",
         height = 6, width = 9)
  files <- list.files(paste0(tempdir(), "/terrindigena"), full.names = TRUE)
  ##Add each file in the bucket (same foler for every file in the temp)
  for(f in files) 
  {
    cat("Uploading file", paste0("'", f, "'"), "\n")
    aws.s3::put_object(file = f, 
                       bucket = "projet-afd-eva-ap/descriptive_stats/misc/TerrIndigena",
                       region = "", show_progress = TRUE)
  }
  do.call(file.remove, list(list.files(paste0(tempdir(), "/terrindigena"), full.names = TRUE)))
}
```
